# –ú–∏–≥—Ä–∞—Ü–∏—è —Å Firebase –Ω–∞ Backend API (https://titotr.ru)

## üéØ –¶–µ–ª—å
–ü–µ—Ä–µ—Ö–æ–¥ –æ—Ç Firebase –∫ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–º—É backend API –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∑–∞–∫–∞–∑–æ–≤ –º–µ–∂–¥—É –∫–ª–∏–µ–Ω—Ç–∞–º–∏ –∏ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞–º–∏.

## ‚ùå –ü—Ä–æ–±–ª–µ–º–∞
–ü–æ—Å–ª–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ:

1. **–î–∏—Å–ø–µ—Ç—á–µ—Ä –Ω–µ –≤–∏–¥–∏—Ç –∑–∞–∫–∞–∑—ã –∫–ª–∏–µ–Ω—Ç–æ–≤** - "–≤ –∫–∞–±–∏–Ω–µ—Ç–µ –¥–∏—Å–ø–µ—á–µ—Ä–∞ —É –º–µ–Ω—è –Ω–µ—Ç—É –∑–∞–∫–∞–∑–∞"
2. **–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞—Ä—ã–π –∫–æ–¥**:
   - –õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç: `üì§ [SYNC] –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–∫–∞–∑–∞ ... –≤ Firebase...`
   - –ù–µ—Ç HTTP –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ https://titotr.ru
3. **Firebase –≤—Å—ë –µ—â—ë –∞–∫—Ç–∏–≤–µ–Ω**:
   - `FirebaseOrdersService` –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ Firebase
   - `OrdersSyncService` —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç SQLite ‚Üí Firebase
   - –î–∏—Å–ø–µ—Ç—á–µ—Ä —á–∏—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω—ã–µ –∑–∞–∫–∞–∑—ã –∏–∑ SharedPreferences

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### 1. –û–±–Ω–æ–≤–ª—ë–Ω `BookingService.getActiveBookings()`
**–§–∞–π–ª**: `lib/services/booking_service.dart`

**–ë—ã–ª–æ**:
```dart
Future<List<Booking>> getActiveBookings() async {
  debugPrint('‚ÑπÔ∏è –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –ª–æ–∫–∞–ª—å–Ω–æ (Firebase –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω)');
  return _getOfflineActiveBookings(); // –ß–∏—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
}
```

**–°—Ç–∞–ª–æ**:
```dart
Future<List<Booking>> getActiveBookings() async {
  debugPrint('üîç –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π —Å backend API...');
  
  try {
    // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∑–∞–∫–∞–∑—ã —Å —Å–µ—Ä–≤–µ—Ä–∞
    final response = await _ordersApi.getOrders();
    
    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º ApiOrder ‚Üí Booking –∏ —Ñ–∏–ª—å—Ç—Ä—É–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ
    final bookings = <Booking>[];
    for (final apiOrder in response.orders) {
      if (apiOrder.status == OrderStatus.pending ||
          apiOrder.status == OrderStatus.confirmed ||
          apiOrder.status == OrderStatus.inProgress) {
        bookings.add(_convertApiOrderToBooking(apiOrder));
      }
    }
    
    return bookings;
  } catch (e) {
    // Fallback –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
    return _getOfflineActiveBookings();
  }
}
```

**–î–æ–±–∞–≤–ª–µ–Ω—ã –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã**:
- `_convertApiOrderToBooking()` - –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è ApiOrder ‚Üí Booking
- `_convertApiStatusToBookingStatus()` - –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤
- `_parsePassengers()` - –ø–∞—Ä—Å–∏–Ω–≥ –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤ –∏–∑ JSON
- `_parseBaggage()` - –ø–∞—Ä—Å–∏–Ω–≥ –±–∞–≥–∞–∂–∞ –∏–∑ JSON
- `_parsePets()` - –ø–∞—Ä—Å–∏–Ω–≥ –∂–∏–≤–æ—Ç–Ω—ã—Ö –∏–∑ JSON

### 2. –û—Ç–∫–ª—é—á–µ–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Firebase
**–§–∞–π–ª**: `lib/services/orders_sync_service.dart`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è**:
- –£–¥–∞–ª—ë–Ω –∏–º–ø–æ—Ä—Ç `firebase_orders_service.dart`
- –î–æ–±–∞–≤–ª–µ–Ω –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ –≤—Ä–µ–º–µ–Ω–Ω–æ–º –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏
- –ú–µ—Ç–æ–¥ `_syncOrders()` —Ç–µ–ø–µ—Ä—å –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ—Ç - –≤—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤ `BookingService.createBooking()`

**–ü–æ—á–µ–º—É –æ—Ç–∫–ª—é—á–µ–Ω–æ**:
`BookingService.createBooking()` —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–∫–∞–∑—ã –Ω–∞–ø—Ä—è–º—É—é –Ω–∞ backend API —á–µ—Ä–µ–∑ `_ordersApi.createOrder()`, –ø–æ—ç—Ç–æ–º—É –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–µ –Ω—É–∂–Ω–∞.

## üìã –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ü–û–°–õ–ï –∏–∑–º–µ–Ω–µ–Ω–∏–π

### –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ (–ö–ª–∏–µ–Ω—Ç):
```
1. –ö–ª–∏–µ–Ω—Ç —Å–æ–∑–¥–∞—ë—Ç –∑–∞–∫–∞–∑ ‚Üí BookingService.createBooking()
2. BookingService –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç POST https://titotr.ru/api/orders
3. –ï—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π SharedPreferences —Å server ID
4. –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å "offline_" –ø—Ä–µ—Ñ–∏–∫—Å–æ–º –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
```

### –ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–∫–∞–∑–æ–≤ (–î–∏—Å–ø–µ—Ç—á–µ—Ä):
```
1. –î–∏—Å–ø–µ—Ç—á–µ—Ä –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –ø–∞–Ω–µ–ª—å ‚Üí DispatcherHomeScreen._loadData()
2. BookingService.getActiveBookings()
3. GET https://titotr.ru/api/orders
4. –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è ApiOrder ‚Üí Booking
5. –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∑–∞–∫–∞–∑–æ–≤
```

## üîß –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ

### –°–†–û–ß–ù–û ‚ö†Ô∏è
**–ü–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö!**

–ù–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞–ø—É—â–µ–Ω–∞ –°–¢–ê–†–ê–Ø –≤–µ—Ä—Å–∏—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π API. –ù—É–∂–Ω–æ:

```bash
# 1. –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—É—é –≤–µ—Ä—Å–∏—é —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤
# 2. –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
cd /Users/kirillpetrov/Projects/time-to-travel
flutter clean
flutter pub get

# 3. –°–æ–±—Ä–∞—Ç—å –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–Ω–æ–≤–æ
flutter build apk
flutter install

# –ò–õ–ò –¥–ª—è –ø—Ä—è–º–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏:
flutter run --release
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Å–ª–µ –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–∏:

1. **–ù–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ –∫–ª–∏–µ–Ω—Ç–∞**:
   ```
   ‚úÖ –°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑
   ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ - –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
      üì§ –°–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: —Å–Ω–∞—á–∞–ª–∞ –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ backend API...
      ‚úÖ –ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ: {id}
   ‚ùå –ù–ï –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
      üì§ [SYNC] –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–∫–∞–∑–∞ ... –≤ Firebase...
   ```

2. **–ù–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞**:
   ```
   ‚úÖ –û—Ç–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞
   ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏:
      üîç –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π —Å backend API...
      üì• –ü–æ–ª—É—á–µ–Ω–æ X –∑–∞–∫–∞–∑–æ–≤ —Å —Å–µ—Ä–≤–µ—Ä–∞
      ‚úÖ –£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ X –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤
   ‚úÖ –ó–∞–∫–∞–∑—ã –∫–ª–∏–µ–Ω—Ç–æ–≤ –¥–æ–ª–∂–Ω—ã –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è!
   ```

## üìä –°—Ç–∞—Ç—É—Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –°—Ç–∞—Ç—É—Å | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|-----------|--------|-------------|
| BookingService.createBooking() | ‚úÖ –ì–æ—Ç–æ–≤ | –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ https://titotr.ru/api/orders |
| BookingService.getActiveBookings() | ‚úÖ –û–ë–ù–û–í–õ–Å–ù | –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Å https://titotr.ru/api/orders |
| BookingService.getClientBookings() | ‚úÖ –ì–æ—Ç–æ–≤ | –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Å https://titotr.ru/api/orders |
| OrdersSyncService | ‚ö†Ô∏è –û–¢–ö–õ–Æ–ß–Å–ù | –ë–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–µ–Ω |
| FirebaseOrdersService | ‚ö†Ô∏è –ù–ï –ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø | –ú–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –ø–æ–∑–∂–µ |
| DispatcherHomeScreen | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π getActiveBookings() |

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –ï—Å–ª–∏ –∑–∞–∫–∞–∑—ã –≤—Å—ë –µ—â—ë –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è:

1. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å backend**:
   ```bash
   curl https://titotr.ru/api/orders
   # –î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å JSON —Å –∑–∞–∫–∞–∑–∞–º–∏
   ```

2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è**:
   ```bash
   flutter logs
   # –ò—Å–∫–∞—Ç—å:
   # - üì§ –°–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è...
   # - üîç –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π...
   # - –û—à–∏–±–∫–∏ HTTP –∑–∞–ø—Ä–æ—Å–æ–≤
   ```

3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–æ–∫–µ–Ω—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏**:
   - –í –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö API –º–µ—Ç–æ–¥–∞—Ö —Ç—Ä–µ–±—É–µ—Ç—Å—è JWT —Ç–æ–∫–µ–Ω
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `flutter_secure_storage` - –µ—Å—Ç—å –ª–∏ —Ç–æ–∫–µ–Ω

## üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

1. **–£–¥–∞–ª–∏—Ç—å Firebase –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏** (–ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏):
   - cloud_firestore
   - firebase_auth
   - firebase_core
   - firebase_messaging
   - firebase_storage

2. **–£–¥–∞–ª–∏—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ —Å–µ—Ä–≤–∏—Å—ã**:
   - firebase_orders_service.dart
   - orders_sync_service.dart

3. **–û–±–Ω–æ–≤–∏—Ç—å offline_orders_service.dart**:
   - –°–µ–π—á–∞—Å —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –º–æ–¥–µ–ª—å—é TaxiOrder
   - –ú–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–µ–ª–∞—Ç—å –Ω–∞ —Ä–∞–±–æ—Ç—É —Å Booking –∏–ª–∏ —É–¥–∞–ª–∏—Ç—å

---

## üéâ –ò—Ç–æ–≥

**–î–û**: –ö–ª–∏–µ–Ω—Ç ‚Üí SQLite ‚Üí OrdersSyncService ‚Üí Firebase ‚ùå ‚Üí –î–∏—Å–ø–µ—Ç—á–µ—Ä —á–∏—Ç–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ ‚ùå

**–ü–û–°–õ–ï**: –ö–ª–∏–µ–Ω—Ç ‚Üí BookingService ‚Üí https://titotr.ru ‚úÖ ‚Üí –î–∏—Å–ø–µ—Ç—á–µ—Ä —á–∏—Ç–∞–µ—Ç —Å API ‚úÖ

**–ì–ª–∞–≤–Ω–æ–µ**: –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π!
