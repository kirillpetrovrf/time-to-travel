# –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –ó–∞–¥–∞–Ω–∏–µ: –ú–∏–≥—Ä–∞—Ü–∏—è Time to Travel —Å SQLite –Ω–∞ PostgreSQL Backend

## üìã –û–±—â–∞—è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 21 —è–Ω–≤–∞—Ä—è 2026  
**–í–µ—Ä—Å–∏—è:** 2.1  
**–ü—Ä–æ–µ–∫—Ç:** Time to Travel (titotr.ru)  
**–¢–∏–ø –º–∏–≥—Ä–∞—Ü–∏–∏:** SQLite (–ª–æ–∫–∞–ª—å–Ω—ã–π) ‚Üí PostgreSQL + Dart Frog Backend (–°–µ—Ä–≤–µ—Ä Selectel)

---

## üéØ –¶–µ–ª—å –ü—Ä–æ–µ–∫—Ç–∞

–ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å Flutter-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ Time to Travel —Å –ª–æ–∫–∞–ª—å–Ω–æ–π –±–∞–∑—ã SQLite –Ω–∞ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π backend —Å PostgreSQL –Ω–∞ –±–∞–∑–µ Dart Frog, —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–π –Ω–∞ –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ Selectel —Å –¥–æ–º–µ–Ω–æ–º **titotr.ru**.

### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:

- ‚úÖ Flutter –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç **–æ—Ñ–ª–∞–π–Ω** —Å SQLite
- ‚úÖ Firebase –ø–æ–¥–∫–ª—é—á–µ–Ω, –Ω–æ **–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è** (—Ä–µ–∑–µ—Ä–≤ –Ω–∞ –±—É–¥—É—â–µ–µ)
- ‚úÖ –í—Å–µ –¥–∞–Ω–Ω—ã–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –∑–∞—è–≤–∫–∏, –º–∞—Ä—à—Ä—É—Ç—ã)
- ‚ùå –ù–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –º–µ–∂–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏
- ‚ùå –ù–µ—Ç —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –¥–∞–Ω–Ω—ã—Ö

### –¶–µ–ª–µ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:

- ‚úÖ Centralized PostgreSQL –±–∞–∑–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
- ‚úÖ REST API –Ω–∞ Dart Frog –¥–ª—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
- ‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏
- ‚úÖ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ñ–ª–∞–π–Ω-—Ä–∞–±–æ—Ç—ã —Å –ø–æ—Å–ª–µ–¥—É—é—â–µ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π

### –ö–ª—é—á–µ–≤—ã–µ –ó–∞–¥–∞—á–∏:

1. ‚úÖ –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –Ω–∞ Selectel Cloud
2. ‚úÖ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –¥–æ–º–µ–Ω titotr.ru —Å DNS-—Å–µ—Ä–≤–µ—Ä–∞–º–∏ Selectel
3. ‚úÖ –ü–æ–ª—É—á–∏—Ç—å –∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å SSL-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç Let's Encrypt –¥–ª—è HTTPS
4. ‚úÖ –†–∞–∑—Ä–∞–±–æ—Ç–∞—Ç—å backend –Ω–∞ Dart Frog —Å REST API
5. ‚úÖ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å PostgreSQL –¥–ª—è —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è
6. ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é
7. ‚úÖ –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö SQLite ‚Üí PostgreSQL
8. ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å Flutter –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å API
9. ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º —Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
10. ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–µ–ø–ª–æ–π —á–µ—Ä–µ–∑ Docker –∏ CI/CD

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ü—Ä–æ–µ–∫—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å —Ç–µ–∫—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ (–∑–∞—è–≤–∫–∏ –Ω–∞ –ø–æ–µ–∑–¥–∫–∏, –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö, –º–∞—Ä—à—Ä—É—Ç—ã), –ø–æ—ç—Ç–æ–º—É —Ñ–∞–π–ª–æ–≤–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (S3) –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è. –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ PostgreSQL.

---

## üñ•Ô∏è –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞

### 1. –î–æ–º–µ–Ω –∏ DNS –ù–∞—Å—Ç—Ä–æ–π–∫–∞

**–î–æ–º–µ–Ω:** titotr.ru  
**–†–µ–≥–∏—Å—Ç—Ä–∞—Ç–æ—Ä:** Selectel  
**–°—Ç–∞—Ç—É—Å:** –¢–æ–ª—å–∫–æ —á—Ç–æ –ø—Ä–∏–æ–±—Ä–µ—Ç—ë–Ω, —Ç—Ä–µ–±—É–µ—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ DNS –∏ SSL

#### DNS –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–∞ Selectel

**DNS-—Å–µ—Ä–≤–µ—Ä—ã Selectel (–∫–∞–∫ –ø–æ–∫–∞–∑–∞–Ω–æ –Ω–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–µ):**
```
d.ns.selectel.ru
a.ns.selectel.ru
b.ns.selectel.ru
c.ns.selectel.ru
```

**–ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ DNS –∑–∞–ø–∏—Å–∏:**

| –¢–∏–ø | –ò–º—è | –ó–Ω–∞—á–µ–Ω–∏–µ | TTL |
|-----|-----|----------|-----|
| A | @ | <IP_–í–ê–®–ï–ì–û_–°–ï–†–í–ï–†–ê> | 3600 |
| A | www | <IP_–í–ê–®–ï–ì–û_–°–ï–†–í–ï–†–ê> | 3600 |
| AAAA | @ | <IPv6_–ê–î–†–ï–°> (–µ—Å–ª–∏ –µ—Å—Ç—å) | 3600 |
| CNAME | api | titotr.ru | 3600 |
| TXT | @ | "v=spf1 include:_spf.selectel.ru ~all" | 3600 |

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ DNS –ø–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å A-–∑–∞–ø–∏—Å—å
dig titotr.ru A

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å DNS-—Å–µ—Ä–≤–µ—Ä—ã
dig titotr.ru NS

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ DNS
dig @d.ns.selectel.ru titotr.ru
```

‚ö†Ô∏è **–í–ê–ñ–ù–û:** –†–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ DNS –∑–∞–ø–∏—Å–µ–π –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –æ—Ç 15 –º–∏–Ω—É—Ç –¥–æ 48 —á–∞—Å–æ–≤!

---

### 2. –ü—Ä–æ–≤–∞–π–¥–µ—Ä –∏ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –°–µ—Ä–≤–µ—Ä–∞

**–•–æ—Å—Ç–∏–Ω–≥:** Selectel Cloud (–í—ã–¥–µ–ª–µ–Ω–Ω—ã–π VPS)  
**–õ–æ–∫–∞—Ü–∏—è:** –ú–æ—Å–∫–≤–∞, –†–æ—Å—Å–∏—è (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è —Ä–æ—Å—Å–∏–π—Å–∫–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏)  

**–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –¥–ª—è Time to Travel:**
- **CPU:** 2 vCPU (–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è —Å—Ç–∞—Ä—Ç–∞)
- **RAM:** 4 GB (–º–∏–Ω–∏–º—É–º –¥–ª—è Dart Frog + PostgreSQL)
- **–î–∏—Å–∫:** 40 GB SSD (—Ç–æ–ª—å–∫–æ –ë–î –∏ –ª–æ–≥–∏, –±–µ–∑ —Ñ–∞–π–ª–æ–≤–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞)
- **–û–°:** Ubuntu 22.04 LTS (—Å—Ç–∞–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å –¥–æ–ª–≥–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π)
- **IP:** –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π IPv4 –∞–¥—Ä–µ—Å
- **Bandwidth:** –ë–µ–∑–ª–∏–º–∏—Ç–Ω—ã–π —Ç—Ä–∞—Ñ–∏–∫

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è —Ä–æ—Å—Ç–∞:**
- **CPU:** 4 vCPU
- **RAM:** 8 GB (–∫–æ–º—Ñ–æ—Ä—Ç–Ω–∞—è —Ä–∞–±–æ—Ç–∞ + –∑–∞–ø–∞—Å)
- **–î–∏—Å–∫:** 80 GB SSD NVMe (—Å –∑–∞–ø–∞—Å–æ–º –¥–ª—è —Ä–æ—Å—Ç–∞)
- **Backup:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –±—ç–∫–∞–ø—ã 1 —Ä–∞–∑ –≤ –¥–µ–Ω—å
- **IPv6:** –í–∫–ª—é—á–∏—Ç—å –¥–ª—è –±—É–¥—É—â–µ–≥–æ

**–ü—Ä–∏–º–µ—Ä–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –Ω–∞ Selectel:**
- –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è: ~500-700 —Ä—É–±/–º–µ—Å
- –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è: ~1000-1500 —Ä—É–±/–º–µ—Å

---

## üîÑ –ú–∏–≥—Ä–∞—Ü–∏—è —Å Firebase

### 3. –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä

#### –°—Ç–∞—Ä–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (Firebase):
```
Flutter App
    ‚Üì
Firebase SDK
    ‚îú‚îÄ‚Üí Firebase Auth (–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è)
    ‚îú‚îÄ‚Üí Firestore (–±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö)
    ‚îú‚îÄ‚Üí Cloud Functions (–±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞)
    ‚îî‚îÄ‚Üí FCM (push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è)
```

#### –ù–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (Dart Frog):
```
Flutter App
    ‚Üì
HTTP Client (dio/http)
    ‚Üì
HTTPS/REST API (titotr.ru/api)
    ‚Üì
Nginx (Reverse Proxy + SSL)
    ‚Üì
Dart Frog Backend (Docker)
    ‚îú‚îÄ‚Üí JWT Auth (—Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è)
    ‚îú‚îÄ‚Üí PostgreSQL (—Ä–µ–ª—è—Ü–∏–æ–Ω–Ω–∞—è –ë–î –¥–ª—è –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö)
    ‚îú‚îÄ‚Üí Dart Frog Routes (REST API endpoints)
    ‚îî‚îÄ‚Üí Redis (–∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ + sessions)
```

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –º–∏–≥—Ä–∞—Ü–∏–∏:

‚úÖ **–ü–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å** –Ω–∞–¥ backend-–ª–æ–≥–∏–∫–æ–π  
‚úÖ **–ù–µ—Ç vendor lock-in** (–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç Firebase)  
‚úÖ **–°–Ω–∏–∂–µ–Ω–∏–µ –∑–∞—Ç—Ä–∞—Ç** –Ω–∞ –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–π –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–µ  
‚úÖ **–ï–¥–∏–Ω—ã–π —è–∑—ã–∫** (Dart) –¥–ª—è frontend –∏ backend  
‚úÖ **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã  
‚úÖ **–°–æ–±–ª—é–¥–µ–Ω–∏–µ 152-–§–ó** - –¥–∞–Ω–Ω—ã–µ –≤ –†–æ—Å—Å–∏–∏  
‚úÖ **–ì–∏–±–∫–æ—Å—Ç—å** –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–∏  
‚úÖ **–ü—Ä–æ—Å—Ç–æ—Ç–∞** - —Ç–æ–ª—å–∫–æ –ë–î, –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ —Ö—Ä–∞–Ω–µ–Ω–∏—è

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –î–æ—Å—Ç—É–ø

### 4. SSH –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (Critical Security)

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
- ‚úÖ –û—Ç–∫–ª—é—á–∏—Ç—å –≤—Ö–æ–¥ –ø–æ –ø–∞—Ä–æ–ª—é (—Ç–æ–ª—å–∫–æ SSH-–∫–ª—é—á–∏)
- ‚úÖ –ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–æ—Ä—Ç SSH (—Å 22 –Ω–∞ –∫–∞—Å—Ç–æ–º–Ω—ã–π, –Ω–∞–ø—Ä–∏–º–µ—Ä 2222)
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å fail2ban –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç brute-force –∞—Ç–∞–∫
- ‚úÖ –í–∫–ª—é—á–∏—Ç—å UFW (Uncomplicated Firewall)
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ED25519 SSH-–∫–ª—é—á–∏ (—Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç)

**–ì–µ–Ω–µ—Ä–∞—Ü–∏—è SSH-–∫–ª—é—á–∞ –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ (macOS/Linux):**
```bash
ssh-keygen -t ed25519 -C "your_email@example.com" -f ~/.ssh/id_ed25519_project
```

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:**
```bash
# –°–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –∫–ª—é—á–µ–π
mkdir -p ~/.ssh
chmod 700 ~/.ssh

# –î–æ–±–∞–≤–∏—Ç—å –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á
nano ~/.ssh/authorized_keys
# –í—Å—Ç–∞–≤–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ id_ed25519_project.pub
chmod 600 ~/.ssh/authorized_keys

# –ù–∞—Å—Ç—Ä–æ–∏—Ç—å sshd_config
sudo nano /etc/ssh/sshd_config
```

**–§–∞–π–ª `/etc/ssh/sshd_config`:**
```
Port 2222
PermitRootLogin prohibit-password
PubkeyAuthentication yes
PasswordAuthentication no
ChallengeResponseAuthentication no
UsePAM no
X11Forwarding no
AllowUsers deploy_user
```

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ (macOS) `~/.ssh/config`:**
```
Host titotr-production
    HostName titotr.ru
    Port 2222
    User deploy
    IdentityFile ~/.ssh/id_ed25519_titotr
    UseKeychain yes
    AddKeysToAgent yes
    ServerAliveInterval 60
    ServerAliveCountMax 3
```

**–î–æ–±–∞–≤–∏—Ç—å –∫–ª—é—á –≤ macOS Keychain:**
```bash
ssh-add --apple-use-keychain ~/.ssh/id_ed25519_titotr

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
ssh titotr-production
```

---

## üê∏ Dart Frog Backend

### 5. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ Dart Frog

**–ß—Ç–æ —Ç–∞–∫–æ–µ Dart Frog?**

Dart Frog - —ç—Ç–æ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π backend-—Ñ—Ä–µ–π–º–≤–æ—Ä–∫ –Ω–∞ Dart, —Å–æ–∑–¥–∞–Ω–Ω—ã–π –∫–æ–º–∞–Ω–¥–æ–π Very Good Ventures. –û–Ω –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç:
- üöÄ –ë—ã—Å—Ç—Ä—É—é —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É REST API
- üî• Hot reload –¥–ª—è backend (–∫–∞–∫ –≤–æ Flutter!)
- üì¶ Middleware system (auth, logging, CORS)
- üß™ –í—Å—Ç—Ä–æ–µ–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- üê≥ Docker support –∏–∑ –∫–æ—Ä–æ–±–∫–∏
- üéØ Type-safe routing

**–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Å–∞–π—Ç:** https://dart-frog.dev/

#### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ Dart Frog –ø—Ä–æ–µ–∫—Ç–∞:

```
backend/
‚îú‚îÄ‚îÄ routes/                    # API endpoints (–∞–≤—Ç–æ—Ä–æ—É—Ç–∏–Ω–≥)
‚îÇ   ‚îú‚îÄ‚îÄ index.dart            # GET/POST /api/
‚îÇ   ‚îú‚îÄ‚îÄ health.dart           # GET /api/health
‚îÇ   ‚îú‚îÄ‚îÄ auth/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ login.dart        # POST /api/auth/login
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ register.dart     # POST /api/auth/register
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ refresh.dart      # POST /api/auth/refresh
‚îÇ   ‚îú‚îÄ‚îÄ users/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ [id].dart         # GET/PUT/DELETE /api/users/:id
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ me.dart           # GET /api/users/me
‚îÇ   ‚îú‚îÄ‚îÄ bookings/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ index.dart        # GET/POST /api/bookings
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ [id].dart         # GET/PUT/DELETE /api/bookings/:id
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ [id]/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ cancel.dart   # POST /api/bookings/:id/cancel
‚îÇ   ‚îî‚îÄ‚îÄ _middleware.dart      # –ì–ª–æ–±–∞–ª—å–Ω—ã–π middleware
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îú‚îÄ‚îÄ models/               # Data models
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ user.dart
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ booking.dart
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ route.dart
‚îÇ   ‚îú‚îÄ‚îÄ services/             # Business logic
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth_service.dart
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ database_service.dart
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ storage_service.dart
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ notification_service.dart
‚îÇ   ‚îú‚îÄ‚îÄ repositories/         # Data access layer
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ user_repository.dart
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ booking_repository.dart
‚îÇ   ‚îú‚îÄ‚îÄ middlewares/          # Custom middleware
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth_middleware.dart
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cors_middleware.dart
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ logging_middleware.dart
‚îÇ   ‚îî‚îÄ‚îÄ utils/
‚îÇ       ‚îú‚îÄ‚îÄ jwt_utils.dart
‚îÇ       ‚îú‚îÄ‚îÄ validators.dart
‚îÇ       ‚îî‚îÄ‚îÄ constants.dart
‚îú‚îÄ‚îÄ test/                     # Unit & integration tests
‚îÇ   ‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îî‚îÄ‚îÄ services/
‚îú‚îÄ‚îÄ pubspec.yaml              # Dependencies
‚îú‚îÄ‚îÄ Dockerfile                # Production image
‚îú‚îÄ‚îÄ docker-compose.yml        # Local development
‚îî‚îÄ‚îÄ .env.example              # Environment template
```

#### –ü—Ä–∏–º–µ—Ä routes/auth/login.dart:

```dart
import 'dart:io';
import 'package:dart_frog/dart_frog.dart';

// POST /api/auth/login
Future<Response> onRequest(RequestContext context) async {
  // –¢–æ–ª—å–∫–æ POST –∑–∞–ø—Ä–æ—Å—ã
  if (context.request.method != HttpMethod.post) {
    return Response(statusCode: HttpStatus.methodNotAllowed);
  }

  try {
    // –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ body
    final body = await context.request.json() as Map<String, dynamic>;
    final email = body['email'] as String?;
    final password = body['password'] as String?;

    if (email == null || password == null) {
      return Response.json(
        statusCode: HttpStatus.badRequest,
        body: {'error': 'Email and password are required'},
      );
    }

    // –ü–æ–ª—É—á–∏—Ç—å —Å–µ—Ä–≤–∏—Å –∏–∑ middleware
    final authService = context.read<AuthService>();
    
    // –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
    final result = await authService.login(email, password);

    return Response.json(
      body: {
        'access_token': result.accessToken,
        'refresh_token': result.refreshToken,
        'user': result.user.toJson(),
      },
    );
  } catch (e) {
    return Response.json(
      statusCode: HttpStatus.unauthorized,
      body: {'error': 'Invalid credentials'},
    );
  }
}
```

#### –ü—Ä–∏–º–µ—Ä routes/_middleware.dart:

```dart
import 'package:dart_frog/dart_frog.dart';
import 'package:backend/services/auth_service.dart';
import 'package:backend/services/database_service.dart';

// –ì–ª–æ–±–∞–ª—å–Ω—ã–π middleware –¥–ª—è –≤—Å–µ—Ö routes
Handler middleware(Handler handler) {
  return handler
      .use(requestLogger())
      .use(corsMiddleware())
      .use(databaseProvider())
      .use(authServiceProvider());
}

// CORS middleware
Middleware corsMiddleware() {
  return (handler) {
    return (context) async {
      final response = await handler(context);
      
      return response.copyWith(
        headers: {
          ...response.headers,
          'Access-Control-Allow-Origin': '*',
          'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
          'Access-Control-Allow-Headers': 'Content-Type, Authorization',
        },
      );
    };
  };
}

// Database connection provider
Middleware databaseProvider() {
  return provider<DatabaseService>(
    (_) => DatabaseService(connectionString: _envDatabaseUrl),
  );
}

// Auth service provider
Middleware authServiceProvider() {
  return (handler) {
    return (context) {
      final db = context.read<DatabaseService>();
      final authService = AuthService(db);
      
      return handler(
        context.provide<AuthService>(() => authService),
      );
    };
  };
}
```

#### pubspec.yaml –¥–ª—è Dart Frog:

```yaml
name: time_to_travel_backend
description: Dart Frog backend for Time to Travel app
version: 1.0.0
publish_to: none

environment:
  sdk: '>=3.0.0 <4.0.0'

dependencies:
  dart_frog: ^2.0.0
  postgres: ^3.0.0              # PostgreSQL driver
  jwt_decoder: ^2.0.1           # JWT parsing
  dart_jsonwebtoken: ^2.12.0    # JWT generation
  bcrypt: ^1.1.3                # Password hashing
  uuid: ^4.0.0                  # UUID generation
  http: ^1.1.0                  # HTTP client
  redis: ^3.1.0                 # Redis client
  dotenv: ^4.2.0                # Environment variables

dev_dependencies:
  build_runner: ^2.4.0
  build_verify: ^3.1.0
  build_version: ^2.1.1
  dart_frog_cli: ^2.0.0
  mocktail: ^1.0.0
  test: ^1.24.0
  very_good_analysis: ^6.0.0
```

#### Dockerfile –¥–ª—è Dart Frog:

```dockerfile
# Build stage
FROM dart:stable AS build

WORKDIR /app

# Copy dependencies
COPY pubspec.* ./
RUN dart pub get

# Copy source
COPY . .

# Build Dart Frog
RUN dart pub global activate dart_frog_cli
RUN dart pub global run dart_frog_cli:dart_frog build

# Production stage
FROM dart:stable-slim AS production

# Install runtime dependencies
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    ca-certificates && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy built app
COPY --from=build /app/build .

# Expose port
EXPOSE 8080

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
  CMD dart /app/bin/server.dart || exit 1

# Run app
CMD ["dart", "bin/server.dart", "--hostname", "0.0.0.0", "--port", "8080"]
```

#### –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞:

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Dart Frog CLI
dart pub global activate dart_frog_cli

# –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç
dart_frog create backend

# –ó–∞–ø—É—Å—Ç–∏—Ç—å dev server —Å hot reload
cd backend
dart_frog dev

# Server –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –Ω–∞ http://localhost:8080
# Hot reload —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!
```

---

## üóÑÔ∏è PostgreSQL Database

### 6. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ PostgreSQL –≤–º–µ—Å—Ç–æ Firestore

#### –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö Firestore ‚Üí PostgreSQL

**Firestore (NoSQL):**
```javascript
// –ö–æ–ª–ª–µ–∫—Ü–∏—è users
users/
  ‚îú‚îÄ‚îÄ user_id_1
  ‚îÇ   ‚îú‚îÄ‚îÄ email: "user@example.com"
  ‚îÇ   ‚îú‚îÄ‚îÄ name: "John Doe"
  ‚îÇ   ‚îî‚îÄ‚îÄ created_at: Timestamp
  ‚îî‚îÄ‚îÄ user_id_2
```

**PostgreSQL (SQL):**
```sql
-- –¢–∞–±–ª–∏—Ü–∞ users
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    name VARCHAR(255) NOT NULL,
    phone VARCHAR(20),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_created_at ON users(created_at);
```

#### –°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö Time to Travel:

```sql
-- –§–∞–π–ª: database/init/01-schema.sql

-- Enable extensions
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pg_trgm"; -- –¥–ª—è –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞

-- Users table
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    name VARCHAR(255) NOT NULL,
    phone VARCHAR(20),
    is_verified BOOLEAN DEFAULT FALSE,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Refresh tokens (–¥–ª—è JWT)
CREATE TABLE refresh_tokens (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    token_hash VARCHAR(255) NOT NULL,
    expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Routes (–º–∞—Ä—à—Ä—É—Ç—ã)
CREATE TABLE routes (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(255) NOT NULL,
    from_city VARCHAR(255) NOT NULL,
    to_city VARCHAR(255) NOT NULL,
    distance_km DECIMAL(10, 2),
    duration_minutes INTEGER,
    base_price DECIMAL(10, 2) NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Bookings (–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è)
CREATE TABLE bookings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    route_id UUID NOT NULL REFERENCES routes(id),
    pickup_address TEXT NOT NULL,
    dropoff_address TEXT NOT NULL,
    pickup_time TIMESTAMP WITH TIME ZONE NOT NULL,
    passengers INTEGER DEFAULT 1,
    luggage INTEGER DEFAULT 0,
    total_price DECIMAL(10, 2) NOT NULL,
    status VARCHAR(50) DEFAULT 'pending', -- pending, confirmed, completed, cancelled
    payment_status VARCHAR(50) DEFAULT 'pending',
    notes TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Payments (–ø–ª–∞—Ç–µ–∂–∏)
CREATE TABLE payments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    booking_id UUID NOT NULL REFERENCES bookings(id) ON DELETE CASCADE,
    amount DECIMAL(10, 2) NOT NULL,
    currency VARCHAR(3) DEFAULT 'RUB',
    payment_method VARCHAR(50), -- card, cash, sbp
    payment_provider VARCHAR(50), -- yookassa, tinkoff
    transaction_id VARCHAR(255),
    status VARCHAR(50) DEFAULT 'pending',
    paid_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_refresh_tokens_user_id ON refresh_tokens(user_id);
CREATE INDEX idx_bookings_user_id ON bookings(user_id);
CREATE INDEX idx_bookings_status ON bookings(status);
CREATE INDEX idx_bookings_pickup_time ON bookings(pickup_time);
CREATE INDEX idx_payments_booking_id ON payments(booking_id);

-- –¢—Ä–∏–≥–≥–µ—Ä –¥–ª—è updated_at
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_users_updated_at BEFORE UPDATE ON users
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_routes_updated_at BEFORE UPDATE ON routes
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_bookings_updated_at BEFORE UPDATE ON bookings
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

#### Database Service –≤ Dart:

```dart
// lib/services/database_service.dart

import 'package:postgres/postgres.dart';

class DatabaseService {
  late final Connection _connection;
  
  DatabaseService({required String connectionString}) {
    _initConnection(connectionString);
  }

  Future<void> _initConnection(String connectionString) async {
    final uri = Uri.parse(connectionString);
    
    _connection = await Connection.open(
      Endpoint(
        host: uri.host,
        database: uri.pathSegments.first,
        username: uri.userInfo.split(':').first,
        password: uri.userInfo.split(':').last,
        port: uri.port,
      ),
      settings: ConnectionSettings(
        sslMode: SslMode.require, // –í–∞–∂–Ω–æ –¥–ª—è production!
      ),
    );
  }

  // Execute query
  Future<Result> execute(
    String query, {
    Map<String, dynamic>? parameters,
  }) async {
    return await _connection.execute(
      Sql.named(query),
      parameters: parameters,
    );
  }

  // Close connection
  Future<void> close() async {
    await _connection.close();
  }
}
```

---

## üîë JWT Authentication

### 7. –ó–∞–º–µ–Ω–∞ Firebase Auth –Ω–∞ JWT

#### –ö–æ–Ω—Ü–µ–ø—Ü–∏—è JWT:

Firebase Auth ‚Üí **JWT (JSON Web Tokens)** + Refresh Tokens

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ JWT:**
- ‚úÖ Stateless (–Ω–µ –Ω—É–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å —Å–µ—Å—Å–∏–∏)
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –≤–µ–∑–¥–µ (web, mobile, API)
- ‚úÖ –°–æ–¥–µ—Ä–∂–∏—Ç claims (—Ä–æ–ª–∏, permissions)
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

#### AuthService —Å JWT:

```dart
// lib/services/auth_service.dart

import 'package:dart_jsonwebtoken/dart_jsonwebtoken.dart';
import 'package:bcrypt/bcrypt.dart';
import 'package:uuid/uuid.dart';

class AuthService {
  final DatabaseService _db;
  final String _jwtSecret;
  final Duration _accessTokenExpiry = Duration(minutes: 15);
  final Duration _refreshTokenExpiry = Duration(days: 30);

  AuthService(this._db, this._jwtSecret);

  // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
  Future<AuthResult> register({
    required String email,
    required String password,
    required String name,
  }) async {
    // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    final exists = await _userExists(email);
    if (exists) {
      throw AuthException('User already exists');
    }

    // –•–µ—à–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä–æ–ª—å
    final passwordHash = BCrypt.hashpw(password, BCrypt.gensalt());

    // –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    final result = await _db.execute(
      '''
      INSERT INTO users (email, password_hash, name)
      VALUES (@email, @password_hash, @name)
      RETURNING id, email, name, created_at
      ''',
      parameters: {
        'email': email,
        'password_hash': passwordHash,
        'name': name,
      },
    );

    final user = User.fromRow(result.first);

    // –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–∫–µ–Ω—ã
    final tokens = await _generateTokens(user.id);

    return AuthResult(
      user: user,
      accessToken: tokens.accessToken,
      refreshToken: tokens.refreshToken,
    );
  }

  // –í—Ö–æ–¥
  Future<AuthResult> login({
    required String email,
    required String password,
  }) async {
    // –ù–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    final result = await _db.execute(
      'SELECT * FROM users WHERE email = @email',
      parameters: {'email': email},
    );

    if (result.isEmpty) {
      throw AuthException('Invalid credentials');
    }

    final user = User.fromRow(result.first);

    // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–∞—Ä–æ–ª—å
    final passwordMatch = BCrypt.checkpw(
      password,
      user.passwordHash,
    );

    if (!passwordMatch) {
      throw AuthException('Invalid credentials');
    }

    // –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–∫–µ–Ω—ã
    final tokens = await _generateTokens(user.id);

    return AuthResult(
      user: user,
      accessToken: tokens.accessToken,
      refreshToken: tokens.refreshToken,
    );
  }

  // –û–±–Ω–æ–≤–∏—Ç—å access token —á–µ—Ä–µ–∑ refresh token
  Future<TokenPair> refreshAccessToken(String refreshToken) async {
    // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å refresh token –≤ –ë–î
    final result = await _db.execute(
      '''
      SELECT rt.user_id
      FROM refresh_tokens rt
      WHERE rt.token_hash = @token_hash
        AND rt.expires_at > NOW()
      ''',
      parameters: {
        'token_hash': _hashToken(refreshToken),
      },
    );

    if (result.isEmpty) {
      throw AuthException('Invalid refresh token');
    }

    final userId = result.first[0] as String;

    // –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–µ —Ç–æ–∫–µ–Ω—ã
    return await _generateTokens(userId);
  }

  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤
  Future<TokenPair> _generateTokens(String userId) async {
    // Access token (–∫–æ—Ä–æ—Ç–∫–∏–π —Å—Ä–æ–∫)
    final accessToken = JWT(
      {
        'user_id': userId,
        'type': 'access',
        'iat': DateTime.now().millisecondsSinceEpoch ~/ 1000,
        'exp': DateTime.now()
            .add(_accessTokenExpiry)
            .millisecondsSinceEpoch ~/ 1000,
      },
    ).sign(SecretKey(_jwtSecret));

    // Refresh token (–¥–ª–∏–Ω–Ω—ã–π —Å—Ä–æ–∫)
    final refreshToken = Uuid().v4();
    final refreshTokenHash = _hashToken(refreshToken);

    // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å refresh token –≤ –ë–î
    await _db.execute(
      '''
      INSERT INTO refresh_tokens (user_id, token_hash, expires_at)
      VALUES (@user_id, @token_hash, @expires_at)
      ''',
      parameters: {
        'user_id': userId,
        'token_hash': refreshTokenHash,
        'expires_at': DateTime.now().add(_refreshTokenExpiry),
      },
    );

    return TokenPair(
      accessToken: accessToken,
      refreshToken: refreshToken,
    );
  }

  // –í–∞–ª–∏–¥–∞—Ü–∏—è access token
  Future<User?> validateAccessToken(String token) async {
    try {
      final jwt = JWT.verify(token, SecretKey(_jwtSecret));
      final userId = jwt.payload['user_id'] as String;

      // –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      final result = await _db.execute(
        'SELECT * FROM users WHERE id = @id',
        parameters: {'id': userId},
      );

      if (result.isEmpty) return null;

      return User.fromRow(result.first);
    } catch (e) {
      return null;
    }
  }

  String _hashToken(String token) {
    return BCrypt.hashpw(token, BCrypt.gensalt());
  }

  Future<bool> _userExists(String email) async {
    final result = await _db.execute(
      'SELECT COUNT(*) FROM users WHERE email = @email',
      parameters: {'email': email},
    );
    return result.first[0] as int > 0;
  }
}
```

#### Auth Middleware:

```dart
// lib/middlewares/auth_middleware.dart

import 'package:dart_frog/dart_frog.dart';

Middleware authMiddleware() {
  return (handler) {
    return (context) async {
      // –ü–æ–ª—É—á–∏—Ç—å Authorization header
      final authHeader = context.request.headers['Authorization'];
      
      if (authHeader == null || !authHeader.startsWith('Bearer ')) {
        return Response.json(
          statusCode: HttpStatus.unauthorized,
          body: {'error': 'Missing or invalid authorization header'},
        );
      }

      // –ò–∑–≤–ª–µ—á—å —Ç–æ–∫–µ–Ω
      final token = authHeader.substring(7);

      // –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–∫–µ–Ω
      final authService = context.read<AuthService>();
      final user = await authService.validateAccessToken(token);

      if (user == null) {
        return Response.json(
          statusCode: HttpStatus.unauthorized,
          body: {'error': 'Invalid or expired token'},
        );
      }

      // –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ context
      return handler(
        context.provide<User>(() => user),
      );
    };
  };
}
```

#### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –∑–∞—â–∏—â–µ–Ω–Ω—ã—Ö routes:

```dart
// routes/users/me/_middleware.dart

import 'package:dart_frog/dart_frog.dart';
import 'package:backend/middlewares/auth_middleware.dart';

Handler middleware(Handler handler) {
  return handler.use(authMiddleware());
}

// routes/users/me/index.dart

Future<Response> onRequest(RequestContext context) async {
  // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –µ—Å—Ç—å –≤ context –±–ª–∞–≥–æ–¥–∞—Ä—è middleware
  final user = context.read<User>();

  return Response.json(
    body: user.toJson(),
  );
}
```

---

## üê≥ Docker –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞

### 8. Docker Compose Stack –¥–ª—è Time to Travel

**Docker Engine:**
```bash
# –û–±–Ω–æ–≤–∏—Ç—å —Å–∏—Å—Ç–µ–º—É
sudo apt update && sudo apt upgrade -y

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
sudo apt install -y apt-transport-https ca-certificates curl software-properties-common

# –î–æ–±–∞–≤–∏—Ç—å GPG –∫–ª—é—á Docker
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg

# –î–æ–±–∞–≤–∏—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π Docker
echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Docker
sudo apt update
sudo apt install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin

# –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –≥—Ä—É–ø–ø—É docker
sudo usermod -aG docker deploy
newgrp docker

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫—É
docker --version
docker compose version
```

**–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫ Docker:**
```bash
sudo systemctl enable docker
sudo systemctl start docker
```

---

## üèóÔ∏è Docker Compose –¥–ª—è Time to Travel

### 9. Production Docker Compose

**docker-compose.yml:**

```yaml
version: '3.9'

services:
  # Nginx Reverse Proxy + SSL
  nginx:
    image: nginx:alpine
    container_name: titotr_nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - certbot-www:/var/www/certbot:ro
      - certbot-conf:/etc/letsencrypt:ro
    depends_on:
      - backend
    networks:
      - titotr_network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Dart Frog Backend
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
      args:
        - DART_VERSION=stable
    container_name: titotr_backend
    restart: unless-stopped
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
      - REDIS_URL=redis://redis:6379
      - JWT_SECRET=${JWT_SECRET}
      - JWT_ACCESS_EXPIRY=900  # 15 minutes
      - JWT_REFRESH_EXPIRY=2592000  # 30 days
      - APP_ENV=production
      - LOG_LEVEL=info
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - titotr_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: titotr_postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_INITDB_ARGS=--encoding=UTF-8 --lc-collate=ru_RU.UTF-8 --lc-ctype=ru_RU.UTF-8
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./database/init:/docker-entrypoint-initdb.d:ro
      - ./backups:/backups
    networks:
      - titotr_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Redis Cache & Sessions
  redis:
    image: redis:7-alpine
    container_name: titotr_redis
    restart: unless-stopped
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis_data:/data
    networks:
      - titotr_network
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "3"

  # Certbot –¥–ª—è SSL
  certbot:
    image: certbot/certbot:latest
    container_name: titotr_certbot
    volumes:
      - certbot-www:/var/www/certbot
      - certbot-conf:/etc/letsencrypt
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew --webroot -w /var/www/certbot --quiet; sleep 12h & wait $${!}; done;'"
    networks:
      - titotr_network

  # –ü–æ—Ä—Çainer (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è Docker —á–µ—Ä–µ–∑ UI)
  portainer:
    image: portainer/portainer-ce:latest
    container_name: titotr_portainer
    restart: unless-stopped
    ports:
      - "9443:9443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
    networks:
      - titotr_network
    command: --http-enabled

networks:
  titotr_network:
    driver: bridge
    name: titotr_network

volumes:
  postgres_data:
    name: titotr_postgres_data
  redis_data:
    name: titotr_redis_data
  certbot-www:
    name: titotr_certbot_www
  certbot-conf:
    name: titotr_certbot_conf
  portainer_data:
    name: titotr_portainer_data
```

**–§–∞–π–ª .env –¥–ª—è production:**

```bash
# Database
POSTGRES_USER=titotr_user
POSTGRES_PASSWORD=<STRONG_PASSWORD_32_CHARS>
POSTGRES_DB=titotr_production

# Redis
REDIS_PASSWORD=<REDIS_PASSWORD_32_CHARS>

# JWT
JWT_SECRET=<JWT_SECRET_64_CHARS>

# Email (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
SMTP_HOST=smtp.yandex.ru
SMTP_PORT=465
SMTP_USER=noreply@titotr.ru
SMTP_PASSWORD=<EMAIL_PASSWORD>
SMTP_FROM=Time to Travel <noreply@titotr.ru>

# Payment (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, YooKassa –∏–ª–∏ –¢–∏–Ω—å–∫–æ—Ñ—Ñ)
PAYMENT_PROVIDER=yookassa
PAYMENT_SHOP_ID=<SHOP_ID>
PAYMENT_SECRET_KEY=<PAYMENT_SECRET>

# App
APP_NAME=Time to Travel
APP_URL=https://titotr.ru
API_URL=https://titotr.ru/api
```

---

## üåê Nginx Configuration –¥–ª—è titotr.ru

### 10. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Nginx —Å SSL

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:**
```
nginx/
‚îú‚îÄ‚îÄ nginx.conf           # –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª
‚îî‚îÄ‚îÄ conf.d/
    ‚îú‚îÄ‚îÄ titotr.conf      # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è titotr.ru
    ‚îî‚îÄ‚îÄ ssl.conf         # SSL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
```

**nginx/nginx.conf:**

```nginx
user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 2048;
    use epoll;
    multi_accept on;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Logging
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for" '
                    'rt=$request_time uct="$upstream_connect_time" '
                    'uht="$upstream_header_time" urt="$upstream_response_time"';

    access_log /var/log/nginx/access.log main;

    # Performance
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    client_max_body_size 100M;
    client_body_buffer_size 128k;

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript
               application/json application/javascript application/xml+rss
               application/rss+xml font/truetype font/opentype
               application/vnd.ms-fontobject image/svg+xml;
    gzip_disable "msie6";

    # Security headers (–≥–ª–æ–±–∞–ª—å–Ω—ã–µ)
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # Rate limiting
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
    limit_req_zone $binary_remote_addr zone=auth_limit:10m rate=5r/m;

    # Upstream –¥–ª—è backend
    upstream backend_servers {
        least_conn;
        server backend:8080 max_fails=3 fail_timeout=30s;
        keepalive 32;
    }

    # –í–∫–ª—é—á–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å–∞–π—Ç–æ–≤
    include /etc/nginx/conf.d/*.conf;
}
```

**nginx/conf.d/titotr.conf:**

```nginx
# HTTP —Å–µ—Ä–≤–µ—Ä - —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ HTTPS
server {
    listen 80;
    listen [::]:80;
    server_name titotr.ru www.titotr.ru;

    # ACME challenge –¥–ª—è Let's Encrypt
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # Health check (–¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞)
    location /health {
        access_log off;
        return 200 "OK\n";
        add_header Content-Type text/plain;
    }

    # –†–µ–¥–∏—Ä–µ–∫—Ç –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ HTTPS
    location / {
        return 301 https://$host$request_uri;
    }
}

# HTTPS —Å–µ—Ä–≤–µ—Ä - –æ—Å–Ω–æ–≤–Ω–æ–π
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name titotr.ru www.titotr.ru;

    # SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã (–ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è —á–µ—Ä–µ–∑ certbot)
    ssl_certificate /etc/letsencrypt/live/titotr.ru/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/titotr.ru/privkey.pem;

    # SSL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (—Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ)
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384';
    ssl_prefer_server_ciphers off;
    
    # SSL session cache
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    ssl_session_tickets off;

    # OCSP Stapling
    ssl_stapling on;
    ssl_stapling_verify on;
    ssl_trusted_certificate /etc/letsencrypt/live/titotr.ru/chain.pem;
    resolver 8.8.8.8 8.8.4.4 valid=300s;
    resolver_timeout 5s;

    # Security headers –¥–ª—è HTTPS
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # Logs
    access_log /var/log/nginx/titotr_access.log main;
    error_log /var/log/nginx/titotr_error.log warn;

    # Health check
    location /health {
        access_log off;
        return 200 "OK\n";
        add_header Content-Type text/plain;
    }

    # API endpoints (Dart Frog backend)
    location /api {
        # Rate limiting
        limit_req zone=api_limit burst=20 nodelay;
        limit_req_status 429;

        # Proxy –∫ backend
        proxy_pass http://backend_servers;
        proxy_http_version 1.1;

        # Headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Request-ID $request_id;

        # Timeouts
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;

        # Buffering
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        proxy_busy_buffers_size 8k;

        # Keepalive
        proxy_set_header Connection "";
    }

    # –ë–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∏–π rate limit –¥–ª—è auth endpoints
    location /api/auth {
        limit_req zone=auth_limit burst=5 nodelay;
        limit_req_status 429;

        proxy_pass http://backend_servers;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã (–µ—Å–ª–∏ –±—É–¥—É—Ç)
    location /static/ {
        alias /var/www/static/;
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    # –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –∫–æ—Ä–Ω—è (–º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ Landing Page)
    location = / {
        return 200 '{"status":"ok","message":"Time to Travel API","version":"1.0.0"}';
        add_header Content-Type application/json;
    }

    # Favicon
    location = /favicon.ico {
        access_log off;
        log_not_found off;
        return 204;
    }

    # Robots.txt
    location = /robots.txt {
        access_log off;
        log_not_found off;
        return 200 "User-agent: *\nDisallow: /api/\n";
        add_header Content-Type text/plain;
    }
}
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –¥–ª—è titotr.ru:

```bash
# 1. –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ DNS –Ω–∞—Å—Ç—Ä–æ–µ–Ω (A-–∑–∞–ø–∏—Å—å titotr.ru ‚Üí IP —Å–µ—Ä–≤–µ—Ä–∞)
dig titotr.ru +short

# 2. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ nginx (–±–µ–∑ SSL –ø–æ–∫–∞)
docker compose up -d nginx

# 3. –ü–æ–ª—É—á–∏—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —á–µ—Ä–µ–∑ certbot
docker compose run --rm certbot certonly \
  --webroot \
  --webroot-path=/var/www/certbot \
  --email admin@titotr.ru \
  --agree-tos \
  --no-eff-email \
  --force-renewal \
  -d titotr.ru \
  -d www.titotr.ru

# 4. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å nginx —Å SSL
docker compose restart nginx

# 5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å SSL
curl -I https://titotr.ru/health

# 6. –¢–µ—Å—Ç SSL —Ä–µ–π—Ç–∏–Ω–≥–∞
# –û—Ç–∫—Ä—ã—Ç—å: https://www.ssllabs.com/ssltest/analyze.html?d=titotr.ru
```

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞:**

–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã Let's Encrypt –¥–µ–π—Å—Ç–≤—É—é—Ç 90 –¥–Ω–µ–π. –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä `certbot` –≤ docker-compose –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –∏—Ö –∫–∞–∂–¥—ã–µ 12 —á–∞—Å–æ–≤.

–ú–æ–∂–Ω–æ —Ç–∞–∫–∂–µ –¥–æ–±–∞–≤–∏—Ç—å cron job:

```bash
# –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å crontab
crontab -e

# –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É (–ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 3:00)
0 3 * * * cd /opt/titotr && docker compose run --rm certbot renew --quiet && docker compose restart nginx
```

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è

### 4. Docker Compose Stack

**–û—Å–Ω–æ–≤–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã:**

1. **Nginx** (Reverse Proxy + SSL)
   - –ü–æ—Ä—Ç—ã: 80 (HTTP), 443 (HTTPS)
   - SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã —á–µ—Ä–µ–∑ Let's Encrypt
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ HTTP ‚Üí HTTPS

2. **Backend API** (Dart/Frog, Node.js, –∏–ª–∏ –¥—Ä—É–≥–æ–π)
   - –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ø–æ—Ä—Ç: 8080
   - Health checks
   - Automatic restart

3. **Frontend Website** (Next.js, React, –∏–ª–∏ –¥—Ä—É–≥–æ–π)
   - –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ø–æ—Ä—Ç: 3000
   - Static file serving
   - Volume mounts –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–µ–ø–ª–æ—è

4. **PostgreSQL Database**
   - –í–µ—Ä—Å–∏—è: 15-alpine
   - Persistent volume –¥–ª—è –¥–∞–Ω–Ω—ã—Ö
   - –†–µ–≥—É–ª—è—Ä–Ω—ã–µ –±—ç–∫–∞–ø—ã

5. **Redis Cache** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
   - –í–µ—Ä—Å–∏—è: 7-alpine
   - –î–ª—è —Å–µ—Å—Å–∏–π –∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è

**–ü—Ä–∏–º–µ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—ã `docker-compose.yml`:**
```yaml
version: '3.8'

services:
  nginx:
    image: nginx:alpine
    container_name: app_nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - certbot-www:/var/www/certbot
      - certbot-conf:/etc/letsencrypt
    depends_on:
      - backend
      - website
    networks:
      - app_network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: app_backend
    restart: unless-stopped
    environment:
      - DATABASE_URL=postgresql://user:password@postgres:5432/dbname
      - REDIS_URL=redis://redis:6379
      - JWT_SECRET=${JWT_SECRET}
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - app_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  website:
    build:
      context: ./website
      dockerfile: Dockerfile
    container_name: app_website
    restart: unless-stopped
    volumes:
      - ./website/public:/app/public  # –î–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–µ–ø–ª–æ—è —Å—Ç–∞—Ç–∏–∫–∏
    networks:
      - app_network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3

  postgres:
    image: postgres:15-alpine
    container_name: app_postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./database/init:/docker-entrypoint-initdb.d
    networks:
      - app_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: app_redis
    restart: unless-stopped
    volumes:
      - redis_data:/data
    networks:
      - app_network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  certbot:
    image: certbot/certbot
    container_name: app_certbot
    volumes:
      - certbot-www:/var/www/certbot
      - certbot-conf:/etc/letsencrypt
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"

networks:
  app_network:
    driver: bridge

volumes:
  postgres_data:
  redis_data:
  certbot-www:
  certbot-conf:
```

---

## üåê Nginx –∏ SSL

### 5. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Reverse Proxy –∏ SSL

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:**
```
nginx/
‚îú‚îÄ‚îÄ nginx.conf           # –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥
‚îú‚îÄ‚îÄ ssl/                 # SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã
‚îî‚îÄ‚îÄ conf.d/
    ‚îú‚îÄ‚îÄ default.conf     # –î–µ—Ñ–æ–ª—Ç–Ω—ã–π —Å–µ—Ä–≤–µ—Ä
    ‚îú‚îÄ‚îÄ api.conf         # Backend API
    ‚îî‚îÄ‚îÄ website.conf     # Frontend website
```

**–ü—Ä–∏–º–µ—Ä `nginx.conf`:**
```nginx
user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    client_max_body_size 100M;

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript 
               application/json application/javascript application/xml+rss 
               application/rss+xml font/truetype font/opentype 
               application/vnd.ms-fontobject image/svg+xml;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;

    # Include server configs
    include /etc/nginx/conf.d/*.conf;
}
```

**–ü—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥–∞ –¥–ª—è website:**
```nginx
server {
    listen 80;
    server_name yourdomain.com www.yourdomain.com;

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        return 301 https://$host$request_uri;
    }
}

server {
    listen 443 ssl http2;
    server_name yourdomain.com www.yourdomain.com;

    ssl_certificate /etc/letsencrypt/live/yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/yourdomain.com/privkey.pem;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    location / {
        proxy_pass http://website:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /api {
        proxy_pass http://backend:8080;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

**–ü–æ–ª—É—á–µ–Ω–∏–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞:**
```bash
# –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ (—Ç–æ–ª—å–∫–æ HTTP)
docker compose up -d nginx

# –ü–æ–ª—É—á–∏—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
docker compose run --rm certbot certonly \
  --webroot \
  --webroot-path=/var/www/certbot \
  -d yourdomain.com \
  -d www.yourdomain.com \
  --email your_email@example.com \
  --agree-tos \
  --no-eff-email

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å nginx —Å HTTPS
docker compose restart nginx
```

---

## üì¶ –°–∏—Å—Ç–µ–º–∞ –î–µ–ø–ª–æ—è

### 6. –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –î–µ–ø–ª–æ—è —á–µ—Ä–µ–∑ SSH

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–∫—Ä–∏–ø—Ç–æ–≤ –¥–µ–ø–ª–æ—è:**
```
scripts/
‚îú‚îÄ‚îÄ deploy.sh              # –û—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç –¥–µ–ø–ª–æ—è
‚îú‚îÄ‚îÄ deploy_backend.sh      # –î–µ–ø–ª–æ–π —Ç–æ–ª—å–∫–æ backend
‚îú‚îÄ‚îÄ deploy_website.sh      # –î–µ–ø–ª–æ–π —Ç–æ–ª—å–∫–æ website
‚îú‚îÄ‚îÄ backup_db.sh           # –ë—ç–∫–∞–ø –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
‚îú‚îÄ‚îÄ restore_db.sh          # –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ë–î
‚îî‚îÄ‚îÄ setup_server.sh        # –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
```

**–ü—Ä–∏–º–µ—Ä `deploy.sh`:**
```bash
#!/bin/bash

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
SERVER_USER="deploy_user"
SERVER_HOST="yourdomain.com"
SERVER_PORT="2222"
DEPLOY_PATH="/opt/app"

echo "üöÄ –î–µ–ø–ª–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–∞ production —Å–µ—Ä–≤–µ—Ä..."

# –ü—Ä–æ–≤–µ—Ä–∫–∞ SSH —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
echo "‚û°Ô∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ SSH —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è..."
ssh -p $SERVER_PORT $SERVER_USER@$SERVER_HOST "echo '‚úÖ SSH —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ'" || exit 1

# –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤
echo "‚û°Ô∏è –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤..."
rsync -avz --delete \
  --exclude 'node_modules' \
  --exclude '.git' \
  --exclude '.env.local' \
  --exclude 'build' \
  -e "ssh -p $SERVER_PORT" \
  ./ $SERVER_USER@$SERVER_HOST:$DEPLOY_PATH/

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ .env —Ñ–∞–π–ª–∞
echo "‚û°Ô∏è –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ .env —Ñ–∞–π–ª–∞..."
scp -P $SERVER_PORT .env.production $SERVER_USER@$SERVER_HOST:$DEPLOY_PATH/.env

# –î–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
echo "‚û°Ô∏è –ó–∞–ø—É—Å–∫ –¥–µ–ø–ª–æ—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."
ssh -p $SERVER_PORT $SERVER_USER@$SERVER_HOST << 'EOF'
cd /opt/app

# –°–æ–∑–¥–∞—Ç—å –±—ç–∫–∞–ø –ë–î –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
echo "üì¶ –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
docker compose exec -T postgres pg_dump -U $POSTGRES_USER $POSTGRES_DB > backup_$(date +%Y%m%d_%H%M%S).sql

# –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
echo "üî® –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–æ–≤..."
docker compose build --no-cache

echo "‚ôªÔ∏è –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
docker compose up -d

# –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞
echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤..."
sleep 10

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
echo "üìä –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:"
docker compose ps

# Health check
echo "üè• –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–µ—Ä–≤–∏—Å–æ–≤..."
curl -f http://localhost/health || echo "‚ö†Ô∏è Health check failed"

EOF

echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"
echo "üåê –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–∞–π—Ç: https://yourdomain.com"
```

**–ü—Ä–∏–º–µ—Ä `deploy_website.sh` (–±—ã—Å—Ç—Ä—ã–π –¥–µ–ø–ª–æ–π —Ç–æ–ª—å–∫–æ —Å–∞–π—Ç–∞):**
```bash
#!/bin/bash

SERVER_USER="deploy_user"
SERVER_HOST="yourdomain.com"
SERVER_PORT="2222"

echo "üöÄ –ë—ã—Å—Ç—Ä—ã–π –¥–µ–ø–ª–æ–π website..."

# –°–±–æ—Ä–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ
echo "üî® –°–±–æ—Ä–∫–∞ Next.js –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
cd website
npm run build

# –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
echo "‚û°Ô∏è –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."
rsync -avz --delete \
  -e "ssh -p $SERVER_PORT" \
  .next/ $SERVER_USER@$SERVER_HOST:/opt/app/website/.next/

rsync -avz --delete \
  -e "ssh -p $SERVER_PORT" \
  public/ $SERVER_USER@$SERVER_HOST:/opt/app/website/public/

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
echo "‚ôªÔ∏è –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ website –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
ssh -p $SERVER_PORT $SERVER_USER@$SERVER_HOST "cd /opt/app && docker compose restart website"

echo "‚úÖ –î–µ–ø–ª–æ–π website –∑–∞–≤–µ—Ä—à–µ–Ω!"
```

**–ü—Ä–∏–º–µ—Ä `backup_db.sh`:**
```bash
#!/bin/bash

SERVER_USER="deploy_user"
SERVER_HOST="yourdomain.com"
SERVER_PORT="2222"
BACKUP_DIR="./backups"

mkdir -p $BACKUP_DIR

BACKUP_FILE="backup_$(date +%Y%m%d_%H%M%S).sql"

echo "üì¶ –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."

ssh -p $SERVER_PORT $SERVER_USER@$SERVER_HOST \
  "cd /opt/app && docker compose exec -T postgres pg_dump -U \$POSTGRES_USER \$POSTGRES_DB" \
  > $BACKUP_DIR/$BACKUP_FILE

gzip $BACKUP_DIR/$BACKUP_FILE

echo "‚úÖ –ë—ç–∫–∞–ø —Å–æ–∑–¥–∞–Ω: $BACKUP_DIR/$BACKUP_FILE.gz"
```

---

## üîß –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### 7. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

**–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:**

1. **Docker Stats** (–≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π)
```bash
docker stats
```

2. **Portainer** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ - UI –¥–ª—è Docker)
```yaml
# –î–æ–±–∞–≤–∏—Ç—å –≤ docker-compose.yml
portainer:
  image: portainer/portainer-ce:latest
  container_name: portainer
  restart: unless-stopped
  ports:
    - "9000:9000"
  volumes:
    - /var/run/docker.sock:/var/run/docker.sock
    - portainer_data:/data
```

3. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**
```bash
# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
docker compose logs -f backend

# –†–æ—Ç–∞—Ü–∏—è –ª–æ–≥–æ–≤ (–¥–æ–±–∞–≤–∏—Ç—å –≤ docker-compose.yml)
logging:
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"
```

4. **Uptime Kuma** (–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏)
```yaml
uptime-kuma:
  image: louislam/uptime-kuma:1
  container_name: uptime_kuma
  restart: unless-stopped
  ports:
    - "3001:3001"
  volumes:
    - uptime_kuma_data:/app/data
```

---

## üî• Firewall –∏ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### 8. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ UFW

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å UFW
sudo apt install -y ufw

# –†–∞–∑—Ä–µ—à–∏—Ç—å SSH (–∫–∞—Å—Ç–æ–º–Ω—ã–π –ø–æ—Ä—Ç)
sudo ufw allow 2222/tcp

# –†–∞–∑—Ä–µ—à–∏—Ç—å HTTP –∏ HTTPS
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# –ó–∞–ø—Ä–µ—Ç–∏—Ç—å –≤—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
sudo ufw default deny incoming
sudo ufw default allow outgoing

# –í–∫–ª—é—á–∏—Ç—å firewall
sudo ufw enable

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
sudo ufw status verbose
```

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Fail2Ban:**
```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å fail2ban
sudo apt install -y fail2ban

# –°–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥
sudo nano /etc/fail2ban/jail.local
```

**–§–∞–π–ª `/etc/fail2ban/jail.local`:**
```ini
[DEFAULT]
bantime = 3600
findtime = 600
maxretry = 5

[sshd]
enabled = true
port = 2222
logpath = /var/log/auth.log

[nginx-http-auth]
enabled = true
port = http,https
logpath = /var/log/nginx/error.log
```

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å fail2ban
sudo systemctl enable fail2ban
sudo systemctl start fail2ban
```

---

## üìù Environment Variables

### 9. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –°–µ–∫—Ä–µ—Ç–∞–º–∏

**–°–æ–∑–¥–∞—Ç—å `.env` —Ñ–∞–π–ª –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:**
```bash
# Database
POSTGRES_USER=app_user
POSTGRES_PASSWORD=<STRONG_PASSWORD_HERE>
POSTGRES_DB=app_database

# JWT
JWT_SECRET=<RANDOM_SECRET_KEY>

# S3/Storage (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
S3_ENDPOINT=https://s3.storage.selectel.ru
S3_ACCESS_KEY=<ACCESS_KEY>
S3_SECRET_KEY=<SECRET_KEY>
S3_BUCKET_NAME=app-storage

# Redis
REDIS_URL=redis://redis:6379

# Email (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
SMTP_HOST=smtp.example.com
SMTP_PORT=587
SMTP_USER=noreply@yourdomain.com
SMTP_PASSWORD=<EMAIL_PASSWORD>

# App
NODE_ENV=production
API_URL=https://yourdomain.com/api
```

**‚ö†Ô∏è –í–ê–ñ–ù–û:**
- –ù–ï –∫–æ–º–º–∏—Ç–∏—Ç—å `.env` –≤ Git
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `.env.example` –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
- –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–∏–ª—å–Ω—ã–µ –ø–∞—Ä–æ–ª–∏ (–º–∏–Ω–∏–º—É–º 32 —Å–∏–º–≤–æ–ª–∞)
- –†–µ–≥—É–ª—è—Ä–Ω–æ —Ä–æ—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–µ–∫—Ä–µ—Ç—ã

---

## üóÇÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ü—Ä–æ–µ–∫—Ç–∞ –Ω–∞ –°–µ—Ä–≤–µ—Ä–µ

```
/opt/app/
‚îú‚îÄ‚îÄ docker-compose.yml
‚îú‚îÄ‚îÄ .env
‚îú‚îÄ‚îÄ nginx/
‚îÇ   ‚îú‚îÄ‚îÄ nginx.conf
‚îÇ   ‚îî‚îÄ‚îÄ conf.d/
‚îÇ       ‚îú‚îÄ‚îÄ api.conf
‚îÇ       ‚îî‚îÄ‚îÄ website.conf
‚îú‚îÄ‚îÄ backend/
‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ   ‚îú‚îÄ‚îÄ pubspec.yaml
‚îÇ   ‚îî‚îÄ‚îÄ lib/
‚îú‚îÄ‚îÄ website/
‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ   ‚îú‚îÄ‚îÄ package.json
‚îÇ   ‚îî‚îÄ‚îÄ public/
‚îú‚îÄ‚îÄ database/
‚îÇ   ‚îî‚îÄ‚îÄ init/
‚îÇ       ‚îî‚îÄ‚îÄ 01-init.sql
‚îú‚îÄ‚îÄ backups/
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îú‚îÄ‚îÄ backup.sh
‚îÇ   ‚îî‚îÄ‚îÄ restore.sh
‚îî‚îÄ‚îÄ logs/
```

---

## üìã –ß–µ–∫-–ª–∏—Å—Ç –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–π –ù–∞—Å—Ç—Ä–æ–π–∫–∏

### –®–∞–≥ 1: –ê—Ä–µ–Ω–¥–∞ –°–µ—Ä–≤–µ—Ä–∞
- [ ] –ê—Ä–µ–Ω–¥–æ–≤–∞—Ç—å VPS –Ω–∞ Selectel
- [ ] –í—ã–±—Ä–∞—Ç—å Ubuntu 22.04 LTS
- [ ] –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π IP –∞–¥—Ä–µ—Å
- [ ] –°–æ—Ö—Ä–∞–Ω–∏—Ç—å root –ø–∞—Ä–æ–ª—å

### –®–∞–≥ 2: –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- [ ] –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–µ root)
- [ ] –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å SSH-–∫–ª—é—á–∏
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å SSH (–æ—Ç–∫–ª—é—á–∏—Ç—å –ø–∞—Ä–æ–ª–∏, —Å–º–µ–Ω–∏—Ç—å –ø–æ—Ä—Ç)
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å UFW firewall
- [ ] –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å fail2ban
- [ ] –û–±–Ω–æ–≤–∏—Ç—å —Å–∏—Å—Ç–µ–º—É: `sudo apt update && sudo apt upgrade -y`

### –®–∞–≥ 3: Docker
- [ ] –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Docker Engine
- [ ] –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Docker Compose
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –≥—Ä—É–ø–ø—É docker
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫—É: `docker --version`

### –®–∞–≥ 4: –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
- [ ] –°–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é `/opt/app`
- [ ] –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å `.env` —Ñ–∞–π–ª
- [ ] –°–æ–∑–¥–∞—Ç—å `docker-compose.yml`

### –®–∞–≥ 5: Nginx –∏ SSL
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
- [ ] –£–∫–∞–∑–∞—Ç—å A-–∑–∞–ø–∏—Å—å –¥–æ–º–µ–Ω–∞ –Ω–∞ IP —Å–µ—Ä–≤–µ—Ä–∞
- [ ] –ü–æ–ª—É—á–∏—Ç—å SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —á–µ—Ä–µ–∑ Certbot
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞

### –®–∞–≥ 6: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- [ ] –°–æ–∑–¥–∞—Ç—å init —Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è PostgreSQL
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å volume –¥–ª—è persistence
- [ ] –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–π –±—ç–∫–∞–ø

### –®–∞–≥ 7: –î–µ–ø–ª–æ–π
- [ ] –°–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç—ã –¥–µ–ø–ª–æ—è
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–µ–ø–ª–æ–π
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –±—ç–∫–∞–ø—ã (cron)

### –®–∞–≥ 8: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- [ ] –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Portainer (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å health checks
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Uptime monitoring

---

## üö® Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
docker compose logs -f <service_name>

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
docker compose ps

# –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
docker compose up -d --force-recreate <service_name>
```

### –ü—Ä–æ–±–ª–µ–º–∞: SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å certbot
docker compose logs -f certbot

# –í—Ä—É—á–Ω—É—é –æ–±–Ω–æ–≤–∏—Ç—å
docker compose run --rm certbot renew

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å nginx
docker compose restart nginx
```

### –ü—Ä–æ–±–ª–µ–º–∞: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å PostgreSQL
docker compose exec postgres pg_isready -U app_user

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
docker compose logs -f postgres

# –í–æ–π—Ç–∏ –≤ –±–∞–∑—É
docker compose exec postgres psql -U app_user -d app_database
```

### –ü—Ä–æ–±–ª–µ–º–∞: –ù–µ—Ö–≤–∞—Ç–∞–µ—Ç –º–µ—Å—Ç–∞ –Ω–∞ –¥–∏—Å–∫–µ
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
df -h

# –û—á–∏—Å—Ç–∏—Ç—å –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ Docker –æ–±—Ä–∞–∑—ã
docker system prune -a

# –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏
docker compose logs --tail=0 -f backend > /dev/null
```

---

## üìä –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ

### –ï–∂–µ–¥–Ω–µ–≤–Ω–æ
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ –Ω–∞ –æ—à–∏–±–∫–∏
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤

### –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ
- –ë—ç–∫–∞–ø –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### –ï–∂–µ–º–µ—Å—è—á–Ω–æ
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã: `sudo apt update && sudo apt upgrade -y`
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Docker –æ–±—Ä–∞–∑–æ–≤
- –†–æ—Ç–∞—Ü–∏—è —Å—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤
- –ü—Ä–æ–≤–µ—Ä–∫–∞ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤

### –ï–∂–µ–∫–≤–∞—Ä—Ç–∞–ª—å–Ω–æ
- –ê—É–¥–∏—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è

---

## üìö –ü–æ–ª–µ–∑–Ω—ã–µ –ö–æ–º–∞–Ω–¥—ã

### Docker
```bash
# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
docker compose logs -f

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
docker compose restart

# –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–æ–≤
docker compose build --no-cache

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
docker compose down

# –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö (–û–ü–ê–°–ù–û!)
docker compose down -v
```

### PostgreSQL
```bash
# –ë—ç–∫–∞–ø
docker compose exec postgres pg_dump -U user dbname > backup.sql

# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
docker compose exec -T postgres psql -U user dbname < backup.sql

# –í–æ–π—Ç–∏ –≤ psql
docker compose exec postgres psql -U user -d dbname
```

### Nginx
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
docker compose exec nginx nginx -t

# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
docker compose exec nginx nginx -s reload
```

### –°–∏—Å—Ç–µ–º–Ω—ã–µ
```bash
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∏—Å–∫–∞
df -h
du -sh /opt/app/*

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ RAM
free -h

# –ü—Ä–æ—Ü–µ—Å—Å—ã
top
htop

# –°–µ—Ç–µ–≤—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
netstat -tulpn
```

---

## ÔøΩ Selectel S3 Storage

### 11. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—ä–µ–∫—Ç–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ (–∑–∞–º–µ–Ω–∞ Firebase Storage)

**Firebase Storage ‚Üí Selectel S3**

Selectel –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç S3-—Å–æ–≤–º–µ—Å—Ç–∏–º–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è —Ñ–∞–π–ª–æ–≤ (–∞–≤–∞—Ç–∞—Ä—ã, –¥–æ–∫—É–º–µ–Ω—Ç—ã, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è).

#### –°–æ–∑–¥–∞–Ω–∏–µ S3 bucket –Ω–∞ Selectel:

1. –í–æ–π—Ç–∏ –≤ –ø–∞–Ω–µ–ª—å Selectel
2. –ü–µ—Ä–µ–π—Ç–∏ –≤ —Ä–∞–∑–¥–µ–ª "–û–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ" (S3)
3. –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä `titotr-storage`
4. –ü–æ–ª—É—á–∏—Ç—å API –∫–ª—é—á–∏ (Access Key + Secret Key)

**Endpoint:** `https://s3.storage.selcloud.ru`

#### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ Dart Frog:

```dart
// lib/services/storage_service.dart

import 'package:minio/minio.dart';
import 'package:uuid/uuid.dart';

class StorageService {
  final Minio _client;
  final String _bucketName;

  StorageService({
    required String endpoint,
    required String accessKey,
    required String secretKey,
    required String bucketName,
  })  : _bucketName = bucketName,
        _client = Minio(
          endPoint: endpoint.replaceAll('https://', ''),
          accessKey: accessKey,
          secretKey: secretKey,
          useSSL: true,
          region: 'ru-1',
        );

  // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª
  Future<String> uploadFile({
    required List<int> fileBytes,
    required String fileName,
    String? contentType,
    String folder = 'uploads',
  }) async {
    // –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞
    final uuid = Uuid().v4();
    final extension = fileName.split('.').last;
    final uniqueFileName = '$uuid.$extension';
    final objectName = '$folder/$uniqueFileName';

    // –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤ S3
    await _client.putObject(
      _bucketName,
      objectName,
      Stream.value(fileBytes),
      fileBytes.length,
      contentType: contentType,
    );

    // –í–µ—Ä–Ω—É—Ç—å –ø—É–±–ª–∏—á–Ω—ã–π URL
    return 'https://s3.storage.selcloud.ru/$_bucketName/$objectName';
  }

  // –ü–æ–ª—É—á–∏—Ç—å —Ñ–∞–π–ª
  Future<List<int>> getFile(String objectName) async {
    final stream = await _client.getObject(_bucketName, objectName);
    return await stream.expand((chunk) => chunk).toList();
  }

  // –£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª
  Future<void> deleteFile(String objectName) async {
    await _client.removeObject(_bucketName, objectName);
  }

  // –ü–æ–ª—É—á–∏—Ç—å presigned URL (–≤—Ä–µ–º–µ–Ω–Ω–∞—è —Å—Å—ã–ª–∫–∞)
  Future<String> getPresignedUrl(
    String objectName, {
    Duration expiry = const Duration(hours: 1),
  }) async {
    return await _client.presignedGetObject(
      _bucketName,
      objectName,
      expires: expiry.inSeconds,
    );
  }
}
```

#### –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ route:

```dart
// routes/users/avatar.dart

import 'dart:io';
import 'package:dart_frog/dart_frog.dart';

// POST /api/users/avatar - –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞–≤–∞—Ç–∞—Ä
Future<Response> onRequest(RequestContext context) async {
  if (context.request.method != HttpMethod.post) {
    return Response(statusCode: HttpStatus.methodNotAllowed);
  }

  final user = context.read<User>();
  final storageService = context.read<StorageService>();

  // –ü–æ–ª—É—á–∏—Ç—å —Ñ–∞–π–ª –∏–∑ multipart form data
  final formData = await context.request.formData();
  final file = formData.files['avatar'];

  if (file == null) {
    return Response.json(
      statusCode: HttpStatus.badRequest,
      body: {'error': 'No file provided'},
    );
  }

  // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–∑–º–µ—Ä (–º–∞–∫—Å 5MB)
  if (file.bytes.length > 5 * 1024 * 1024) {
    return Response.json(
      statusCode: HttpStatus.badRequest,
      body: {'error': 'File too large (max 5MB)'},
    );
  }

  // –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤ S3
  final avatarUrl = await storageService.uploadFile(
    fileBytes: file.bytes,
    fileName: file.name,
    contentType: file.contentType.toString(),
    folder: 'avatars',
  );

  // –û–±–Ω–æ–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î
  final db = context.read<DatabaseService>();
  await db.execute(
    'UPDATE users SET avatar_url = @url WHERE id = @id',
    parameters: {'url': avatarUrl, 'id': user.id},
  );

  return Response.json(
    body: {'avatar_url': avatarUrl},
  );
}
```

---

<!--
## Selectel S3 Storage - –ù–ï –¢–†–ï–ë–£–ï–¢–°–Ø

–í–ê–ñ–ù–û: –î–∞–Ω–Ω–∞—è —Å–µ–∫—Ü–∏—è –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞, —Ç–∞–∫ –∫–∞–∫ –ø—Ä–æ–µ–∫—Ç Time to Travel 
—Ä–∞–±–æ—Ç–∞–µ—Ç –¢–û–õ–¨–ö–û —Å —Ç–µ–∫—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ (–∑–∞—è–≤–∫–∏ –Ω–∞ –ø–æ–µ–∑–¥–∫–∏, –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö, –º–∞—Ä—à—Ä—É—Ç—ã).
–§–∞–π–ª–æ–≤–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ S3 –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è. –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ PostgreSQL.

–ï—Å–ª–∏ –≤ –±—É–¥—É—â–µ–º –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ (—Ñ–æ—Ç–æ –≤–æ–¥–∏—Ç–µ–ª–µ–π, –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏ —Ç.–¥.),
—ç—Ç—É —Å–µ–∫—Ü–∏—é –º–æ–∂–Ω–æ —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å Selectel S3.
-->

---

## üîÑ –ú–∏–≥—Ä–∞—Ü–∏—è –î–∞–Ω–Ω—ã—Ö –∏–∑ Firebase

### 11. –ü–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ü—Ä–æ–µ–∫—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å —Ç–µ–∫—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏. –§–∞–π–ª–æ–≤–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è.

#### –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –∏–∑ Firebase:

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Firebase CLI
npm install -g firebase-tools

# –í–æ–π—Ç–∏
firebase login

# –≠–∫—Å–ø–æ—Ä—Ç Firestore –¥–∞–Ω–Ω—ã—Ö
firebase firestore:export gs://your-project.appspot.com/firestore-export

# –°–∫–∞—á–∞—Ç—å —ç–∫—Å–ø–æ—Ä—Ç –ª–æ–∫–∞–ª—å–Ω–æ
gsutil -m cp -r gs://your-project.appspot.com/firestore-export ./firebase-export
```

#### –°–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ Firestore ‚Üí PostgreSQL:

```dart
// tools/migrate_firebase.dart

import 'dart:io';
import 'dart:convert';
import 'package:postgres/postgres.dart';

void main() async {
  // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL
  final connection = await Connection.open(
    Endpoint(
      host: 'localhost',
      database: 'titotr_production',
      username: 'titotr_user',
      password: 'password',
    ),
  );

  // –ß–∏—Ç–∞—Ç—å —ç–∫—Å–ø–æ—Ä—Ç Firestore
  final usersFile = File('./firebase-export/users.json');
  final usersJson = jsonDecode(await usersFile.readAsString());

  // –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  for (final userData in usersJson) {
    await connection.execute(
      '''
      INSERT INTO users (id, email, name, phone, created_at)
      VALUES (@id, @email, @name, @phone, @created_at)
      ON CONFLICT (id) DO NOTHING
      ''',
      parameters: {
        'id': userData['uid'],
        'email': userData['email'],
        'name': userData['displayName'] ?? '',
        'phone': userData['phoneNumber'],
        'created_at': DateTime.parse(userData['metadata']['creationTime']),
      },
    );
  }

  print('‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!');
  await connection.close();
}
```

**–ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–∏:**
```bash
dart run tools/migrate_firebase.dart
```

---

## üì¶ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –î–µ–ø–ª–æ—è

### 13. –°–∫—Ä–∏–ø—Ç—ã –¥–µ–ø–ª–æ—è –¥–ª—è Time to Travel

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```
scripts/
‚îú‚îÄ‚îÄ deploy.sh              # –ü–æ–ª–Ω—ã–π –¥–µ–ø–ª–æ–π
‚îú‚îÄ‚îÄ deploy_backend.sh      # –¢–æ–ª—å–∫–æ backend
‚îú‚îÄ‚îÄ backup_db.sh           # –ë—ç–∫–∞–ø –ë–î
‚îú‚îÄ‚îÄ restore_db.sh          # –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
‚îú‚îÄ‚îÄ setup_server.sh        # –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
‚îî‚îÄ‚îÄ ssl_renew.sh           # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ SSL
```

**scripts/deploy.sh:**

```bash
#!/bin/bash

set -e  # –í—ã—Ö–æ–¥ –ø—Ä–∏ –æ—à–∏–±–∫–µ

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
SERVER_HOST="titotr.ru"
SERVER_PORT="2222"
SERVER_USER="deploy"
DEPLOY_PATH="/opt/titotr"
BACKUP_PATH="./backups"

echo "üöÄ –î–µ–ø–ª–æ–π Time to Travel –Ω–∞ production..."

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# –ü—Ä–æ–≤–µ—Ä–∫–∞ SSH
echo -e "${YELLOW}‚û°Ô∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ SSH —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è...${NC}"
if ! ssh -p $SERVER_PORT $SERVER_USER@$SERVER_HOST "echo 'SSH OK'"; then
    echo -e "${RED}‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É${NC}"
    exit 1
fi
echo -e "${GREEN}‚úÖ SSH —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ${NC}"

# –°–æ–∑–¥–∞—Ç—å –±—ç–∫–∞–ø –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º
echo -e "${YELLOW}‚û°Ô∏è –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...${NC}"
./scripts/backup_db.sh

# –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤
echo -e "${YELLOW}‚û°Ô∏è –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä...${NC}"
rsync -avz --delete \
  --exclude '.git' \
  --exclude 'node_modules' \
  --exclude '.dart_tool' \
  --exclude 'build' \
  --exclude '.env.local' \
  --exclude 'backups' \
  --exclude '*.md' \
  -e "ssh -p $SERVER_PORT" \
  ./backend \
  ./database \
  ./nginx \
  ./docker-compose.yml \
  $SERVER_USER@$SERVER_HOST:$DEPLOY_PATH/

# –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å .env
echo -e "${YELLOW}‚û°Ô∏è –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ .env —Ñ–∞–π–ª–∞...${NC}"
scp -P $SERVER_PORT .env.production $SERVER_USER@$SERVER_HOST:$DEPLOY_PATH/.env

# –î–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
echo -e "${YELLOW}‚û°Ô∏è –ó–∞–ø—É—Å–∫ –¥–µ–ø–ª–æ—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ...${NC}"
ssh -p $SERVER_PORT $SERVER_USER@$SERVER_HOST << 'ENDSSH'
cd /opt/titotr

# –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
export $(cat .env | xargs)

echo "üì¶ –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
docker compose down

echo "üî® –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–æ–≤..."
docker compose build --no-cache backend

echo "üöÄ –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
docker compose up -d

echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤ (30 —Å–µ–∫)..."
sleep 30

echo "üìä –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:"
docker compose ps

echo "üè• Health check..."
if curl -f https://titotr.ru/api/health; then
    echo "‚úÖ Backend —Ä–∞–±–æ—Ç–∞–µ—Ç!"
else
    echo "‚ö†Ô∏è Backend –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç!"
    docker compose logs backend
    exit 1
fi

echo "üßπ –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –æ–±—Ä–∞–∑–æ–≤..."
docker image prune -f

ENDSSH

echo -e "${GREEN}‚úÖ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!${NC}"
echo -e "${GREEN}üåê –ü—Ä–æ–≤–µ—Ä—å—Ç–µ: https://titotr.ru/api/health${NC}"
```

**scripts/backup_db.sh:**

```bash
#!/bin/bash

set -e

SERVER_HOST="titotr.ru"
SERVER_PORT="2222"
SERVER_USER="deploy"
BACKUP_DIR="./backups/postgres"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="titotr_backup_${TIMESTAMP}.sql"

mkdir -p $BACKUP_DIR

echo "üì¶ –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."

ssh -p $SERVER_PORT $SERVER_USER@$SERVER_HOST \
  "cd /opt/titotr && docker compose exec -T postgres pg_dump -U titotr_user titotr_production" \
  > $BACKUP_DIR/$BACKUP_FILE

# –°–∂–∞—Ç—å –±—ç–∫–∞–ø
gzip $BACKUP_DIR/$BACKUP_FILE

echo "‚úÖ –ë—ç–∫–∞–ø —Å–æ–∑–¥–∞–Ω: $BACKUP_DIR/$BACKUP_FILE.gz"

# –£–¥–∞–ª–∏—Ç—å –±—ç–∫–∞–ø—ã —Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π
find $BACKUP_DIR -name "*.gz" -mtime +30 -delete

# –ü–æ–∫–∞–∑–∞—Ç—å —Ä–∞–∑–º–µ—Ä
du -h $BACKUP_DIR/$BACKUP_FILE.gz
```

**scripts/setup_server.sh** (–ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞):

```bash
#!/bin/bash

set -e

SERVER_IP=$1

if [ -z "$SERVER_IP" ]; then
    echo "Usage: ./scripts/setup_server.sh <SERVER_IP>"
    exit 1
fi

echo "üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ Time to Travel –Ω–∞ $SERVER_IP..."

# 1. –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è deploy
ssh root@$SERVER_IP << 'ENDSSH'
# –û–±–Ω–æ–≤–∏—Ç—å —Å–∏—Å—Ç–µ–º—É
apt update && apt upgrade -y

# –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è deploy
useradd -m -s /bin/bash -G sudo deploy

# –ù–∞—Å—Ç—Ä–æ–∏—Ç—å SSH –¥–ª—è deploy
mkdir -p /home/deploy/.ssh
chmod 700 /home/deploy/.ssh
chown deploy:deploy /home/deploy/.ssh

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∞–∑–æ–≤—ã–µ —É—Ç–∏–ª–∏—Ç—ã
apt install -y curl wget git htop nano ufw fail2ban

echo "‚úÖ –ë–∞–∑–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞"
ENDSSH

# 2. –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å SSH –∫–ª—é—á
echo "üìã –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ SSH –∫–ª—é—á–∞..."
ssh-copy-id -i ~/.ssh/id_ed25519_titotr.pub deploy@$SERVER_IP

# 3. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å UFW firewall
ssh deploy@$SERVER_IP << 'ENDSSH'
# –†–∞–∑—Ä–µ—à–∏—Ç—å SSH (–≤—Ä–µ–º–µ–Ω–Ω–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–æ—Ä—Ç)
sudo ufw allow 22/tcp
sudo ufw allow 2222/tcp  # –ù–æ–≤—ã–π –ø–æ—Ä—Ç SSH
sudo ufw allow 80/tcp    # HTTP
sudo ufw allow 443/tcp   # HTTPS

# –í–∫–ª—é—á–∏—Ç—å firewall
sudo ufw --force enable

echo "‚úÖ Firewall –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
ENDSSH

# 4. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Docker
ssh deploy@$SERVER_IP << 'ENDSSH'
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –≥—Ä—É–ø–ø—É docker
sudo usermod -aG docker deploy

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Docker Compose
sudo apt install -y docker-compose-plugin

echo "‚úÖ Docker —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
ENDSSH

# 5. –°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
ssh deploy@$SERVER_IP << 'ENDSSH'
mkdir -p /opt/titotr/{backend,database/init,nginx/conf.d,backups}
echo "‚úÖ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å–æ–∑–¥–∞–Ω—ã"
ENDSSH

echo "‚úÖ –°–µ—Ä–≤–µ—Ä –Ω–∞—Å—Ç—Ä–æ–µ–Ω!"
echo "–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "1. –ò–∑–º–µ–Ω–∏—Ç—å SSH –ø–æ—Ä—Ç –Ω–∞ 2222"
echo "2. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å DNS –¥–ª—è titotr.ru"
echo "3. –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–µ—Ä–≤—ã–π –¥–µ–ø–ª–æ–π: ./scripts/deploy.sh"
```

**–°–¥–µ–ª–∞—Ç—å —Å–∫—Ä–∏–ø—Ç—ã –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º–∏:**
```bash
chmod +x scripts/*.sh
```

---

## üî• –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π Firewall –∏ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### 14. UFW –¥–ª—è Time to Travel

```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
sudo ufw default deny incoming
sudo ufw default allow outgoing

# SSH (–∫–∞—Å—Ç–æ–º–Ω—ã–π –ø–æ—Ä—Ç)
sudo ufw allow 2222/tcp comment 'SSH'

# HTTP/HTTPS
sudo ufw allow 80/tcp comment 'HTTP'
sudo ufw allow 443/tcp comment 'HTTPS'

# Portainer (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, —Ç–æ–ª—å–∫–æ —Å –≤–∞—à–µ–≥–æ IP)
sudo ufw allow from <YOUR_IP> to any port 9443 comment 'Portainer'

# –í–∫–ª—é—á–∏—Ç—å
sudo ufw enable

# –°—Ç–∞—Ç—É—Å
sudo ufw status verbose
```

**Fail2ban –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**

```bash
# /etc/fail2ban/jail.local
[DEFAULT]
bantime = 3600
findtime = 600
maxretry = 5
destemail = admin@titotr.ru
sendername = Fail2Ban

[sshd]
enabled = true
port = 2222
logpath = /var/log/auth.log

[nginx-http-auth]
enabled = true
port = http,https
logpath = /var/log/nginx/error.log

[nginx-limit-req]
enabled = true
filter = nginx-limit-req
port = http,https
logpath = /var/log/nginx/error.log
maxretry = 10
```

```bash
sudo systemctl enable fail2ban
sudo systemctl restart fail2ban
```

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### 15. –°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

#### Health Checks:

**routes/health.dart:**

```dart
import 'package:dart_frog/dart_frog.dart';

Future<Response> onRequest(RequestContext context) async {
  try {
    // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
    final db = context.read<DatabaseService>();
    await db.execute('SELECT 1');

    // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Redis
    final redis = context.read<RedisService>();
    await redis.ping();

    return Response.json(
      body: {
        'status': 'ok',
        'service': 'Time to Travel API',
        'version': '1.0.0',
        'timestamp': DateTime.now().toIso8601String(),
        'checks': {
          'database': 'healthy',
          'redis': 'healthy',
        },
      },
    );
  } catch (e) {
    return Response.json(
      statusCode: 503,
      body: {
        'status': 'error',
        'error': e.toString(),
      },
    );
  }
}
```

#### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:

```bash
# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
docker compose logs -f backend
docker compose logs -f nginx
docker compose logs -f postgres

# –õ–æ–≥–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å
docker compose logs --since 1h backend

# –¢–æ–ª—å–∫–æ –æ—à–∏–±–∫–∏
docker compose logs backend | grep ERROR
```

---

## üìã –ß–µ–∫-–ª–∏—Å—Ç –ú–∏–≥—Ä–∞—Ü–∏–∏ Firebase ‚Üí Dart Frog

### –ü–æ—à–∞–≥–æ–≤—ã–π –ø–ª–∞–Ω:

#### –§–∞–∑–∞ 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (1-2 –¥–Ω—è)
- [ ] –ê—Ä–µ–Ω–¥–æ–≤–∞—Ç—å VPS –Ω–∞ Selectel
- [ ] –ö—É–ø–∏—Ç—å –¥–æ–º–µ–Ω titotr.ru (‚úÖ –°–î–ï–õ–ê–ù–û)
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å DNS –∑–∞–ø–∏—Å–∏ –Ω–∞ Selectel
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å SSH –¥–æ—Å—Ç—É–ø
- [ ] –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Docker

#### –§–∞–∑–∞ 2: Backend Development (2-4 –¥–Ω—è)
- [ ] –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç Dart Frog
- [ ] –°–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ö–µ–º—É PostgreSQL
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é
- [ ] –°–æ–∑–¥–∞—Ç—å API endpoints (auth, users, bookings, routes)
- [ ] –ù–∞–ø–∏—Å–∞—Ç—å unit —Ç–µ—Å—Ç—ã

#### –§–∞–∑–∞ 3: –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (2-3 –¥–Ω—è)
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å PostgreSQL –≤ Docker
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Redis
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Nginx
- [ ] –ü–æ–ª—É—á–∏—Ç—å SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–ª—è titotr.ru
- [ ] –°–æ–∑–¥–∞—Ç—å docker-compose.yml
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –±—ç–∫–∞–ø—ã

#### –§–∞–∑–∞ 4: –ú–∏–≥—Ä–∞—Ü–∏—è –î–∞–Ω–Ω—ã—Ö (1-2 –¥–Ω—è)
- [ ] –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ Firebase
- [ ] –ù–∞–ø–∏—Å–∞—Ç—å —Å–∫—Ä–∏–ø—Ç—ã –º–∏–≥—Ä–∞—Ü–∏–∏
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –Ω–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- [ ] –í—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ–ª–Ω—É—é –º–∏–≥—Ä–∞—Ü–∏—é

#### –§–∞–∑–∞ 5: Flutter App Integration (2-3 –¥–Ω—è)
- [ ] –û–±–Ω–æ–≤–∏—Ç—å API –∫–ª–∏–µ–Ω—Ç –≤ Flutter (–∑–∞–º–µ–Ω–∏—Ç—å Firebase SDK –Ω–∞ http/dio)
- [ ] –ó–∞–º–µ–Ω–∏—Ç—å Firebase Auth –Ω–∞ JWT
- [ ] –û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ –º–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏
- [ ] –û–±—Ä–∞–±–æ—Ç–∞—Ç—å edge cases

#### –§–∞–∑–∞ 6: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (2-3 –¥–Ω—è)
- [ ] Unit —Ç–µ—Å—Ç—ã backend
- [ ] Integration —Ç–µ—Å—Ç—ã API
- [ ] E2E —Ç–µ—Å—Ç—ã Flutter app
- [ ] –ù–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] Security –∞—É–¥–∏—Ç

#### –§–∞–∑–∞ 7: –î–µ–ø–ª–æ–π (1 –¥–µ–Ω—å)
- [ ] –°–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç—ã –¥–µ–ø–ª–æ—è
- [ ] –í—ã–ø–æ–ª–Ω–∏—Ç—å –ø–µ—Ä–≤—ã–π –¥–µ–ø–ª–æ–π
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ endpoints
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–ª–µ—Ä—Ç—ã

#### –§–∞–∑–∞ 8: –ü–æ—Å—Ç–º–∏–≥—Ä–∞—Ü–∏—è (ongoing)
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—à–∏–±–æ–∫
- [ ] –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- [ ] –û—Ç–∫–ª—é—á–∏—Ç—å Firebase (–ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ)
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API
- [ ] –û–±—É—á–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)

**–û–±—â–µ–µ –≤—Ä–µ–º—è: 10-16 –¥–Ω–µ–π** (—É–ø—Ä–æ—â–µ–Ω–æ –∑–∞ —Å—á—ë—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è —Ñ–∞–π–ª–æ–≤–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞)

---

## üí∞ –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –°—Ç–æ–∏–º–æ—Å—Ç—å –¥–ª—è Time to Travel

**–ï–∂–µ–º–µ—Å—è—á–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã:**

| –°–µ—Ä–≤–∏—Å | –°—Ç–æ–∏–º–æ—Å—Ç—å | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ |
|--------|-----------|------------|
| Selectel VPS (4 vCPU, 8GB, 80GB SSD) | ~1200-1500 —Ä—É–± | –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è |
| –î–æ–º–µ–Ω titotr.ru | ~40 —Ä—É–±/–º–µ—Å | ~500 —Ä—É–±/–≥–æ–¥ |
| –ë—ç–∫–∞–ø—ã –ë–î | ~200 —Ä—É–± | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) |
| **–ò–¢–û–ì–û** | **~1450-1750 —Ä—É–±/–º–µ—Å** | **~17000-21000 —Ä—É–±/–≥–æ–¥** |

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ - –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**

| –°–µ—Ä–≤–∏—Å | –°—Ç–æ–∏–º–æ—Å—Ç—å | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ |
|--------|-----------|------------|
| Selectel VPS (2 vCPU, 4GB, 40GB SSD) | ~600-800 —Ä—É–± | –î–ª—è —Å—Ç–∞—Ä—Ç–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ |
| –î–æ–º–µ–Ω titotr.ru | ~40 —Ä—É–±/–º–µ—Å | ~500 —Ä—É–±/–≥–æ–¥ |
| **–ò–¢–û–ì–û** | **~650-850 —Ä—É–±/–º–µ—Å** | **~8000-10000 —Ä—É–±/–≥–æ–¥** |

**–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å Firebase (–ø—Ä–∏ —Ä–æ—Å—Ç–µ):**

Firebase Blaze Plan –¥–ª—è —Å—Ä–µ–¥–Ω–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: $50-200/–º–µ—Å (~5000-20000 —Ä—É–±)  
**–≠–∫–æ–Ω–æ–º–∏—è: 60-90% –≤ –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–π –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–µ**

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ù–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç Firebase –∫–≤–æ—Ç –∏ –ª–∏–º–∏—Ç–æ–≤
- ‚úÖ –î–∞–Ω–Ω—ã–µ –≤ –†–æ—Å—Å–∏–∏ (—Å–æ–±–ª—é–¥–µ–Ω–∏–µ 152-–§–ó)
- ‚úÖ –ü–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π
- ‚úÖ –ü—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å (–Ω–µ—Ç –≤–Ω–µ–∑–∞–ø–Ω—ã—Ö —Å–∫–∞—á–∫–æ–≤ –ø—Ä–∏ —Ä–æ—Å—Ç–µ)

---

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ Production

–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ –∫–æ–≥–¥–∞:

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:
- ‚úÖ SSH —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø–æ –∫–ª—é—á–∞–º –Ω–∞ –ø–æ—Ä—Ç—É 2222
- ‚úÖ UFW firewall –∞–∫—Ç–∏–≤–µ–Ω
- ‚úÖ Fail2ban –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- ‚úÖ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (A+ –Ω–∞ SSLLabs)
- ‚úÖ HTTPS —Ä–µ–¥–∏—Ä–µ–∫—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ Security headers –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã

### Infrastructure:
- ‚úÖ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∑–∞–ø—É—â–µ–Ω—ã –∏ healthy
- ‚úÖ PostgreSQL —Ä–∞–±–æ—Ç–∞–µ—Ç —Å persistence
- ‚úÖ Redis —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ Nginx reverse proxy —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –±—ç–∫–∞–ø—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
- ‚úÖ SSL –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ

### Backend:
- ‚úÖ Dart Frog API –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ /api/health
- ‚úÖ JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –í—Å–µ endpoints –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã
- ‚úÖ Rate limiting –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- ‚úÖ CORS –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

### Database:
- ‚úÖ –°—Ö–µ–º–∞ —Å–æ–∑–¥–∞–Ω–∞
- ‚úÖ –ò–Ω–¥–µ–∫—Å—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
- ‚úÖ –î–∞–Ω–Ω—ã–µ –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã –∏–∑ Firebase
- ‚úÖ –ë—ç–∫–∞–ø—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚úÖ Restore –ø—Ä–æ—Ü–µ–¥—É—Ä–∞ –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:
- ‚úÖ Health checks —Ä–∞–±–æ—Ç–∞—é—Ç
- ‚úÖ –õ–æ–≥–∏ –¥–æ—Å—Ç—É–ø–Ω—ã
- ‚úÖ –ê–ª–µ—Ä—Ç—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
- ‚úÖ Uptime monitoring –∞–∫—Ç–∏–≤–µ–Ω

### –î–µ–ø–ª–æ–π:
- ‚úÖ –°–∫—Ä–∏–ø—Ç—ã –¥–µ–ø–ª–æ—è —Ä–∞–±–æ—Ç–∞—é—Ç
- ‚úÖ Rollback –ø—Ä–æ—Ü–µ–¥—É—Ä–∞ –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞
- ‚úÖ Zero-downtime deployment (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

---

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∏ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

**–û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:**
- Dart Frog: https://dart-frog.dev/
- PostgreSQL: https://www.postgresql.org/docs/
- Nginx: https://nginx.org/ru/docs/
- Docker: https://docs.docker.com/
- Selectel API: https://docs.selectel.ru/

**–°–æ–æ–±—â–µ—Å—Ç–≤–æ:**
- Dart Frog Discord: https://discord.gg/very-good-ventures
- Flutter Russia: https://t.me/rudart
- Stack Overflow: https://stackoverflow.com/questions/tagged/dart-frog

**–ü–æ—Å—Ç–∞–≤—â–∏–∫–∏:**
- Selectel –ø–æ–¥–¥–µ—Ä–∂–∫–∞: support@selectel.ru
- –ü–∞–Ω–µ–ª—å Selectel: https://my.selectel.ru/

---

## üéØ –ò—Ç–æ–≥–æ–≤–∞—è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ          Flutter Mobile App (Client)             ‚îÇ
‚îÇ              iOS + Android                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ HTTPS
                   ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              titotr.ru (Domain)                  ‚îÇ
‚îÇ         DNS: Selectel (4 NS servers)             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
                   ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         Nginx (Reverse Proxy + SSL)              ‚îÇ
‚îÇ      Let's Encrypt SSL Certificate               ‚îÇ
‚îÇ         Port 80 ‚Üí 443 redirect                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
                   ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ          Dart Frog Backend API                   ‚îÇ
‚îÇ       (Docker Container :8080)                   ‚îÇ
‚îÇ                                                  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îÇ
‚îÇ  ‚îÇ  Routes (Auto-routing)                ‚îÇ       ‚îÇ
‚îÇ  ‚îÇ  ‚îú‚îÄ /api/auth/*                       ‚îÇ       ‚îÇ
‚îÇ  ‚îÇ  ‚îú‚îÄ /api/users/*                      ‚îÇ       ‚îÇ
‚îÇ  ‚îÇ  ‚îú‚îÄ /api/bookings/*                   ‚îÇ       ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ /api/health                       ‚îÇ       ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îÇ
‚îÇ                                                  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îÇ
‚îÇ  ‚îÇ  Services                             ‚îÇ       ‚îÇ
‚îÇ  ‚îÇ  ‚îú‚îÄ AuthService (JWT)                 ‚îÇ       ‚îÇ
‚îÇ  ‚îÇ  ‚îú‚îÄ DatabaseService (PostgreSQL)      ‚îÇ       ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ RedisService (Cache)              ‚îÇ       ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
       ‚ñº                       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ PostgreSQL  ‚îÇ         ‚îÇ  Redis   ‚îÇ
‚îÇ  Database   ‚îÇ         ‚îÇ  Cache   ‚îÇ
‚îÇ (Container) ‚îÇ         ‚îÇ(Container)‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –•—Ä–∞–Ω–∏–ª–∏—â–µ —Ñ–∞–π–ª–æ–≤ (S3) –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è,
—Ç–∞–∫ –∫–∞–∫ –ø—Ä–æ–µ–∫—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å —Ç–µ–∫—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏.
```

---

**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞:** 2.0  
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 21 —è–Ω–≤–∞—Ä—è 2026  
**–ü—Ä–æ–µ–∫—Ç:** Time to Travel (titotr.ru)  
**–ê–≤—Ç–æ—Ä:** Senior Backend & Frontend Developer

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

```bash
# 1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
git clone <repo> time-to-travel
cd time-to-travel

# 2. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Å–µ—Ä–≤–µ—Ä
./scripts/setup_server.sh <SERVER_IP>

# 3. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å DNS
# –î–æ–±–∞–≤–∏—Ç—å A-–∑–∞–ø–∏—Å—å: titotr.ru ‚Üí <SERVER_IP>

# 4. –°–æ–∑–¥–∞—Ç—å .env.production
cp .env.example .env.production
nano .env.production  # –ó–∞–ø–æ–ª–Ω–∏—Ç—å —Å–µ–∫—Ä–µ—Ç—ã

# 5. –ü–µ—Ä–≤—ã–π –¥–µ–ø–ª–æ–π
./scripts/deploy.sh

# 6. –ü–æ–ª—É—á–∏—Ç—å SSL
ssh titotr-production
cd /opt/titotr
docker compose run --rm certbot certonly \
  --webroot -w /var/www/certbot \
  --email admin@titotr.ru \
  --agree-tos -d titotr.ru -d www.titotr.ru

# 7. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å nginx
docker compose restart nginx

# 8. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
curl https://titotr.ru/api/health
```

**–ì–æ—Ç–æ–≤–æ! üéâ**
