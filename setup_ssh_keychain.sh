#!/bin/bash

# ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° SSH Ð´Ð»Ñ Ð¸Ð·Ð±ÐµÐ¶Ð°Ð½Ð¸Ñ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð½Ð¾Ð³Ð¾ Ð²Ð²Ð¾Ð´Ð° Ð¿Ð°Ñ€Ð¾Ð»Ñ
# Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ macOS Keychain Ð´Ð»Ñ Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ð¿Ð°Ñ€Ð¾Ð»Ñ

echo "ðŸ” ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° SSH Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ð²Ñ…Ð¾Ð´Ð° Ð½Ð° titotr.ru..."
echo ""

# Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ Ð² ~/.ssh/config
SSH_CONFIG="$HOME/.ssh/config"

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚ Ð»Ð¸ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Ð´Ð»Ñ titotr.ru
if grep -q "titotr.ru" "$SSH_CONFIG"; then
    echo "âš ï¸  ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Ð´Ð»Ñ titotr.ru ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚ Ð² $SSH_CONFIG"
else
    echo "ðŸ“ Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ Ð² $SSH_CONFIG..."
    cat >> "$SSH_CONFIG" << 'EOF'

Host titotr titotr.ru
    HostName titotr.ru
    User root
    IdentityFile ~/.ssh/id_ed25519
    UseKeychain yes
    AddKeysToAgent yes
EOF
    echo "âœ… ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð°"
fi

echo ""
echo "ðŸ”‘ Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ÐºÐ»ÑŽÑ‡ Ð² macOS Keychain (Ð²Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ 102938 ÐŸÐžÐ¡Ð›Ð•Ð”ÐÐ˜Ð™ Ð ÐÐ—)..."
echo ""

# Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ÐºÐ»ÑŽÑ‡ Ð² Keychain (Ð½Ð° macOS ÑÑ‚Ð¾ ÑÐ¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ Ð½Ð°Ð²ÑÐµÐ³Ð´Ð°)
ssh-add --apple-use-keychain ~/.ssh/id_ed25519

echo ""
echo "âœ… Ð“ÐžÐ¢ÐžÐ’Ðž! ÐŸÐ°Ñ€Ð¾Ð»ÑŒ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½ Ð² macOS Keychain."
echo ""
echo "ðŸ“‹ Ð¢ÐµÐ¿ÐµÑ€ÑŒ Ð²Ñ‹ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ð°Ñ‚ÑŒÑÑ Ðº ÑÐµÑ€Ð²ÐµÑ€Ñƒ Ð±ÐµÐ· Ð¿Ð°Ñ€Ð¾Ð»Ñ:"
echo "   ssh titotr.ru"
echo "   scp Ñ„Ð°Ð¹Ð».txt titotr.ru:/tmp/"
echo ""
echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð½Ñ‹Ñ… ÐºÐ»ÑŽÑ‡ÐµÐ¹:"
ssh-add -l

echo ""
echo "âœ… ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°!"
