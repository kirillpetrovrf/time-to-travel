#!/bin/bash

echo "üîç ========== –ü–†–û–í–ï–†–ö–ê YANDEX MAPKIT API –ö–õ–Æ–ß–ê =========="
echo ""

# –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –∫–ª—é—á –∏–∑ –∫–æ–¥–∞
API_KEY=$(grep "yandexMapKitApiKey" lib/config/map_config.dart | cut -d"'" -f2)

if [ -z "$API_KEY" ] || [ "$API_KEY" == "YOUR_YANDEX_MAPKIT_API_KEY" ]; then
    echo "‚ùå API –∫–ª—é—á –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!"
    echo ""
    echo "üìù –û—Ç–∫—Ä–æ–π—Ç–µ lib/config/map_config.dart –∏ –¥–æ–±–∞–≤—å—Ç–µ –∫–ª—é—á"
    echo ""
    exit 1
fi

echo "‚úÖ API –∫–ª—é—á –Ω–∞–π–¥–µ–Ω –≤ –∫–æ–¥–µ:"
echo "   ${API_KEY:0:15}...${API_KEY: -15}"
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç –∫–ª—é—á–∞ (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å UUID)
if [[ $API_KEY =~ ^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$ ]]; then
    echo "‚úÖ –§–æ—Ä–º–∞—Ç –∫–ª—é—á–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π (UUID)"
else
    echo "‚ö†Ô∏è  –§–æ—Ä–º–∞—Ç –∫–ª—é—á–∞ –Ω–µ–æ–±—ã—á–Ω—ã–π (–æ–∂–∏–¥–∞–µ—Ç—Å—è UUID)"
fi
echo ""

# –ü—ã—Ç–∞–µ–º—Å—è –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–ª—é—á —á–µ—Ä–µ–∑ Yandex API
echo "üåê –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª—é—á–∞ —á–µ—Ä–µ–∑ Yandex API..."
echo "   (–ø–æ–ø—ã—Ç–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ MapKit)"
echo ""

# –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π HTML —Ñ–∞–π–ª –¥–ª—è —Ç–µ—Å—Ç–∞
cat > /tmp/test_mapkit.html << 'EOF'
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>MapKit Test</title>
    <script src="https://api-maps.yandex.ru/3.0/?apikey=API_KEY_PLACEHOLDER&lang=ru_RU" type="text/javascript"></script>
</head>
<body>
    <div id="map" style="width: 600px; height: 400px"></div>
    <script>
        window.onload = function() {
            ymaps3.ready.then(() => {
                console.log('MapKit initialized successfully');
                document.getElementById('status').innerHTML = 'OK';
            }).catch((error) => {
                console.error('MapKit initialization failed:', error);
                document.getElementById('status').innerHTML = 'ERROR: ' + error.message;
            });
        };
    </script>
    <div id="status">Loading...</div>
</body>
</html>
EOF

# –ó–∞–º–µ–Ω—è–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π –∫–ª—é—á
sed -i '' "s/API_KEY_PLACEHOLDER/$API_KEY/" /tmp/test_mapkit.html

echo "‚ö†Ô∏è  –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª—é—á–∞ —á–µ—Ä–µ–∑ API –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞ –∏–∑ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞"
echo "   –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Ä—É—á–Ω—É—é –≤ –ö–∞–±–∏–Ω–µ—Ç–µ –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞:"
echo ""
echo "   üåê https://developer.tech.yandex.ru/"
echo ""
echo "üìã –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –ö–∞–±–∏–Ω–µ—Ç–µ:"
echo "   1. –û—Ç–∫—Ä–æ–π—Ç–µ —Ä–∞–∑–¥–µ–ª 'MapKit ‚Äì –º–æ–±–∏–ª—å–Ω—ã–π SDK' (–ù–ï JavaScript API!)"
echo "   2. –ù–∞–π–¥–∏—Ç–µ –∫–ª—é—á: ${API_KEY:0:20}..."
echo "   3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å: –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å '–ê–ö–¢–ò–í–ï–ù' ‚úÖ"
echo "   4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞—Ç—É —Å–æ–∑–¥–∞–Ω–∏—è: –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–π—Ç–∏ 15+ –º–∏–Ω—É—Ç"
echo "   5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–∏–º–∏—Ç—ã: –Ω–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø—Ä–µ–≤—ã—à–µ–Ω—ã"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞
echo "üåê –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è..."
if ping -c 1 -W 2 ya.ru &> /dev/null; then
    echo "‚úÖ –ò–Ω—Ç–µ—Ä–Ω–µ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç"
else
    echo "‚ùå –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É!"
    echo "   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ—Ç–µ–≤–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ"
    exit 1
fi
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
echo "üì± –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞/—ç–º—É–ª—è—Ç–æ—Ä–∞..."
DEVICE_COUNT=$(adb devices | grep -v "List" | grep "device$" | wc -l)

if [ $DEVICE_COUNT -eq 0 ]; then
    echo "‚ö†Ô∏è  –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ"
    echo "   –ó–∞–ø—É—Å—Ç–∏—Ç–µ —ç–º—É–ª—è—Ç–æ—Ä –∏–ª–∏ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω"
    echo ""
elif [ $DEVICE_COUNT -eq 1 ]; then
    echo "‚úÖ –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ:"
    adb devices | grep "device$"
    echo ""
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
    echo "üì° –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ..."
    if timeout 5 adb shell ping -c 1 ya.ru &> /dev/null; then
        echo "‚úÖ –ò–Ω—Ç–µ—Ä–Ω–µ—Ç –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"
    else
        echo "‚ùå –ù–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ!"
        echo "   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ç–∏ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ/—ç–º—É–ª—è—Ç–æ—Ä–µ"
    fi
    echo ""
else
    echo "‚ö†Ô∏è  –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ ($DEVICE_COUNT)"
    echo "   –û—Ç–∫–ª—é—á–∏—Ç–µ –ª–∏—à–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞"
    adb devices
    echo ""
fi

# –ò—Ç–æ–≥–æ–≤–∞—è —Å–≤–æ–¥–∫–∞
echo "========== –ò–¢–û–ì–û–í–ê–Ø –°–í–û–î–ö–ê =========="
echo ""
echo "‚úÖ API –∫–ª—é—á –Ω–∞–π–¥–µ–Ω: ${API_KEY:0:20}..."
echo "‚úÖ –§–æ—Ä–º–∞—Ç –∫–ª—é—á–∞: OK"
echo "‚úÖ –ò–Ω—Ç–µ—Ä–Ω–µ—Ç (–∫–æ–º–ø—å—é—Ç–µ—Ä): OK"

if [ $DEVICE_COUNT -eq 1 ]; then
    echo "‚úÖ –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ: OK"
fi

echo ""
echo "‚ö†Ô∏è  –¢–†–ï–ë–£–ï–¢–°–Ø –†–£–ß–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê:"
echo ""
echo "1Ô∏è‚É£  –û—Ç–∫—Ä–æ–π—Ç–µ –ö–∞–±–∏–Ω–µ—Ç –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞:"
echo "    üåê https://developer.tech.yandex.ru/"
echo ""
echo "2Ô∏è‚É£  –ù–∞–π–¥–∏—Ç–µ —Ä–∞–∑–¥–µ–ª 'MapKit ‚Äì –º–æ–±–∏–ª—å–Ω—ã–π SDK'"
echo "    ‚ùó –ù–ï 'JavaScript API' - —ç—Ç–æ –¥—Ä—É–≥–æ–π –∫–ª—é—á!"
echo ""
echo "3Ô∏è‚É£  –ù–∞–π–¥–∏—Ç–µ –≤–∞—à –∫–ª—é—á –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:"
echo "    ‚úÖ –°—Ç–∞—Ç—É—Å: –ê–ö–¢–ò–í–ï–ù"
echo "    ‚úÖ –¢–∏–ø: MapKit ‚Äì –º–æ–±–∏–ª—å–Ω—ã–π SDK"
echo "    ‚úÖ –°–æ–∑–¥–∞–Ω: –±–æ–ª–µ–µ 15 –º–∏–Ω—É—Ç –Ω–∞–∑–∞–¥"
echo "    ‚úÖ –õ–∏–º–∏—Ç—ã: –Ω–µ –ø—Ä–µ–≤—ã—à–µ–Ω—ã"
echo ""
echo "4Ô∏è‚É£  –ï—Å–ª–∏ –∫–ª—é—á –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω - —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π:"
echo "    - –ù–∞–∂–º–∏—Ç–µ '–ù–æ–≤—ã–π –∫–ª—é—á'"
echo "    - –í—ã–±–µ—Ä–∏—Ç–µ 'MapKit ‚Äì –º–æ–±–∏–ª—å–Ω—ã–π SDK'"
echo "    - –í—ã–±–µ—Ä–∏—Ç–µ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Ç–∞—Ä–∏—Ñ (25,000 –∑–∞–ø—Ä–æ—Å–æ–≤/–¥–µ–Ω—å)"
echo "    - –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –Ω–æ–≤—ã–π –∫–ª—é—á"
echo "    - –ó–∞–º–µ–Ω–∏—Ç–µ –≤ lib/config/map_config.dart"
echo "    - –ü–û–î–û–ñ–î–ò–¢–ï 15 –ú–ò–ù–£–¢ –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏"
echo ""
echo "5Ô∏è‚É£  –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:"
echo "    flutter clean && flutter run"
echo ""
echo "=========================================="
echo ""

# –°–ø—Ä–∞—à–∏–≤–∞–µ–º, —Ö–æ—á–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
read -p "üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–µ–π—á–∞—Å? (y/n): " -n 1 -r
echo ""
if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo "üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
    flutter run
fi
