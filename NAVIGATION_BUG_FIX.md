# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø—Ä–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏

## üêõ –ü—Ä–æ–±–ª–µ–º–∞

–ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ —Ç–∏–ø–∞ –ø–æ–µ–∑–¥–∫–∏ –ø–æ—è–≤–ª—è–ª—Å—è —á–µ—Ä–Ω—ã–π —ç–∫—Ä–∞–Ω —Å –æ—à–∏–±–∫–æ–π:
```
This widget has been unmounted, so the State no longer has a context
```

### –ü—Ä–∏—á–∏–Ω–∞:
–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω:
1. –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –≤—Ç–æ—Ä–æ–≥–æ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ (`_TripTypeSelectionModal`) –≤—ã–∑—ã–≤–∞–ª—Å—è `Navigator.pop()` –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –ø–µ—Ä–≤–æ–≥–æ –æ–∫–Ω–∞
2. –ó–∞—Ç–µ–º –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ —Ç–∏–ø –ø–æ–µ–∑–¥–∫–∏ —Å–Ω–æ–≤–∞ –≤—ã–∑—ã–≤–∞–ª—Å—è `Navigator.pop()`
3. –í –∏—Ç–æ–≥–µ –∑–∞–∫—Ä—ã–≤–∞–ª–æ—Å—å –±–æ–ª—å—à–µ –æ–∫–æ–Ω, —á–µ–º –Ω—É–∂–Ω–æ, –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–º

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### 1. –£–±—Ä–∞–ª–∏ –ø—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–µ—Ä–≤–æ–≥–æ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞

**–ë—ã–ª–æ:**
```dart
void _showTripTypeSelection(
  RouteStop fromStop,
  RouteStop toStop,
  String routeType,
) {
  Navigator.of(context).pop(); // ‚ùå –ó–∞–∫—Ä—ã–≤–∞–ª–∏ –ø–µ—Ä–≤–æ–µ –æ–∫–Ω–æ —Å—Ä–∞–∑—É
  
  showCupertinoModalPopup(...);
}
```

**–°—Ç–∞–ª–æ:**
```dart
void _showTripTypeSelection(
  RouteStop fromStop,
  RouteStop toStop,
  String routeType,
) {
  // ‚úÖ –ù–ï –∑–∞–∫—Ä—ã–≤–∞–µ–º –ø–µ—Ä–≤–æ–µ –æ–∫–Ω–æ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Ç–æ—Ä–æ–µ –ø–æ–≤–µ—Ä—Ö –Ω–µ–≥–æ
  showCupertinoModalPopup(...);
}
```

### 2. –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –æ–∫–æ–Ω –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ

**–ë—ã–ª–æ:**
```dart
onTap: () {
  Navigator.of(context).pop(); // ‚ùå –ó–∞–∫—Ä—ã–≤–∞–ª–∏ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ
  onTripTypeSelected('group');
}
```

**–°—Ç–∞–ª–æ:**
```dart
onTap: () {
  onTripTypeSelected('group'); // ‚úÖ –ü—Ä–æ—Å—Ç–æ –≤—ã–∑—ã–≤–∞–µ–º callback
}
```

### 3. –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ `_navigateToBooking`

```dart
void _navigateToBooking(
  RouteStop fromStop,
  RouteStop toStop,
  String tripType,
) async {
  // ‚úÖ –ó–∞–∫—Ä—ã–≤–∞–µ–º –û–ë–ê –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–Ω–∞ –ø–æ –ø–æ—Ä—è–¥–∫—É
  Navigator.of(context).pop(); // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Ç–æ—Ä–æ–µ (–≤—ã–±–æ—Ä —Ç–∏–ø–∞)
  Navigator.of(context).pop(); // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–µ—Ä–≤–æ–µ (–≤—ã–±–æ—Ä –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è)
  
  // ‚úÖ –í–ê–ñ–ù–û: –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ –∑–∞–∫—Ä—ã—Ç–∏—è
  await Future.delayed(const Duration(milliseconds: 300));
  
  // ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤–∏–¥–∂–µ—Ç –µ—â–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
  if (!mounted) return;
  
  // ‚úÖ –ó–∞—Ç–µ–º –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —ç–∫—Ä–∞–Ω –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
  if (tripType == 'group') {
    Navigator.of(context).push(...);
  } else {
    Navigator.of(context).push(...);
  }
}
```

## üìã –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –Ω–∞–≤–∏–≥–∞—Ü–∏–∏

### –¢–µ–∫—É—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω:
```
üì± BookingScreen (–≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω)
   ‚Üì –Ω–∞–∂–∏–º–∞–µ–º "–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã"
   
üî≤ –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ 1: _PopularRoutesModal
   ‚Üì –≤—ã–±–∏—Ä–∞–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ + "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å"
   
   üî≤ –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ 2: _TripTypeSelectionModal (–ø–æ–≤–µ—Ä—Ö –ø–µ—Ä–≤–æ–≥–æ!)
      ‚Üì –≤—ã–±–∏—Ä–∞–µ–º —Ç–∏–ø –ø–æ–µ–∑–¥–∫–∏
      
      ‚ùå –ó–∞–∫—Ä—ã–≤–∞–µ–º –í–¢–û–†–û–ï –æ–∫–Ω–æ (pop)
   ‚ùå –ó–∞–∫—Ä—ã–≤–∞–µ–º –ü–ï–†–í–û–ï –æ–∫–Ω–æ (pop)
   
   ‚úÖ –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ GroupBookingScreen / IndividualBookingScreen
```

## üîß –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- `lib/features/booking/screens/booking_screen.dart`
  - –ú–µ—Ç–æ–¥ `_showTripTypeSelection()` (—Å—Ç—Ä–æ–∫–∞ ~210)
  - –ú–µ—Ç–æ–¥ `_navigateToBooking()` (—Å—Ç—Ä–æ–∫–∞ ~229)
  - –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤ `_TripTypeSelectionModal` (—Å—Ç—Ä–æ–∫–∏ ~789, ~808)

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç

- ‚úÖ –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –æ—Ç–∫—Ä—ã–≤–∞—é—Ç—Å—è –∏ –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
- ‚úÖ –ü–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —ç–∫—Ä–∞–Ω –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π 300ms
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –æ–±–æ–∏—Ö —Ç–∏–ø–æ–≤ –ø–æ–µ–∑–¥–æ–∫ (–ì—Ä—É–ø–ø–æ–≤–∞—è / –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è)
- ‚úÖ –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" –Ω–∞ —ç–∫—Ä–∞–Ω–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

## üêõ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (—á–µ—Ä–Ω—ã–π —ç–∫—Ä–∞–Ω –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ "–ù–∞–∑–∞–¥")

### –ü—Ä–æ–±–ª–µ–º–∞:
–ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥" –Ω–∞ —ç–∫—Ä–∞–Ω–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ—è–≤–ª—è–ª—Å—è —á–µ—Ä–Ω—ã–π —ç–∫—Ä–∞–Ω.

### –ü—Ä–∏—á–∏–Ω–∞:
–ü–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è –¥–≤—É—Ö –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω (`pop()` √ó 2) –º—ã —Å—Ä–∞–∑—É –ø—ã—Ç–∞–ª–∏—Å—å –æ—Ç–∫—Ä—ã—Ç—å –Ω–æ–≤—ã–π —ç–∫—Ä–∞–Ω (`push()`). –ö–æ–Ω—Ç–µ–∫—Å—Ç –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –Ω–µ —É—Å–ø–µ–≤–∞–ª –æ–±–Ω–æ–≤–∏—Ç—å—Å—è, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É.

### –†–µ—à–µ–Ω–∏–µ:
–î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞–¥–µ—Ä–∂–∫–∞ 300ms –º–µ–∂–¥—É –∑–∞–∫—Ä—ã—Ç–∏–µ–º –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –∏ –æ—Ç–∫—Ä—ã—Ç–∏–µ–º –Ω–æ–≤–æ–≥–æ —ç–∫—Ä–∞–Ω–∞:

```dart
void _navigateToBooking(...) async {
  Navigator.of(context).pop(); // –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ 2
  Navigator.of(context).pop(); // –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ 1
  
  await Future.delayed(const Duration(milliseconds: 300)); // ‚è±Ô∏è –ñ–¥–µ–º
  if (!mounted) return; // üõ°Ô∏è –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
  
  Navigator.of(context).push(...); // üöÄ –û—Ç–∫—Ä—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω
}
```

### –ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã:
1. **–ú–µ—Ç–æ–¥ —Å—Ç–∞–ª `async`** - –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `await`
2. **–ó–∞–¥–µ—Ä–∂–∫–∞ 300ms** - –≤—Ä–µ–º—è –Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∞–Ω–∏–º–∞—Ü–∏–∏ –∑–∞–∫—Ä—ã—Ç–∏—è
3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ `mounted`** - –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –≤–∏–¥–∂–µ—Ç –µ—â–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
4. **–ü–ª–∞–≤–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤–∏–¥–∏—Ç "—Å–∫–∞—á–∫–æ–≤"

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å:
1. –û—Ç–∫—Ä—ã—Ç—å "–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã"
2. –í—ã–±—Ä–∞—Ç—å "–î–æ–Ω–µ—Ü–∫ ‚Üí –†–æ—Å—Ç–æ–≤-–Ω–∞-–î–æ–Ω—É"
3. –ù–∞–∂–∞—Ç—å "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å"
4. –í—ã–±—Ä–∞—Ç—å "–ì—Ä—É–ø–ø–æ–≤–∞—è –ø–æ–µ–∑–¥–∫–∞"
5. ‚úÖ –î–æ–ª–∂–µ–Ω –æ—Ç–∫—Ä—ã—Ç—å—Å—è —ç–∫—Ä–∞–Ω –≥—Ä—É–ø–ø–æ–≤–æ–π –ø–æ–µ–∑–¥–∫–∏ –±–µ–∑ –æ—à–∏–±–æ–∫

–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –¥–ª—è:
- –û–±—Ä–∞—Ç–Ω–æ–≥–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–†–æ—Å—Ç–æ–≤ ‚Üí –î–æ–Ω–µ—Ü–∫)
- –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–π –ø–æ–µ–∑–¥–∫–∏
