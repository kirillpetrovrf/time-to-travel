# 🎯 КРАТКАЯ СХЕМА ТЕКУЩЕЙ АРХИТЕКТУРЫ

**Дата**: 22 января 2026 г.

---

## ✅ Всё работает через удалённый сервер с HTTPS!

```
┌──────────────────────────────────────────────────────────────────────┐
│                         PRODUCTION СИСТЕМА                            │
└──────────────────────────────────────────────────────────────────────┘


📱 FLUTTER APP (ПАССАЖИР)                    📱 FLUTTER APP (ДИСПЕТЧЕР)
┌─────────────────────────┐                  ┌──────────────────────────┐
│  Экран бронирования     │                  │  Админ-панель            │
│                         │                  │                          │
│  [Откуда]  [Куда]      │                  │  📊 Статистика           │
│  [Дата]    [Время]     │                  │  📋 Список заказов       │
│  [Пассажиры] [Багаж]   │                  │  ✅ Подтвердить          │
│                         │                  │  ❌ Отклонить            │
│  [Создать заказ] 🚀    │                  │                          │
└────────┬────────────────┘                  └────────┬─────────────────┘
         │                                            │
         │ 1. POST /api/orders                        │ 5. GET /api/orders
         │    + JWT token                             │    + Admin JWT
         │                                            │
         └──────────────────┐            ┌───────────┘
                            │            │
                            ▼            ▼
         ┌────────────────────────────────────────────────┐
         │     🌐 BACKEND API (https://titotr.ru)         │
         │           ✅ SSL СЕРТИФИКАТ                    │
         ├────────────────────────────────────────────────┤
         │  🔐 JWT Аутентификация                        │
         │  📦 17 API Endpoints                          │
         │  ⚡ Dart Frog Framework                       │
         │  🐳 Docker Container                          │
         └────────┬───────────────────────┬───────────────┘
                  │                       │
                  │ 2. Сохранить          │ 6. Обновить статус
                  ▼                       ▼
         ┌──────────────────────┐  ┌──────────────────────┐
         │  💾 PostgreSQL 16    │  │  💾 PostgreSQL 16    │
         │                      │  │                      │
         │  orders              │  │  UPDATE orders       │
         │  - id                │  │  SET status =        │
         │  - userId            │  │    'confirmed'       │
         │  - fromAddress       │  │  WHERE id = ...      │
         │  - toAddress         │  │                      │
         │  - status: pending   │  │                      │
         │  - totalPrice        │  │                      │
         │  - ...               │  │                      │
         └──────────────────────┘  └──────────────────────┘
                  │
                  │ 3. Триггер уведомления
                  ▼
         ┌────────────────────────────────────────────────┐
         │  📱 TELEGRAM SERVICE                           │
         │                                                │
         │  POST https://api.telegram.org/bot<TOKEN>/     │
         │       sendMessage                              │
         │                                                │
         │  chat_id: <ДИСПЕТЧЕР_CHAT_ID>                 │
         │  text: "🚗 НОВЫЙ ЗАКАЗ #123                   │
         │         👤 Иван Петров                        │
         │         📍 Донецк → Ростов                    │
         │         💰 1800₽"                             │
         └────────────────┬───────────────────────────────┘
                          │
                          │ 4. Уведомление
                          ▼
                  ┌─────────────────┐
                  │  📲 TELEGRAM    │
                  │                 │
                  │  [Диспетчер]    │
                  │  Видит новый    │
                  │  заказ в чате   │
                  └─────────────────┘


═══════════════════════════════════════════════════════════════════

ОБРАТНЫЙ ПОТОК (Диспетчер подтверждает):

📱 ДИСПЕТЧЕР → 🌐 BACKEND API → 💾 PostgreSQL → 📲 ПАССАЖИР
             PATCH /orders/:id/status              (Push)
             status: confirmed


═══════════════════════════════════════════════════════════════════
```

---

## 📡 ВСЕ КОММУНИКАЦИИ ЧЕРЕЗ HTTPS

```
Flutter App → https://titotr.ru/api/... → Backend → PostgreSQL
                    ↓
            Telegram Bot API
                    ↓
            Уведомление диспетчеру
```

---

## 🔒 БЕЗОПАСНОСТЬ

```
1. Пассажир входит → JWT Access Token (1 час)
2. Все API запросы → Authorization: Bearer <JWT>
3. Backend проверяет → Роль пользователя (client/driver/admin)
4. Токены хранятся → flutter_secure_storage (зашифровано)
5. SSL соединение → Все данные передаются через HTTPS
```

---

## 🎯 ЧТО УЖЕ ГОТОВО

✅ **Удалённый сервер**: https://titotr.ru  
✅ **HTTPS**: SSL сертификат установлен  
✅ **Backend API**: 17 endpoints работают  
✅ **База данных**: PostgreSQL с тестовыми данными  
✅ **Flutter API**: 4 сервиса готовы к использованию  
✅ **Telegram**: Код подготовлен (нужен только токен бота)  

---

## 🚀 СЛЕДУЮЩИЕ ШАГИ

1. **Создать UI диспетчера** - экраны для работы с заказами
2. **Настроить Telegram** - получить токен от @BotFather
3. **Интегрировать в экраны бронирования** - использовать OrdersApiService

---

**Теперь ВСЁ работает через удалённый сервер!** 🎉

Пассажир создаёт заказ → Backend сохраняет → Диспетчер видит в Telegram → Подтверждает → Пассажир получает уведомление

**Всё через HTTPS, всё безопасно, всё на production сервере!** ✅
