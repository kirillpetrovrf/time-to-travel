# 📊 ВИЗУАЛЬНАЯ СХЕМА АРХИТЕКТУРЫ TIME TO TRAVEL

## 🔄 ПОЛНЫЙ ПОТОК ДАННЫХ: От клиента до диспетчера

```
┌──────────────────────────────────────────────────────────────────────┐
│                    📱 FLUTTER ПРИЛОЖЕНИЕ (Клиент)                    │
│                         lib/features/booking/                        │
├──────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  1️⃣ Пользователь заполняет форму бронирования:                      │
│     ┌────────────────────────────────────────────┐                  │
│     │ ✈️ Направление: Донецк → Ростов-на-Дону   │                  │
│     │ 📅 Дата: 28 января 2026                    │                  │
│     │ ⏰ Время: 10:00                            │                  │
│     │ 👥 Пассажиры: 1 взрослый, 1 ребёнок       │                  │
│     │ 🧳 Багаж: 2 средних сумки                 │                  │
│     │ 🐕 Животные: нет                           │                  │
│     │ 💰 Цена: 1700 ₽                            │                  │
│     └────────────────────────────────────────────┘                  │
│                                                                      │
│  2️⃣ Нажимает кнопку "Забронировать"                                 │
│     ↓                                                                │
│     BookingService.createBooking()                                   │
│     ↓                                                                │
│  3️⃣ Подготовка данных:                                              │
│     • Конвертация Dart enums → JSON strings                         │
│     • PassengerType.adult → "adult"                                 │
│     • BaggageSize.m → "m"                                           │
│     • DateTime → ISO 8601 string                                    │
│                                                                      │
└──────────────────────────┬───────────────────────────────────────────┘
                           │
                           │ 📤 HTTP POST /api/orders
                           │    Content-Type: application/json
                           │
                           ▼
┌──────────────────────────────────────────────────────────────────────┐
│                   📡 ПЕРЕДАЧА ПО СЕТИ (HTTPS)                        │
├──────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  URL: https://titotr.ru/api/orders                                  │
│                                                                      │
│  Request Body:                                                       │
│  {                                                                   │
│    "fromAddress": "Донецк, ул. Артёма, 1",                          │
│    "toAddress": "Ростов-на-Дону, Главный вокзал",                   │
│    "departureTime": "2026-01-28T10:00:00.000Z",  ⚠️ UTC!           │
│    "passengerCount": 2,                                             │
│    "basePrice": 1500.0,                                             │
│    "totalPrice": 1700.0,                                            │
│    "finalPrice": 1700.0,                                            │
│    "tripType": "group",              ✅ Тип поездки                 │
│    "direction": "donetskToRostov",   ✅ Направление                 │
│    "passengers": [                                                   │
│      {"type": "adult"},                                             │
│      {"type": "child", "seatType": "booster", "ageMonths": 48}      │
│    ],                                                                │
│    "baggage": [                                                      │
│      {"size": "m", "quantity": 2, "pricePerExtraItem": 100.0}       │
│    ],                                                                │
│    "pets": []                                                        │
│  }                                                                   │
│                                                                      │
└──────────────────────────┬───────────────────────────────────────────┘
                           │
                           ▼
┌──────────────────────────────────────────────────────────────────────┐
│              🖥️ BACKEND API (Dart Frog на Selectel)                 │
│                 backend/routes/orders/index.dart                     │
├──────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  4️⃣ Получение запроса:                                              │
│     POST /api/orders                                                 │
│     ↓                                                                │
│  5️⃣ Парсинг JSON → CreateOrderDto:                                  │
│     final dto = CreateOrderDto.fromJson(json);                      │
│     ↓                                                                │
│  6️⃣ Валидация:                                                       │
│     ✓ Адреса не пустые?                                             │
│     ✓ Цена > 0?                                                     │
│     ✓ Дата в будущем?                                               │
│     ↓                                                                │
│  7️⃣ Генерация уникального orderId:                                  │
│     "ORDER-2026-01-797"                                             │
│     ↓                                                                │
│  8️⃣ Парсинг даты/времени:                                           │
│     "2026-01-28T10:00:00.000Z" →                                    │
│     departure_date: '2026-01-28'                                    │
│     departure_time: '10:00:00'                                      │
│     ↓                                                                │
│  9️⃣ Конвертация JSON → JSONB:                                       │
│     passengers: List<Passenger> → jsonEncode()                      │
│     baggage: List<Baggage> → jsonEncode()                           │
│     ↓                                                                │
│  🔟 Вызов OrderRepository.create(dto)                                │
│                                                                      │
└──────────────────────────┬───────────────────────────────────────────┘
                           │
                           ▼
┌──────────────────────────────────────────────────────────────────────┐
│              🗄️ POSTGRESQL DATABASE (Docker на Selectel)            │
│                      Таблица: orders                                 │
├──────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  11️⃣ INSERT запрос:                                                 │
│                                                                      │
│  INSERT INTO orders (                                                │
│    order_id,         → "ORDER-2026-01-797"                          │
│    user_id,          → NULL (анонимный заказ)                       │
│    from_address,     → "Донецк, ул. Артёма, 1"                      │
│    to_address,       → "Ростов-на-Дону, Главный вокзал"             │
│    from_lat,         → 48.0159   ⚠️ Может быть NULL!                │
│    from_lon,         → 37.8029                                      │
│    to_lat,           → 47.2357                                      │
│    to_lon,           → 39.7015                                      │
│    distance_km,      → 0.00      ⚠️ Пока не вычислено               │
│    raw_price,        → 1500.00                                      │
│    final_price,      → 1700.00                                      │
│    base_cost,        → 0.00                                         │
│    cost_per_km,      → 0.00                                         │
│    status,           → 'pending'  ✅ Ожидает подтверждения          │
│    client_name,      → NULL                                         │
│    client_phone,     → NULL                                         │
│    departure_date,   → 2026-01-28   (DATE)                          │
│    departure_time,   → 10:00:00     (TIME)                          │
│    passengers,       → [{"type":"adult"},{"type":"child",...}]      │
│    baggage,          → [{"size":"m","quantity":2,...}]              │
│    pets,             → []                                           │
│    notes,            → NULL                                         │
│    vehicle_class,    → NULL                                         │
│    trip_type,        → 'group'                                      │
│    direction,        → 'donetskToRostov'                            │
│    created_at,       → 2026-01-26 12:34:56+00                       │
│    updated_at        → 2026-01-26 12:34:56+00                       │
│  )                                                                   │
│                                                                      │
│  12️⃣ Возврат созданной записи                                       │
│      id: "550e8400-e29b-41d4-a716-446655440000" (UUID)              │
│                                                                      │
└──────────────────────────┬───────────────────────────────────────────┘
                           │
                           ▼
┌──────────────────────────────────────────────────────────────────────┐
│                  🔙 ОТВЕТ BACKEND → КЛИЕНТУ                          │
├──────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  HTTP 201 Created                                                    │
│  {                                                                   │
│    "order": {                                                        │
│      "id": "550e8400-e29b-41d4-a716-446655440000",                  │
│      "orderId": "ORDER-2026-01-797",                                │
│      "fromAddress": "Донецк, ул. Артёма, 1",                        │
│      "toAddress": "Ростов-на-Дону, Главный вокзал",                 │
│      "status": "pending",                                           │
│      "finalPrice": 1700.0,                                          │
│      "createdAt": "2026-01-26T12:34:56.000Z",                       │
│      ...                                                             │
│    }                                                                 │
│  }                                                                   │
│                                                                      │
└──────────────────────────┬───────────────────────────────────────────┘
                           │
                           ▼
┌──────────────────────────────────────────────────────────────────────┐
│              📱 FLUTTER ПРИЛОЖЕНИЕ (Клиент)                          │
│              Сохранение в локальный SQLite                           │
├──────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  13️⃣ Сохранение в taxi_orders.db:                                   │
│                                                                      │
│  await OfflineOrdersService.instance.saveOrder(                     │
│    TaxiOrder(                                                        │
│      orderId: "ORDER-2026-01-797",                                  │
│      isSynced: true,  ✅ Помечаем как синхронизированный            │
│      ...                                                             │
│    )                                                                 │
│  );                                                                  │
│                                                                      │
│  14️⃣ Показ уведомления пользователю:                                │
│     "✅ Заказ успешно создан! Ожидает подтверждения диспетчера"     │
│                                                                      │
└──────────────────────────────────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════


┌──────────────────────────────────────────────────────────────────────┐
│          👨‍💼 ДИСПЕТЧЕР ОТКРЫВАЕТ РАЗДЕЛ "ЗАКАЗЫ"                    │
│              lib/features/orders/screens/orders_screen.dart          │
├──────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  15️⃣ Загрузка заказов с backend:                                    │
│     final response = await OrdersApiService.getOrders(              │
│       status: OrderStatus.pending,                                  │
│       limit: 100                                                     │
│     );                                                               │
│                                                                      │
└──────────────────────────┬───────────────────────────────────────────┘
                           │
                           │ 📥 HTTP GET /api/orders?status=pending
                           │    Authorization: Bearer <JWT_TOKEN>
                           │
                           ▼
┌──────────────────────────────────────────────────────────────────────┐
│              🖥️ BACKEND API (Проверка прав доступа)                 │
├──────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  16️⃣ Извлечение JWT токена:                                         │
│     Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6...           │
│     ↓                                                                │
│  17️⃣ Декодирование токена:                                          │
│     payload = {                                                      │
│       "userId": "00000000-0000-0000-0000-000000000002",             │
│       "email": "driver@titotr.ru",                                  │
│       "role": "dispatcher"  ⚠️ ГДЕ БЕРЁТСЯ ЭТА РОЛЬ?               │
│     }                                                                │
│     ↓                                                                │
│  18️⃣ Проверка роли:                                                 │
│     if (userRole == 'dispatcher' || userRole == 'admin') {          │
│       // ✅ Показываем ВСЕ заказы                                   │
│       orders = await orderRepo.findAll(limit: 100);                 │
│     } else {                                                         │
│       // ❌ Только свои заказы                                      │
│       orders = await orderRepo.findByUserId(userId);                │
│     }                                                                │
│     ↓                                                                │
│  19️⃣ SQL запрос:                                                    │
│     SELECT * FROM orders                                            │
│     WHERE status = 'pending'                                        │
│     ORDER BY created_at DESC                                        │
│     LIMIT 100;                                                       │
│                                                                      │
└──────────────────────────┬───────────────────────────────────────────┘
                           │
                           ▼
┌──────────────────────────────────────────────────────────────────────┐
│              🔙 ОТВЕТ BACKEND → ДИСПЕТЧЕРУ                           │
├──────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  HTTP 200 OK                                                         │
│  {                                                                   │
│    "orders": [                                                       │
│      {                                                               │
│        "id": "550e8400-e29b-41d4-a716-446655440000",                │
│        "orderId": "ORDER-2026-01-797",                              │
│        "fromAddress": "Донецк, ул. Артёма, 1",                      │
│        "toAddress": "Ростов-на-Дону, Главный вокзал",               │
│        "status": "pending",                                         │
│        "finalPrice": 1700.0,                                        │
│        "passengers": [{"type":"adult"},{"type":"child"}],           │
│        "baggage": [{"size":"m","quantity":2}],                      │
│        "departureDate": "2026-01-28",                               │
│        "departureTime": "10:00:00",                                 │
│        "createdAt": "2026-01-26T12:34:56.000Z",                     │
│        ...                                                           │
│      },                                                              │
│      // ... другие pending заказы                                   │
│    ],                                                                │
│    "count": 5                                                        │
│  }                                                                   │
│                                                                      │
└──────────────────────────┬───────────────────────────────────────────┘
                           │
                           ▼
┌──────────────────────────────────────────────────────────────────────┐
│          📱 FLUTTER ПРИЛОЖЕНИЕ (Диспетчер)                           │
│          Отображение списка заказов                                  │
├──────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  20️⃣ Парсинг ответа:                                                │
│     List<ApiOrder> orders = response.orders;                        │
│     ↓                                                                │
│  21️⃣ Конвертация ApiOrder → Booking:                                │
│     List<Booking> bookings = orders.map((order) =>                  │
│       Booking.fromApiOrder(order)                                    │
│     ).toList();                                                      │
│     ↓                                                                │
│  22️⃣ Отображение в UI:                                              │
│                                                                      │
│     ┌────────────────────────────────────────────┐                  │
│     │ 📋 ЗАКАЗЫ (5)                              │                  │
│     ├────────────────────────────────────────────┤                  │
│     │ ✅ ORDER-2026-01-797          🔴 Pending   │                  │
│     │    Донецк → Ростов                         │                  │
│     │    28 янв, 10:00  |  1700 ₽               │                  │
│     │    👥 2 чел  🧳 2 средних                  │                  │
│     │    [Подтвердить]  [Отклонить]             │                  │
│     ├────────────────────────────────────────────┤                  │
│     │ ✅ ORDER-2026-01-796          🔴 Pending   │                  │
│     │    ...                                      │                  │
│     └────────────────────────────────────────────┘                  │
│                                                                      │
│  23️⃣ Диспетчер нажимает "Подтвердить":                              │
│     await OrdersApiService.updateOrderStatus(                       │
│       orderId: "ORDER-2026-01-797",                                 │
│       status: OrderStatus.confirmed                                 │
│     );                                                               │
│                                                                      │
└──────────────────────────────────────────────────────────────────────┘
```

---

## 🔍 КЛЮЧЕВЫЕ ТОЧКИ, ГДЕ МОГУТ БЫТЬ ПРОБЛЕМЫ

### ❌ Точка 1: Конвертация Dart types → JSON

**Проблема:** Enum'ы не автоматически конвертируются в строки

```dart
// ❌ НЕПРАВИЛЬНО:
'tripType': TripType.group  // Отправит "TripType.group" вместо "group"

// ✅ ПРАВИЛЬНО:
'tripType': TripType.group.toString().split('.').last  // "group"
```

### ❌ Точка 2: Часовые пояса

**Проблема:** Клиент в UTC, диспетчер в локальном времени

```dart
// Клиент отправляет:
"2026-01-28T10:00:00.000Z"  // UTC

// PostgreSQL хранит:
departure_time: 10:00:00  // БЕЗ timezone!

// Диспетчер видит:
10:00 (в его локальном времени)

// Реальная проблема: если клиент в Москве (UTC+3), а сервер в UTC,
// то 10:00 по Москве = 07:00 UTC!
```

### ❌ Точка 3: JSONB парсинг

**Проблема:** PostgreSQL хранит JSONB, но может не распознать неправильную структуру

```sql
-- ✅ Правильный JSON:
'[{"type":"adult"},{"type":"child","seatType":"booster"}]'

-- ❌ Неправильный JSON (одинарные кавычки):
"[{'type':'adult'}]"

-- ❌ Неправильная структура (backend ждёт другие поля):
'[{"name":"Иван"}]'  -- нет обязательного поля "type"
```

### ❌ Точка 4: Роль пользователя

**Критическая проблема:** Роль НЕ хранится в БД!

```dart
// JWT payload содержит:
{
  "userId": "...",
  "email": "...",
  "role": "dispatcher"  // ⚠️ ГДЕ БЕРЁТСЯ ЭТА РОЛЬ?
}

// Backend проверяет:
if (payload['role'] == 'dispatcher') {
  // Показать все заказы
}

// НО! В таблице users НЕТ поля role!
// Роль берётся из:
// 1. SharedPreferences в приложении (локально)
// 2. JWT токена (выдаётся при логине)
// 3. ??? Откуда backend знает роль при первом логине?
```

**Решение:**
```sql
-- Добавить поле role в таблицу users
ALTER TABLE users ADD COLUMN role VARCHAR(50) DEFAULT 'client';

-- При регистрации/логине backend проверяет роль из БД
-- и добавляет её в JWT payload
```

---

## 📝 ИТОГОВЫЕ ВЫВОДЫ

### ✅ Что работает:
1. Клиент отправляет данные на backend ✅
2. Backend сохраняет в PostgreSQL ✅  
3. Диспетчер получает список заказов ✅

### ❌ Что может НЕ работать:
1. Роли пользователей (нет в БД) ❌
2. Координаты (NOT NULL, но могут быть пустыми) ❌
3. Часовые пояса (UTC vs локальное время) ⚠️
4. JSON структура (клиент vs backend) ⚠️

### 🔧 Первоочередные исправления:
1. **Добавить поле `role` в таблицу `users`**
2. **Сделать координаты nullable** или добавить геокодирование
3. **Проверить структуру JSON** (passengers, baggage, pets)
4. **Настроить timezone** для дат и времени
