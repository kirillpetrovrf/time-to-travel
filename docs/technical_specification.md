# Техническое задание (ТЗ)
## Мобильное приложение "Time to Travel"

---

## 1. ОБЩЕЕ ОПИСАНИЕ ПРИЛОЖЕНИЯ

### 1.1 Назначение
**"Time to Travel"** — мобильное приложение для бронирования междугородних автобусных перевозок между городами Донецк и Ростов-на-Дону. Приложение предназначено для двух категорий пользователей: клиентов (пассажиры) и диспетчеров (управление заказами).

### 1.2 Технологический стек
- **Фронтенд**: Flutter (Dart)
- **Бэкенд**: Firebase (Authentication, Firestore)
- **UI Framework**: Cupertino (iOS-стиль)
- **Карты**: Yandex Maps (планируется)
- **Push-уведомления**: Firebase Cloud Messaging

### 1.3 Основные функции
- Бронирование групповых и индивидуальных поездок
- Управление заказами
- Отслеживание поездок в реальном времени
- Профиль пользователя с настройками
- Система аутентификации по номеру телефона

---

## 2. АРХИТЕКТУРА ПРИЛОЖЕНИЯ

### 2.1 Структура проекта
```
lib/
├── main.dart                    # Точка входа приложения
├── models/                      # Модели данных
│   ├── user.dart               # Модель пользователя
│   ├── booking.dart            # Модель бронирования
│   └── trip_type.dart          # Типы поездок и направления
├── services/                    # Сервисы бизнес-логики
│   ├── auth_service.dart       # Аутентификация
│   ├── user_service.dart       # Управление пользователями
│   └── booking_service.dart    # Управление бронированиями
├── features/                    # Функциональные модули
│   ├── auth/                   # Авторизация
│   ├── home/                   # Главный экран
│   ├── booking/                # Бронирование
│   ├── orders/                 # Заказы
│   ├── tracking/               # Отслеживание
│   └── profile/                # Профиль
└── theme/                      # Темы оформления
    ├── theme_manager.dart      # Менеджер тем
    └── app_theme.dart         # Цветовые схемы
```

### 2.2 Система управления состоянием
- **Provider**: Для глобального состояния (темы, аутентификация)
- **StatefulWidget**: Для локального состояния экранов
- **SharedPreferences**: Для локального хранения данных

---

## 3. ТИПЫ ПОЛЬЗОВАТЕЛЕЙ И ИХ РАЗЛИЧИЯ

### 3.1 Клиент (UserType.client)

#### Права доступа:
- Создание бронирований (групповые и индивидуальные поездки)
- Просмотр своих заказов
- Отслеживание активных поездок
- Управление профилем

#### Интерфейс:
- **Главная**: Дашборд с кнопками быстрого доступа
- **Бронирование**: Выбор типа поездки (групповая/индивидуальная)
- **Мои заказы**: Список собственных бронирований
- **Отслеживание**: Карта с активными поездками
- **Профиль**: Настройки аккаунта

#### Функциональные возможности:
```dart
// Создание группового бронирования
final booking = Booking(
  clientId: currentUser.id,
  tripType: TripType.group,
  direction: Direction.donetskToRostov,
  pickupPoint: selectedPickupPoint,
  // ... другие параметры
);
```

### 3.2 Диспетчер (UserType.dispatcher)

#### Права доступа:
- Просмотр всех активных заказов
- Управление статусами бронирований
- Назначение транспорта
- Отслеживание всех поездок
- Доступ к статистике

#### Интерфейс:
- **Главная**: Статистика и быстрые действия
- **Все заказы**: Полный список заказов с фильтрами
- **Отслеживание**: Карта всех активных поездок
- **Профиль**: Настройки диспетчера

#### Функциональные возможности:
```dart
// Обновление статуса заказа
await BookingService().updateBookingStatus(
  bookingId, 
  BookingStatus.confirmed
);

// Назначение транспорта
await BookingService().assignVehicle(bookingId, vehicleId);
```

---

## 4. ЛОГИКА РАБОТЫ ПРИЛОЖЕНИЯ

### 4.1 Процесс аутентификации

#### Алгоритм входа:
1. Пользователь вводит номер телефона
2. Выбирает тип аккаунта (Клиент/Диспетчер)
3. Система отправляет SMS-код
4. Верификация кода через Firebase Auth
5. Создание/обновление профиля в Firestore
6. Сохранение сессии локально

```dart
// Процесс верификации
Future<bool> verifyCode({
  required String verificationId,
  required String smsCode,
  required String name,
  required UserType userType,
}) async {
  final credential = PhoneAuthProvider.credential(
    verificationId: verificationId,
    smsCode: smsCode,
  );
  
  final authResult = await _firebaseAuth.signInWithCredential(credential);
  // Создание пользователя в Firestore...
}
```

### 4.2 Система бронирования

#### Групповые поездки:
- **Направления**: Донецк ↔ Ростов-на-Дону
- **Расписание**: Фиксированные времена отправления
- **Места посадки**: Предустановленные точки
- **Ценообразование**: Фиксированные тарифы

#### Индивидуальные поездки:
- **Гибкое время**: Выбор любого времени
- **Адреса**: Произвольные точки посадки/высадки
- **Ценообразование**: Динамические тарифы

```dart
// Модель бронирования
class Booking {
  final String id;
  final String clientId;
  final TripType tripType;          // group | individual
  final Direction direction;        // donetskToRostov | rostovToDonetsk
  final DateTime departureDate;
  final String departureTime;
  final int passengerCount;
  final BookingStatus status;       // pending | confirmed | inProgress | completed
  final List<TrackingPoint> trackingPoints;
}
```

### 4.3 Управление состояниями заказов

#### Жизненный цикл заказа:
1. **Pending** - Создан, ожидает подтверждения
2. **Confirmed** - Подтверждён диспетчером
3. **Assigned** - Назначен транспорт
4. **InProgress** - Поездка началась
5. **Completed** - Поездка завершена
6. **Cancelled** - Отменён

```dart
enum BookingStatus {
  pending,
  confirmed,
  assigned,
  inProgress,
  completed,
  cancelled,
}
```

---

## 5. ВЗАИМОДЕЙСТВИЕ С СЕРВЕРОМ

### 5.1 Firebase Authentication
- **Метод**: Phone Authentication
- **SMS-верификация**: Автоматическая через Firebase
- **Токены**: JWT для авторизации запросов

### 5.2 Firestore Database

#### Коллекции:
```
/users/{userId}
- id: string
- phone: string
- name: string
- userType: "UserType.client" | "UserType.dispatcher"
- createdAt: timestamp
- fcmToken: string?

/bookings/{bookingId}
- id: string
- clientId: string
- tripType: "TripType.group" | "TripType.individual"
- direction: Direction
- departureDate: timestamp
- status: BookingStatus
- trackingPoints: TrackingPoint[]
```

#### Индексы:
- `clientId` для быстрого поиска заказов клиента
- `status` для фильтрации активных заказов
- `departureDate` для сортировки по дате

### 5.3 API сервисов

#### AuthService методы:
```dart
Future<bool> isLoggedIn()
Future<User?> getCurrentUser()
Future<UserType?> getUserType()
Future<bool> verifyCode({...})
Future<void> logout()
```

#### BookingService методы:
```dart
Future<String> createBooking(Booking booking)
Future<List<Booking>> getClientBookings(String clientId)
Future<List<Booking>> getActiveBookings()
Future<void> updateBookingStatus(String id, BookingStatus status)
Future<void> assignVehicle(String bookingId, String vehicleId)
```

---

## 6. ПОЛЬЗОВАТЕЛЬСКИЙ ИНТЕРФЕЙС

### 6.1 Навигационная система
- **Bottom Tab Bar**: 5 основных разделов
- **Адаптивная навигация**: Второй таб меняется в зависимости от типа пользователя
  - Клиент: "Бронирование"
  - Диспетчер: "Заказы"

```dart
// Динамическая навигация
Widget _buildSecondTab() {
  if (_userType == UserType.client) {
    return const BookingScreen();
  } else {
    return const OrdersScreen();
  }
}
```

### 6.2 Дизайн-система
- **Стиль**: iOS Cupertino Design
- **Цветовая схема**: Системные цвета iOS
- **Темы**: Светлая и тёмная (настраиваемые)
- **Компоненты**: Нативные iOS виджеты

### 6.3 Экраны приложения

#### Экран авторизации:
- Поле ввода телефона с маской
- Выбор типа пользователя (радио-кнопки)
- Кнопка "Войти" с индикатором загрузки

#### Главный экран:
**Для клиента:**
- Статистика поездок
- Быстрые действия (Забронировать поездку)
- Активные заказы

**Для диспетчера:**
- Общая статистика заказов
- Активные поездки
- Быстрые действия управления

#### Экран бронирования (только клиент):
- Выбор типа поездки
- Групповая: фиксированные параметры
- Индивидуальная: гибкие настройки

---

## 7. БИЗНЕС-ЛОГИКА

### 7.1 Ценообразование

#### Групповые поездки:
```dart
class TripPricing {
  static const Map<Direction, int> groupPrices = {
    Direction.donetskToRostov: 1200,
    Direction.rostovToDonetsk: 1200,
  };
}
```

#### Индивидуальные поездки:
- Базовая стоимость + расчёт по расстоянию
- Надбавки за время суток
- Скидки для постоянных клиентов

### 7.2 Валидация данных

#### Клиентские проверки:
```dart
bool _validateBooking() {
  if (_selectedDate.isBefore(DateTime.now())) {
    _showError('Дата не может быть в прошлом');
    return false;
  }
  
  if (_passengerCount < 1 || _passengerCount > 8) {
    _showError('Количество пассажиров: 1-8');
    return false;
  }
  
  return true;
}
```

#### Серверные проверки:
- Проверка доступности мест
- Валидация временных слотов
- Проверка прав доступа

### 7.3 Система уведомлений

#### Push-уведомления:
- Подтверждение бронирования
- Изменение статуса заказа
- Напоминания о поездке
- Уведомления для диспетчеров о новых заказах

```dart
// FCM токен для уведомлений
Future<void> updateFCMToken(String userId, String fcmToken) async {
  await _firestore.collection('users').doc(userId).update({
    'fcmToken': fcmToken,
  });
}
```

---

## 8. БЕЗОПАСНОСТЬ И ДАННЫЕ

### 8.1 Аутентификация
- **Firebase Auth**: Безопасная SMS-верификация
- **Токены**: Автоматическое обновление JWT
- **Сессии**: Сохранение состояния входа

### 8.2 Авторизация
- **Проверка ролей**: На уровне UI и API
- **Разделение данных**: Клиенты видят только свои заказы
- **Правила Firestore**: Серверная валидация доступа

### 8.3 Защита данных
- **Шифрование**: HTTPS для всех запросов
- **Локальное хранение**: SharedPreferences для несекретных данных
- **Персональные данные**: Минимальный набор (телефон, имя)

---

## 9. ПРОИЗВОДИТЕЛЬНОСТЬ И ОПТИМИЗАЦИЯ

### 9.1 Кэширование
- **Локальное хранение**: Последний экран, предпочтения пользователя
- **Firestore**: Офлайн-кэширование для критичных данных

### 9.2 Загрузка данных
- **Пагинация**: Для больших списков заказов
- **Ленивая загрузка**: Данные загружаются по требованию
- **Индикаторы**: CupertinoActivityIndicator для всех операций

### 9.3 Оптимизация UI
- **Обработка состояний**: Проверка `mounted` перед `setState`
- **Ресурсы**: Правильное освобождение контроллеров
- **Hot Reload**: Поддержка быстрой разработки

---

## 10. ТЕСТИРОВАНИЕ И КАЧЕСТВО

### 10.1 Обработка ошибок
```dart
try {
  final user = await AuthService.instance.getCurrentUser();
  if (mounted) {
    setState(() => _currentUser = user);
  }
} catch (e) {
  if (mounted) {
    _showError('Ошибка загрузки: $e');
  }
}
```

### 10.2 Валидация форм
- Проверка заполнения обязательных полей
- Валидация номеров телефонов
- Проверка дат и времени

### 10.3 Пользовательский опыт
- Информативные сообщения об ошибках
- Индикаторы загрузки
- Подтверждения важных действий

---

## 11. ПЛАНЫ РАЗВИТИЯ

### 11.1 Интеграция карт
- **Yandex Maps**: Отслеживание в реальном времени
- **Геолокация**: Определение местоположения пользователя
- **Маршруты**: Построение оптимальных путей

### 11.2 Дополнительные функции
- **Рейтинги**: Система оценок водителей
- **Чат**: Связь с диспетчером
- **Аналитика**: Детальная статистика для диспетчеров

### 11.3 Серверная часть
- **Faerbase

---

## 12. ЗАКЛЮЧЕНИЕ

Приложение "Time to Travel" представляет собой комплексное решение для управления междугородними перевозками с чётким разделением ролей между клиентами и диспетчерами. Архитектура приложения обеспечивает масштабируемость, безопасность и удобство использования для всех категорий пользователей.

**Ключевые особенности:**
- Разделение интерфейса по типам пользователей
- Полный цикл управления бронированиями
- Современная архитектура на Flutter + Firebase
- Готовность к расширению функциональности

**Текущий статус:** MVP реализован, приложение готово к тестированию и развёртыванию.
