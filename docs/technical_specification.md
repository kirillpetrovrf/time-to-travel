# ТЕХНИЧЕСКОЕ ЗАДАНИЕ (ТЗ) v3.0
## Мобильное приложение "Time to Travel"

### СТАТУС ДОКУМЕНТА: 
- **Версия**: 3.0 (Финальные требования клиента)
- **Дата**: 30 сентября 2025
- **Статус реализации**: В разработке

---

## 1. ОБЩЕЕ ОПИСАНИЕ ПРОЕКТА

### 1.1 Назначение
**"Time to Travel"** — мобильное приложение для бронирования междугородних перевозок между городами Донецк и Ростов-на-Дону с системой детальных остановок, багажа и животных. Приложение ориентировано на максимальную функциональность для клиентов и удобство управления для диспетчеров.

### 1.2 Целевая аудитория
- **Основные пользователи**: Пассажиры, путешествующие между Донецком и Ростовом-на-Дону
- **Административные пользователи**: Диспетчеры для управления заказами и маршрутами
- **Географический охват**: ДНР, Россия (приграничные регионы)

### 1.3 Технологический стек
- **Фронтенд**: Flutter 3.x (Dart)
- **Бэкенд**: Firebase (Authentication, Firestore Database, Cloud Functions)
- **UI Framework**: Cupertino Design System (iOS-стиль)
- **Карты**: Yandex Maps SDK (для свободных маршрутов)
- **Push-уведомления**: Firebase Cloud Messaging (FCM)
- **Внешние интеграции**: 
  - Telegram Bot API (уведомления диспетчеру)
  - VKontakte API (верификация пользователей)
- **Платформы**: iOS, Android

### 1.4 Ключевые особенности приложения
1. **Двухуровневая система бронирования**: Популярные маршруты vs Свободный маршрут
2. **Детальная система остановок**: 11 промежуточных пунктов между городами
3. **Управление багажом**: 4 категории размеров (1 багажное место бесплатно)
4. **Транспортировка животных**: 3 размера с автоматическими рекомендациями
5. **VK-верификация**: Разовая скидка 300₽ для верифицированных пользователей
6. **Telegram-интеграция**: Мгновенные уведомления диспетчеру
7. **Push-уведомления**: Напоминания за 24ч и 1ч до поездки
8. **Выбор автомобиля**: Для индивидуальных поездок (седан, универсал, минивэн, микроавтобус)

---

## 2. ТРЕБОВАНИЯ КЛИЕНТА: ДИЗАЙН И БРЕНДИНГ

### 2.1 Цветовая схема (Корпоративные цвета)
**Основная палитра (на основе сайта клиента):**
- **Красный**: `#E53E3E` - основной акцентный цвет для кнопок, активных элементов
- **Черный**: `#1A1A1A` - основной фон приложения
- **Темно-серый**: `#2D2D2D` - вторичный фон для карточек и контейнеров
- **Белый**: `#FFFFFF` - основной цвет текста и иконок
- **Красная ошибка**: `#FF3B30` - для уведомлений об ошибках
- **Зеленый успех**: `#34C759` - для успешных операций

**Применение цветов:**
- Все кнопки действий: красный фон + белый текст
- Фон приложения: черный или темно-серый
- Текст: белый на темном фоне
- Активные элементы (TabBar, выбранные элементы): красный
- Неактивные элементы: серый (#8E8E93)

### 2.2 Splash Screen (Заставка при запуске)
**Требования к логотипу:**
- **Формат**: Векторный логотип клиента
- **Фон**: Градиент из корпоративных цветов (черный → темно-серый)
- **Анимация**: Плавное появление с масштабированием
- **Длительность**: 2-3 секунды
- **Переход**: Fade out к основному экрану

### 2.3 Иконка приложения
**Требования:**
- Логотип клиента адаптированный для мобильных платформ
- Соответствие Apple Human Interface Guidelines
- Соответствие Material Design Guidelines
- Автоматическая генерация всех размеров: 1024x1024, 512x512, 256x256, 128x128, 64x64

### 2.4 Стиль интерфейса
- **Общий стиль**: Dark Theme с элементами Cupertino Design
- **Типографика**: San Francisco (iOS), Roboto (Android)
- **Закругления**: 12px для карточек, 8px для кнопок
- **Тени**: Мягкие тени для выделения элементов
- **Переходы**: Плавные анимации 300ms для всех интерактивных элементов

---

## 3. АРХИТЕКТУРА СИСТЕМЫ МАРШРУТОВ

### 3.1 Двухуровневая система бронирования

#### 3.1.1 Уровень 1: Тип маршрута
**A. Популярные маршруты (Предустановленные)**
- Донецк ↔ Ростов-на-Дону
- Включает все 11 промежуточных остановок
- Фиксированная стоимость
- Быстрое бронирование

**B. Свободный маршрут (Калькулятор)**
- Пользователь вводит произвольный адрес отправления
- Пользователь вводит произвольный адрес назначения
- Интеграция с Yandex Maps API для расчета расстояния
- Динамическое ценообразование: `базовая_стоимость + (километры × коэффициент)`
- **Управление формулой**: Диспетчер может изменять коэффициенты через админ-панель
- **Условие округления**: Если цена меньше 1,000₽, то минимум 1,000₽
- **Округление вверх**: Если цена 21,150₽, то округление до 22,000₽

```dart
class FreeRouteCalculator {
  static double calculatePrice(double distanceKm, {
    double basePrice = 500,
    double pricePerKm = 15,
    double cityFee = 200,
  }) {
    double price = basePrice + (distanceKm * pricePerKm) + cityFee;
    
    // Минимальная цена
    if (price < 1000) price = 1000;
    
    // Округление вверх до тысяч
    return (price / 1000).ceil() * 1000;
  }
}
```

#### 3.1.2 Уровень 2: Тип поездки
**A. Групповая поездка: 2,000₽ за место**
- Ожидание формирования группы (1-8 человек)
- **Рейсы осуществляются в любом случае** (хоть полная машина, хоть 1 пассажир)
- Фиксированное расписание отправления
- Фиксированное место "Куда" и "Откуда"
- **Выбор машины отсутствует** - назначается диспетчером

**B. Индивидуальная поездка**
- **Дневная**: 8,000₽ (до 22:00)
- **Ночная**: 10,000₽ (после 22:00)
- Немедленное бронирование
- Гибкое время отправления
- Любое место "Куда" и "Откуда"
- **Выбор автомобиля**: седан, универсал, минивэн, микроавтобус

```dart
enum VehicleType {
  sedan('Седан'),
  wagon('Универсал'),
  minivan('Минивэн'),
  microbus('Микроавтобус');
  
  const VehicleType(this.displayName);
  final String displayName;
}

class IndividualTripPricing {
  static double getBasePrice(DateTime departureTime) {
    final hour = departureTime.hour;
    return hour >= 22 || hour < 6 ? 10000 : 8000; // Ночная/дневная
  }
}
```

### 3.2 Детальная система остановок

#### 3.2.1 Управление расписанием через админ-панель
**Функциональность для диспетчера:**
- Ввод времени прибытия для каждой остановки
- Возможность отключения остановок переключателем
- Автоматическое отображение в клиентском приложении через API
- Учет пробок и задержек

#### 3.2.2 Маршрут Донецк → Ростов-на-Дону
**Базовое расписание (примерное время при выезде в 00:00):**
```
1. Донецк (Центральный автовокзал) - 00:00
2. Макеевка (пл. Ленина) - настраивается диспетчером
3. Харцызск (Автостанция) - настраивается диспетчером
4. Иловайск (Центральная площадь) - настраивается диспетчером
5. Кутейниково (Остановка у магазина) - настраивается диспетчером
6. Амвросиевка (Автостанция) - настраивается диспетчером
7. КПП УСПЕНКА (Граница ДНР-РФ) - 01:30 (02:30 с пробками)
8. Матвеев-Курган (Центральная площадь) - настраивается диспетчером
9. Покровское (Автобусная остановка) - настраивается диспетчером
10. Таганрог (Автовокзал) - настраивается диспетчером
11. Ростов-на-Дону (Главный автовокзал) - 03:00 (04:00 с пробками)
```

**Техническая реализация:**
```dart
class RouteSchedule {
  final String stopId;
  final String stopName;
  final Duration estimatedTime;
  final Duration estimatedTimeWithTraffic;
  final bool isActive;
  final bool isCustomizable;
  
  const RouteSchedule({
    required this.stopId,
    required this.stopName,
    required this.estimatedTime,
    required this.estimatedTimeWithTraffic,
    required this.isActive,
    required this.isCustomizable,
  });
}

class ScheduleService {
  Future<void> updateStopSchedule(String stopId, Duration newTime) async {
    await FirebaseFirestore.instance
        .collection('route_schedules')
        .doc(stopId)
        .update({'estimatedTime': newTime.inMinutes});
  }
  
  Future<void> toggleStopActive(String stopId, bool isActive) async {
    await FirebaseFirestore.instance
        .collection('route_schedules')
        .doc(stopId)
        .update({'isActive': isActive});
  }
}
```

---

## 4. СИСТЕМА БАГАЖА (ОБНОВЛЕННАЯ)

### 4.1 Новые правила багажа
**Основное правило**: 1 пассажир = 1 багажное место **БЕСПЛАТНО**
**Дополнительный багаж**: Цены настраиваются диспетчером через API
**Количество**: От 1 до 10 сумок на пассажира

### 4.1.1 Категории багажа (все бесплатно для первого места)
**Размер S (Малый)**
- **Габариты**: 30×40×20 см
- **Примеры**: Рюкзак, небольшая сумка
- **Вес**: до 10 кг
- **Стоимость**: бесплатно (входит в стоимость билета)

**Размер M (Средний)**
- **Габариты**: 50×60×25 см
- **Примеры**: Спортивная сумка, средний чемодан
- **Вес**: до 20 кг
- **Стоимость**: бесплатно (входит в стоимость билета)

**Размер L (Большой)**
- **Габариты**: 70×80×30 см
- **Примеры**: Большой чемодан, коробка
- **Вес**: до 32 кг
- **Стоимость**: бесплатно (входит в стоимость билета)

**Размер CUSTOM (Индивидуальный)**
- **Габариты**: Пользователь указывает вручную (Д×Ш×В)
- **Примеры**: Гитара, микроволновка, нестандартные предметы
- **Поле описания**: "Что везете?" (необязательное)
- **Стоимость**: бесплатно (входит в стоимость билета)

### 4.1.2 Интерфейс выбора багажа (обновленный)
**UX Flow:**
1. Экран "Багаж" с четырьмя карточками размеров (S/M/L/CUSTOM)
2. Для каждого размера:
   - Визуальная иконка
   - Описание габаритов
   - Примеры предметов
   - "БЕСПЛАТНО" для первого места
3. Количество единиц каждого размера (степпер: 1-10 с кнопкой +)
4. Для CUSTOM: модальное окно с полями ввода габаритов
5. **Дополнительный багаж**: Цены загружаются с сервера (настраиваются диспетчером)

**Техническая реализация:**
```dart
class BaggageItem {
  final String id;
  final BaggageSize size;
  final int quantity;
  final String? description;
  final Dimensions? customDimensions;
  final double pricePerExtraItem; // Цена за доп. багаж
  
  double calculateCost() {
    if (quantity <= 1) return 0; // Первое место бесплатно
    return (quantity - 1) * pricePerExtraItem;
  }
}

class BaggagePricingService {
  Future<Map<BaggageSize, double>> getExtraBaggagePrices() async {
    final doc = await FirebaseFirestore.instance
        .collection('settings')
        .doc('baggage_pricing')
        .get();
    
    return {
      BaggageSize.s: doc.data()?['extra_s_price'] ?? 0,
      BaggageSize.m: doc.data()?['extra_m_price'] ?? 0,
      BaggageSize.l: doc.data()?['extra_l_price'] ?? 0,
      BaggageSize.custom: doc.data()?['extra_custom_price'] ?? 0,
    };
  }
}
```

---

## 5. СИСТЕМА ТРАНСПОРТИРОВКИ ЖИВОТНЫХ (ОБНОВЛЕННАЯ)

### 5.1 Обновленные категории животных

#### 5.1.1 Классификация размеров (убран размер XS)
**Размер S (Маленький)**
- **Примеры**: Кошка, маленькая собака (чихуахуа, той-терьер)
- **Транспортировка**: В переноске в салоне
- **Стоимость**: +500₽
- **Ограничения**: До 8 кг

**Размер M (Средний)**
- **Примеры**: Средняя собака (спаниель, бигль)
- **Транспортировка**: **Только индивидуальная поездка** (требует отдельного места)
- **Стоимость**: +2,000₽ + принудительный переход на индивидуальную поездку
- **Ограничения**: До 25 кг
- **Ответственность**: Уведомление с галочкой - владелец обязуется иметь намордник

**Размер L (Большой)**
- **Примеры**: Крупная собака (лабрадор, немецкая овчарка)
- **Транспортировка**: **Только индивидуальная поездка** (требует отдельного места)
- **Стоимость**: +2,000₽ + принудительный переход на индивидуальную поездку
- **Ограничения**: Свыше 25 кг
- **Дополнительные условия**: 
  - Обязательная химчистка после поездки
  - Предотвращение дискомфорта других пассажиров
- **Ответственность**: Уведомление с галочкой - владелец обязуется иметь намордник

#### 5.1.2 Система уведомлений для владельцев
**Обязательное согласие с галочкой:**
- Текст редактируется диспетчером через API
- Отображается в кабинете клиента
- Обязательное согласие для размеров M и L

**Техническая реализация:**
```dart
class PetAgreementService {
  Future<String> getPetAgreementText(PetSize size) async {
    final doc = await FirebaseFirestore.instance
        .collection('settings')
        .doc('pet_agreements')
        .get();
    
    switch (size) {
      case PetSize.m:
        return doc.data()?['medium_pet_agreement'] ?? 
               'Владелец обязуется иметь намордник у собаки.';
      case PetSize.l:
        return doc.data()?['large_pet_agreement'] ?? 
               'Владелец обязуется иметь намордник у собаки и согласен с обязательной химчисткой.';
      default:
        return '';
    }
  }
}

class PetSelectionWidget extends StatefulWidget {
  @override
  Widget build(BuildContext context) {
    return Column(
      children: [
        // Выбор размера животного
        _buildPetSizeSelector(),
        
        // Уведомление и согласие для M/L размеров
        if (_selectedSize == PetSize.m || _selectedSize == PetSize.l)
          _buildAgreementSection(),
      ],
    );
  }
  
  Widget _buildAgreementSection() {
    return FutureBuilder<String>(
      future: PetAgreementService().getPetAgreementText(_selectedSize),
      builder: (context, snapshot) {
        return CheckboxListTile(
          title: Text(snapshot.data ?? ''),
          value: _agreementAccepted,
          onChanged: (value) => setState(() => _agreementAccepted = value!),
        );
      },
    );
  }
}
```

### 5.1.3 Интерфейс выбора животных (обновленный)
**UX Flow:**
1. Экран "Животные" с тремя карточками размеров (S/M/L)
2. Для каждого размера:
   - Иконка животного
   - Примеры животных
   - Способ транспортировки
   - Стоимость
3. При выборе размера M, L:
   - Уведомление о переходе на индивидуальную поездку
   - Обязательное согласие с условиями (галочка)
   - Текст согласия загружается с сервера
4. Поле "Описание животного" (необязательное): порода, особенности

---

## 6. ИНТЕГРАЦИЯ С VKONTAKTE (ОБНОВЛЕННАЯ)

### 6.1 Система верификации через VK

#### 6.1.1 Процесс верификации
**Шаги верификации:**
1. Пользователь нажимает "Подтвердить через VK" в профиле
2. OAuth авторизация через VK SDK
3. Получение основной информации профиля:
   - ID пользователя VK
   - Имя и фамилия
   - Фото профиля
   - Статус верификации профиля
4. Сохранение VK ID в профиле пользователя
5. Активация **разовой** скидки 300₽

#### 6.1.2 Система скидок (обновленная)
**Логика применения скидки:**
- **Размер скидки**: 300₽ фиксированно
- **Применение**: **РАЗОВАЯ СКИДКА** только на первый заказ верифицированного пользователя
- **Отображение**: В корзине отдельной строкой "Скидка VK: -300₽" (только для первого заказа)
- **Ограничения**: Одна скидка на пользователя навсегда

**Техническая реализация:**
```dart
class VKDiscountService {
  Future<bool> canUseVKDiscount(String userId) async {
    final user = await UserService().getUser(userId);
    
    // Проверяем верификацию и использование скидки
    return user.isVKVerified && !user.hasUsedVKDiscount;
  }
  
  Future<void> markVKDiscountAsUsed(String userId) async {
    await FirebaseFirestore.instance
        .collection('users')
        .doc(userId)
        .update({'hasUsedVKDiscount': true});
  }
}

class User {
  final String id;
  final bool isVKVerified;
  final bool hasUsedVKDiscount;
  
  bool get canUseVKDiscount => isVKVerified && !hasUsedVKDiscount;
}
```

### 6.2 Интерфейс верификации (обновленный)
**UX Flow:**
1. В профиле пользователя карточка "Верификация VK"
2. Если не верифицирован: кнопка "Подтвердить через VK" + "получи скидку 300₽ на поездку"
3. Если верифицирован и скидка не использована: "Скидка 300₽ доступна"
4. Если верифицирован и скидка использована: "Скидка VK использована"
5. Процесс верификации: WebView с VK OAuth → возврат в приложение → обновление профиля

---

## 7. ИНТЕГРАЦИЯ С TELEGRAM

### 7.1 Система уведомлений диспетчеру

#### 7.1.1 Типы уведомлений
**Новый заказ (краткий формат):**
```
НОВЫЙ ЗАКАЗ #12345

👤 Клиент: Иван Петров (+7 900 123-45-67)
📅 Дата: 15 декабря 2024, 14:00
🛣 Маршрут: Донецк → Ростов-на-Дону
   └ Отправление: Донецк (Центральный автовокзал)
   └ Прибытие: Ростов-на-Дону (Главный автовокзал)

👥 Тип: Групповая поездка (2 пассажира)
💰 Стоимость: 2,000₽

🧳 Багаж: Без дополнительного багажа
🐕 Животные: Средняя собака (размер M): +2,000₽

💳 Итого к оплате: 4,000₽
✅ Статус: Ожидает подтверждения

[Подтвердить] [Отклонить] [Перенести]
```

**Краткий формат (как в примере клиента):**
```
29.09 1 чел 6:00
Ростов - Макеевка 
+79490490677 Георгий
Без багажа 
2000₽
```

**Отмена заказа:**
```
❌ ОТМЕНА ЗАКАЗА #12345

👤 Клиент: Иван Петров
📅 Отменена поездка: 15 декабря 2024, 14:00
🛣 Маршрут: Донецк → Ростов-на-Дону
💰 Возврат: 4,000₽

⏰ Время до поездки: 18 часов
📋 Причина: Изменились планы
```

#### 7.1.2 Техническая реализация
```dart
class TelegramService {
  static const String botToken = 'BOT_TOKEN';
  static const String dispatcherChatId = 'DISPATCHER_CHAT_ID';
  
  Future<void> sendShortOrderNotification(Order order) async {
    final message = _formatShortOrderMessage(order);
    await _sendMessage(dispatcherChatId, message);
  }
  
  String _formatShortOrderMessage(Order order) {
    final date = DateFormat('dd.MM').format(order.departureDate);
    final time = DateFormat('HH:mm').format(order.departureTime);
    
    return '''
${date} ${order.passengerCount} чел ${time}
${order.route.from} - ${order.route.to}
${order.clientPhone} ${order.clientName}
${order.baggageInfo.isEmpty ? 'Без багажа' : order.baggageInfo}
${order.totalPrice}₽
    ''';
  }
}
```

---

## 8. СИСТЕМА PUSH-УВЕДОМЛЕНИЙ

### 8.1 Типы уведомлений пользователям

#### 8.1.1 Уведомления-напоминания
**За 24 часа до поездки:**
```
⏰ Напоминание о поездке

Завтра в 14:00 ваша поездка Донецк → Ростов-на-Дону
Заказ #12345

📍 Место отправления: Центральный автовокзал
⏰ Время: 15 декабря, 14:00

Рекомендуем подготовить:
• Документы для пересечения границы
• Документы на животных (если есть)
• Быть на месте за 15 минут до отправления
```

**За 1 час до поездки:**
```
🚗 Скоро отправление!

Через час ваша поездка Донецк → Ростов-на-Дону
Заказ #12345

📍 Место: Центральный автовокзал
⏰ Время: 15 декабря, 14:00
🚗 Водитель уже в пути к месту посадки

📱 Контакт водителя: +7 900 555-44-33
```

#### 8.1.2 Уведомления о статусе заказа
**Подтверждение заказа:**
```
✅ Заказ подтвержден!

Ваш заказ #12345 подтвержден диспетчером
Поездка: Донецк → Ростов-на-Дону
Дата: 15 декабря 2024, 14:00

Детали заказа доступны в приложении
```

**Отклонение заказа:**
```
❌ Заказ отклонен

К сожалению, ваш заказ #12345 отклонен
Причина: Нет свободных мест на выбранную дату

💰 Средства возвращены на ваш счет
🔄 Попробуйте выбрать другую дату
```

#### 8.1.3 Уведомление после создания заказа
**Сразу после создания:**
```
Спасибо за заказ! За день до поездки водитель свяжется с вами 
или наберет диспетчер для уточнения деталей поездки.
```

---

## 9. АДМИНИСТРАТИВНАЯ ПАНЕЛЬ ДИСПЕТЧЕРА

### 9.1 Управление контентом

#### 9.1.1 Редактирование описаний поездок
**Функциональность:**
- Редактирование описаний для популярных маршрутов
- Добавление специальных предложений и акций
- Обновление расписания и стоимости
- Управление доступностью маршрутов
- **Управление формулой свободных маршрутов** (базовая ставка, коэффициент за км, городские доплаты)

#### 9.1.2 Управляемые через CMS описания
**Требования:**
- Блок с описанием под выбором типа поездки
- Контент управляется через кабинет диспетчера
- API для обновления описаний в реальном времени
- Возможность форматирования текста

```dart
class ContentManagementService {
  Future<void> updateTripDescription(TripType tripType, String description) async {
    await FirebaseFirestore.instance
        .collection('content')
        .doc('trip_descriptions')
        .update({tripType.toString(): description});
  }
  
  Future<void> updateFreeRouteFormula({
    required double basePrice,
    required double pricePerKm,
    required double cityFee,
  }) async {
    await FirebaseFirestore.instance
        .collection('settings')
        .doc('free_route_pricing')
        .update({
          'basePrice': basePrice,
          'pricePerKm': pricePerKm,
          'cityFee': cityFee,
        });
  }
}
```

### 9.2 Управление заказами

#### 9.2.1 Интерфейс управления заказами
**Функции диспетчера:**
- Просмотр всех заказов (новые, подтвержденные, выполненные)
- Подтверждение/отклонение заказов
- Назначение водителей
- Группировка пассажиров для групповых поездок
- Отправка уведомлений клиентам
- **Назначение автомобилей** для индивидуальных поездок

#### 9.2.2 Секретный вход для диспетчера
**Способы входа:**
1. **Отдельное приложение** для диспетчеров
2. **Секретная функция**: 7 раз нажать правый верхний угол → вход диспетчера

```dart
class SecretDispatcherAccess {
  int _tapCount = 0;
  
  void handleTap() {
    _tapCount++;
    if (_tapCount >= 7) {
      _showDispatcherLogin();
      _tapCount = 0;
    }
    
    // Сброс счетчика через 5 секунд
    Timer(Duration(seconds: 5), () => _tapCount = 0);
  }
  
  void _showDispatcherLogin() {
    showDialog(
      context: context,
      builder: (context) => DispatcherLoginDialog(),
    );
  }
}
```

---

## 10. РАСШИРЕННЫЙ ПРОФИЛЬ ПОЛЬЗОВАТЕЛЯ

### 10.1 Дополнительные поля профиля

#### 10.1.1 Личная информация (обновленная)
**Обязательные поля:**
- **Фамилия**: По паспорту
- **Имя**: Полное имя пользователя по паспорту
- **Отчество**: По желанию клиента
- **Дата рождения**: Для возрастных ограничений и скидок
- **Пол**: Мужской/Женский (обязательно, переключателем)
- **Доверенное лицо**: Телефон для экстренных случаев с родственниками

**Необязательные поля:**
- Фото профиля
- Предпочтения поездок
- История заказов

#### 10.1.2 Верификация и бонусы
**VK Верификация:**
- Статус верификации
- Имя из VK профиля
- Фото профиля VK
- Дата верификации
- Активная разовая скидка 300₽

**История поездок:**
- Количество поездок
- Статус клиента (новый, постоянный, VIP)
- Накопленные бонусы
- История отзывов

```dart
class ExpandedUserProfile {
  final String id;
  final String phone;
  final String firstName;
  final String lastName;
  final String? middleName;
  final DateTime birthDate;
  final Gender gender;
  final String emergencyContact;
  final String? profilePhotoUrl;
  
  // VK верификация
  final bool isVKVerified;
  final String? vkId;
  final String? vkName;
  final String? vkPhotoUrl;
  final bool hasUsedVKDiscount;
  
  // Статистика
  final int completedTrips;
  final CustomerTier tier;
  final List<Review> reviews;
}

enum Gender { male, female }
enum CustomerTier { new, regular, vip }
```

---

## 11. КАЛЬКУЛЯТОР СВОБОДНЫХ МАРШРУТОВ

### 11.1 Интеграция с Yandex Maps

#### 11.1.1 Расчет расстояния и стоимости
**Функциональность:**
- Автокомплит адресов через Yandex Geocoding API
- Расчет оптимального маршрута через Yandex Directions API
- Динамическое ценообразование на основе расстояния
- Учет загруженности дорог и пробок

**Формула ценообразования (управляемая диспетчером):**
```
Стоимость = Базовая_ставка + (Расстояние_км × Коэффициент_за_км) + Городские_доплаты
```

**Где (настраивается через админ-панель):**
- **Базовая ставка**: 500₽ (стартовая цена)
- **Коэффициент за км**: 15₽/км
- **Городские доплаты**: +200₽ при поездке в крупные города

#### 11.1.2 Техническая реализация
```dart
class YandexMapsService {
  static const String apiKey = 'YANDEX_MAPS_API_KEY';
  
  Future<RouteCalculationResult> calculateRoute({
    required String fromAddress,
    required String toAddress,
  }) async {
    // 1. Geocoding - получаем координаты
    final fromCoords = await _geocodeAddress(fromAddress);
    final toCoords = await _geocodeAddress(toAddress);
    
    // 2. Directions - рассчитываем маршрут
    final route = await _calculateDirections(fromCoords, toCoords);
    
    // 3. Загружаем настройки ценообразования
    final pricing = await _loadPricingSettings();
    
    // 4. Ценообразование с округлением
    final price = _calculatePriceWithRounding(route.distanceKm, pricing);
    
    return RouteCalculationResult(
      distance: route.distanceKm,
      duration: route.durationMinutes,
      price: price,
      waypoints: route.waypoints,
    );
  }
  
  double _calculatePriceWithRounding(double distanceKm, PricingSettings pricing) {
    double price = pricing.basePrice + 
                   (distanceKm * pricing.pricePerKm) + 
                   pricing.cityFee;
    
    // Минимальная цена 1,000₽
    if (price < 1000) price = 1000;
    
    // Округление вверх до тысяч
    return (price / 1000).ceil() * 1000.0;
  }
}

class PricingSettings {
  final double basePrice;
  final double pricePerKm;
  final double cityFee;
  
  const PricingSettings({
    required this.basePrice,
    required this.pricePerKm,
    required this.cityFee,
  });
}
```

### 11.2 Интерфейс калькулятора
**UX Flow:**
1. Пользователь выбирает "Свободный маршрут"
2. Два поля ввода с автокомплитом:
   - "Откуда" (текущее местоположение по умолчанию)
   - "Куда"
3. При вводе показываются подсказки адресов
4. После выбора адресов автоматический расчет:
   - Расстояние в км
   - Время в пути
   - Стоимость поездки (с учетом округления)
5. Кнопка "Забронировать" → переход к выбору типа поездки

---

## 12. СТАТУСЫ И ЖИЗНЕННЫЙ ЦИКЛ ЗАКАЗОВ

### 12.1 Состояния заказа

#### 12.1.1 Основные статусы
**CREATED** (Создан)
- Заказ создан пользователем
- Ожидает оплаты (если настроена предоплата)
- Доступен для редактирования

**PENDING** (Ожидает подтверждения)
- Заказ оплачен и отправлен диспетчеру
- Диспетчер получил уведомление в Telegram
- Пользователь видит "Ожидает подтверждения"

**CONFIRMED** (Подтвержден)
- Диспетчер подтвердил заказ
- Назначен водитель и автомобиль
- Пользователь получает push-уведомление

**IN_PROGRESS** (В пути)
- Поездка началась
- Активно отслеживание местоположения
- Доступна связь с водителем

**COMPLETED** (Завершен)
- Поездка успешно завершена
- Доступна оценка и отзыв
- Заказ переходит в историю

**CANCELLED** (Отменен)
- Отменен пользователем или диспетчером
- Возврат средств (если применимо)
- Указание причины отмены

```dart
enum OrderStatus {
  created,
  pending,
  confirmed,
  inProgress,
  completed,
  cancelled,
}

class OrderStateMachine {
  static bool canTransition(OrderStatus from, OrderStatus to) {
    switch (from) {
      case OrderStatus.created:
        return [OrderStatus.pending, OrderStatus.cancelled].contains(to);
      case OrderStatus.pending:
        return [OrderStatus.confirmed, OrderStatus.cancelled].contains(to);
      case OrderStatus.confirmed:
        return [OrderStatus.inProgress, OrderStatus.cancelled].contains(to);
      case OrderStatus.inProgress:
        return [OrderStatus.completed, OrderStatus.cancelled].contains(to);
      case OrderStatus.completed:
      case OrderStatus.cancelled:
        return false; // Финальные состояния
    }
  }
}
```

### 12.2 Уведомления по статусам
**При каждом изменении статуса:**
- Push-уведомление пользователю
- Уведомление в Telegram диспетчеру 
- Обновление в реальном времени в приложении

---

## 13. СИСТЕМА ОПЛАТЫ И ЦЕНООБРАЗОВАНИЯ

### 13.1 Структура ценообразования

#### 13.1.1 Базовая стоимость
**Популярные маршруты:**
- **Донецк ↔ Ростов-на-Дону**: 2,000₽ за посадку
- **Промежуточные остановки**: 2,000₽ за посадку
- **Групповая поездка**: 2,000₽ за посадку
- **Индивидуальная поездка**: 8,000₽ (днем) / 10,000₽ (ночью)

#### 13.1.2 Дополнительные услуги
**Багаж:**
- **Первое место**: БЕСПЛАТНО (любой размер S/M/L/Custom)
- **Дополнительный багаж**: Цены настраиваются диспетчером через API

**Животные:**
- **S** (до 8 кг): +500₽
- **M** (до 25 кг): +2,000₽ + принудительная индивидуальная поездка
- **L** (свыше 25 кг): +2,000₽ + принудительная индивидуальная поездка

**Скидки:**
- **VK верификация**: -300₽ (разовая)
- **Постоянный клиент** (10+ поездок): -5%

#### 13.1.3 Расчет итоговой стоимости
```dart
class PriceCalculator {
  static double calculateTotalPrice({
    required Route route,
    required TripType tripType,
    required List<BaggageItem> baggage,
    required List<PetInfo> pets,
    required bool canUseVKDiscount,
    required CustomerTier customerTier,
    required DateTime departureTime,
  }) {
    double basePrice = route.basePrice;
    
    // Тип поездки
    if (tripType == TripType.individual) {
      basePrice = IndividualTripPricing.getBasePrice(departureTime);
    }
    
    // Багаж (первое место бесплатно)
    double baggagePrice = baggage.fold(0.0, (sum, item) => sum + item.calculateCost());
    
    // Животные
    double petPrice = pets.fold(0.0, (sum, pet) => sum + pet.cost);
    
    double totalPrice = basePrice + baggagePrice + petPrice;
    
    // Скидки
    if (canUseVKDiscount) totalPrice -= 300.0;
    if (customerTier == CustomerTier.vip) totalPrice *= 0.95; // -5%
    
    return totalPrice;
  }
}
```

### 13.2 Интеграция платежных систем
**Способы оплаты:**
- **Наличные**: Оплата водителю при посадке
- **SBP (Система быстрых платежей)**: QR-код оплата
  - Подготовить интеграцию с возможностью вставить ссылку в кабинете диспетчера
  - Возможность отключения через админ-панель

```dart
class PaymentService {
  Future<String?> getSBPPaymentUrl(double amount, String orderId) async {
    final settings = await FirebaseFirestore.instance
        .collection('settings')
        .doc('payment')
        .get();
    
    final sbpEnabled = settings.data()?['sbp_enabled'] ?? false;
    if (!sbpEnabled) return null;
    
    final baseUrl = settings.data()?['sbp_url'] ?? '';
    return '$baseUrl?amount=$amount&order=$orderId';
  }
}
```

---

## 14. МОНИТОРИНГ И АНАЛИТИКА

### 14.1 Сбор данных о поездках

#### 14.1.1 Метрики пользователей
**Основные показатели:**
- Количество успешных бронирований
- Средняя стоимость заказа
- Популярные маршруты
- Время отклика на подтверждение заказов
- Процент отмен заказов

```dart
class AnalyticsService {
  static void trackBookingStarted({
    required String routeType,
    required String tripType,
  }) {
    FirebaseAnalytics.instance.logEvent(
      name: 'booking_started',
      parameters: {
        'route_type': routeType,
        'trip_type': tripType,
      },
    );
  }
  
  static void trackBookingCompleted({
    required Order order,
  }) {
    FirebaseAnalytics.instance.logEvent(
      name: 'booking_completed',
      parameters: {
        'order_id': order.id,
        'total_price': order.totalPrice,
        'has_pets': order.pets.isNotEmpty,
        'extra_baggage': order.baggage.where((b) => b.quantity > 1).length,
      },
    );
  }
}
```

### 14.2 Панель аналитики для диспетчера
**Основные отчеты:**
- Ежедневная статистика заказов
- Популярность маршрутов
- Выручка по периодам
- Эффективность водителей
- Отзывы и рейтинги

---

## 15. БЕЗОПАСНОСТЬ И ПРОИЗВОДИТЕЛЬНОСТЬ

### 15.1 Безопасность данных

#### 15.1.1 Защита персональных данных
**Меры безопасности:**
- Шифрование данных при передаче (HTTPS/TLS)
- Хеширование паролей (если используются)
- Ограничение доступа к Firebase через Security Rules
- Аудит доступа к данным

**Firebase Security Rules:**
```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Пользователи могут читать и изменять только свои данные
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Заказы доступны только создателю и диспетчерам
    match /orders/{orderId} {
      allow read, write: if request.auth != null && 
        (resource.data.clientId == request.auth.uid || 
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.userType == 'dispatcher');
    }
  }
}
```

#### 15.1.2 Валидация данных
**Входящие данные:**
- Проверка номеров телефонов
- Санитизация текстовых полей
- Ограничение размеров файлов

### 15.2 Оптимизация производительности

#### 15.2.1 Кеширование и оффлайн-режим
**Стратегии кеширования:**
- Кеширование маршрутов и остановок
- Локальное хранение истории поездок
- Офлайн-режим для просмотра активных заказов

```dart
class CacheManager {
  static final _cache = <String, dynamic>{};
  
  static Future<T?> getCachedData<T>(String key) async {
    final cached = _cache[key];
    if (cached != null && !_isExpired(cached['timestamp'])) {
      return cached['data'] as T;
    }
    return null;
  }
  
  static void setCachedData(String key, dynamic data) {
    _cache[key] = {
      'data': data,
      'timestamp': DateTime.now(),
    };
  }
}
```

#### 15.2.2 Оптимизация изображений и ресурсов
- Сжатие изображений логотипов
- Ленивая загрузка списков
- Использование векторных иконок
- Минимизация размера APK/IPA

---

## 16. ТЕСТИРОВАНИЕ И РАЗВЕРТЫВАНИЕ

### 16.1 Стратегия тестирования

#### 16.1.1 Виды тестирования
**Unit тесты:**
- Тестирование бизнес-логики (калькулятор цен, валидация данных)
- Тестирование моделей данных
- Тестирование сервисов

**Integration тесты:**
- Тестирование интеграции с Firebase
- Тестирование API calls (VK, Telegram, Yandex)
- Тестирование push-уведомлений

**UI тесты:**
- Тестирование основных пользовательских сценариев
- Тестирование responsive дизайна
- Тестирование доступности

#### 16.1.2 Автоматизация тестирования
```dart
// Пример unit теста
void main() {
  group('PriceCalculator', () {
    test('should calculate correct price with VK discount', () {
      final price = PriceCalculator.calculateTotalPrice(
        route: popularRoute,
        tripType: TripType.group,
        baggage: [],
        pets: [],
        canUseVKDiscount: true,
        customerTier: CustomerTier.regular,
        departureTime: DateTime.now(),
      );
      
      expect(price, 1700); // 2000 - 300 VK discount
    });
  });
}
```

### 16.2 Развертывание

#### 16.2.1 Среды развертывания
**Development (разработка):**
- Firebase проект для разработки
- Тестовые данные
- Debug-режим приложения

**Staging (тестирование):**
- Копия production окружения
- Тестирование перед релизом
- UAT (User Acceptance Testing)

**Production (продакшн):**
- Реальная Firebase среда
- Мониторинг производительности
- Автоматические бэкапы

#### 16.2.2 CI/CD Pipeline
**Автоматизация развертывания:**
- GitHub Actions для автоматической сборки
- Автоматическое тестирование при commit
- Автоматическая публикация в магазины приложений

### 16.3 Размещение в маркетплейсах
**Планируемые площадки (без политических ограничений):**
- **RuStore**: Российский магазин приложений
- **Google Play Market**: Глобальная платформа Android
- **Apple App Store**: Платформа iOS

---

## 17. ЗАКЛЮЧЕНИЕ

### 17.1 Ключевые преимущества решения
1. **Полная автоматизация**: От бронирования до уведомлений
2. **Гибкость маршрутов**: Популярные + свободные маршруты с управляемым ценообразованием
3. **Детальный учет**: Багаж (1 место бесплатно), животные, индивидуальные потребности
4. **Современный UX**: iOS-стиль, интуитивный интерфейс
5. **Интеграции**: VK (разовая скидка), Telegram, Yandex Maps
6. **Административные возможности**: Полное управление через кабинет диспетчера
7. **Масштабируемость**: Готовность к росту количества пользователей

### 17.2 Критерии успеха
**Технические метрики:**
- Время загрузки экранов < 2 сек
- Доступность сервиса > 99.5%
- Время отклика API < 500ms

**Бизнес-метрики:**
- Конверсия в заказ > 15%
- Повторные заказы > 30%
- Средняя оценка в магазинах приложений > 4.5

### 17.3 Риски и митигация
**Технические риски:**
- Сбои Firebase → Backup-стратегии
- Проблемы с внешними API → Fallback-решения
- Нагрузка на сервера → Масштабирование

**Бизнес-риски:**
- Низкое принятие → Маркетинговая поддержка
- Конкуренция → Уникальные функции (секретный вход диспетчера, управляемое ценообразование)
- Изменения законодательства → Гибкая архитектура

---

**КОНЕЦ ТЕХНИЧЕСКОГО ЗАДАНИЯ v3.0**
- **Внешние интеграции**: 
  - Telegram Bot API (уведомления диспетчеру)
  - VKontakte API (верификация пользователей)
- **Платформы**: iOS, Android

### 1.4 Ключевые особенности приложения
1. **Двухуровневая система бронирования**: Популярные маршруты vs Свободный маршрут
2. **Детальная система остановок**: 11 промежуточных пунктов между городами
3. **Управление багажом**: 4 категории размеров + индивидуальные габариты
4. **Транспортировка животных**: 4 размера с автоматическими рекомендациями
5. **VK-верификация**: Система скидок для верифицированных пользователей
6. **Telegram-интеграция**: Мгновенные уведомления диспетчеру
7. **Push-уведомления**: Напоминания за 24ч и 1ч до поездки

---

## 2. ТРЕБОВАНИЯ КЛИЕНТА: ДИЗАЙН И БРЕНДИНГ

### 2.1 Цветовая схема (Корпоративные цвета)
**Основная палитра (на основе сайта клиента):**
- **Красный**: `#E53E3E` - основной акцентный цвет для кнопок, активных элементов
- **Черный**: `#1A1A1A` - основной фон приложения
- **Темно-серый**: `#2D2D2D` - вторичный фон для карточек и контейнеров
- **Белый**: `#FFFFFF` - основной цвет текста и иконок
- **Красная ошибка**: `#FF3B30` - для уведомлений об ошибках
- **Зеленый успех**: `#34C759` - для успешных операций

**Применение цветов:**
- Все кнопки действий: красный фон + белый текст
- Фон приложения: черный или темно-серый
- Текст: белый на темном фоне
- Активные элементы (TabBar, выбранные элементы): красный
- Неактивные элементы: серый (#8E8E93)

### 2.2 Splash Screen (Заставка при запуске)
**Требования к логотипу:**
- **Формат**: Векторный логотип клиента
- **Фон**: Градиент из корпоративных цветов (черный → темно-серый)
- **Анимация**: Плавное появление с масштабированием
- **Длительность**: 2-3 секунды
- **Переход**: Fade out к основному экрану

**Техническая реализация:**
```dart
// Анимация логотипа
AnimationController _splashController;
Animation<double> _fadeAnimation;
Animation<double> _scaleAnimation;
Animation<Offset> _slideAnimation;
```

### 2.3 Иконка приложения
**Требования:**
- Логотип клиента адаптированный для мобильных платформ
- Соответствие Apple Human Interface Guidelines
- Соответствие Material Design Guidelines
- Автоматическая генерация всех размеров: 1024x1024, 512x512, 256x256, 128x128, 64x64

### 2.4 Стиль интерфейса
- **Общий стиль**: Dark Theme с элементами Cupertino Design
- **Типографика**: San Francisco (iOS), Roboto (Android)
- **Закругления**: 12px для карточек, 8px для кнопок
- **Тени**: Мягкие тени для выделения элементов
- **Переходы**: Плавные анимации 300ms для всех интерактивных элементов

---

## 3. АРХИТЕКТУРА СИСТЕМЫ МАРШРУТОВ

### 3.1 Двухуровневая система бронирования

#### 3.1.1 Уровень 1: Тип маршрута
**A. Популярные маршруты (Предустановленные)**
- Донецк ↔ Ростов-на-Дону
- Включает все 11 промежуточных остановок
- Фиксированная стоимость
- Быстрое бронирование

**B. Свободный маршрут (Калькулятор)**
- Пользователь вводит произвольный адрес отправления
- Пользователь вводит произвольный адрес назначения
- Интеграция с Yandex Maps API для расчета расстояния
- Динамическое ценообразование: `базовая_стоимость + (километры × коэффициент)`

#### 3.1.2 Уровень 2: Тип поездки
**A. Групповая поездка**: 2 000 руб. - место.
- Ожидание формирования группы (4-8 человек)
- Нижняя стоимость за счет совместной поездки
- Фиксированное расписание отправления
- Фиксированное место Куда и Откуда

**B. Индивидуальная поездка**: 8 000 руб. - днем. 10 000 руб.- ночные после 22.00
- Немедленное бронирование
- Повышенная стоимость
- Гибкое время отправления
- Любое место Куда и Откуда

### 3.2 Детальная система остановок

#### 3.2.1 Маршрут Донецк → Ростов-на-Дону - 
```
1. Донецк (Центральный автовокзал) - 00:00
2. Макеевка (пл. Ленина) - 00:20
3. Харцызск (Автостанция) - 00:45
4. Иловайск (Центральная площадь) - 01:10
5. Кутейниково (Остановка у магазина) - 01:30
6. Амвросиевка (Автостанция) - 01:50
7. КПП УСПЕНКА (Граница ДНР-РФ) - 02:20
8. Матвеев-Курган (Центральная площадь) - 02:50
9. Покровское (Автобусная остановка) - 03:15
10. Таганрог (Автовокзал) - 03:45
11. Ростов-на-Дону (Главный автовокзал) - 04:30
```



---

## 4. СИСТЕМА БАГАЖА

### 4.1 Категории багажа

#### 4.1.1 Стандартные размеры
**Размер S (Малый)**
- **Габариты**: 30×40×20 см
- **Примеры**: Рюкзак, небольшая сумка
- **Вес**: до 10 кг
- **Стоимость**: бесплатно (входит в стоимость билета)

**Размер M (Средний)**
- **Габариты**: 50×60×25 см
- **Примеры**: Спортивная сумка, средний чемодан
- **Вес**: до 20 кг
- **Стоимость**: +100₽ к стоимости билета

**Размер L (Большой)**
- **Габариты**: 70×80×30 см
- **Примеры**: Большой чемодан, коробка
- **Вес**: до 32 кг
- **Стоимость**: +200₽ к стоимости билета

**Размер CUSTOM (Индивидуальный)**
- **Габариты**: Пользователь указывает вручную (Д×Ш×В)
- **Примеры**: Гитара, микроволновка, нестандартные предметы
- **Поле описания**: "Что везете?" (необязательное)
- **Стоимость**: рассчитывается по объему: `(Д×Ш×В) / 1000 × 5₽`

#### 4.1.2 Интерфейс выбора багажа
**UX Flow:**
1. Экран "Багаж" с четырьмя карточками размеров (S/M/L/CUSTOM)
2. Для каждого размера: 
   - Визуальная иконка
   - Описание габаритов
   - Примеры предметов
   - Стоимость
3. Количество единиц каждого размера (степпер: 0-5)
4. Для CUSTOM: модальное окно с полями ввода габаритов
5. Итоговая стоимость багажа обновляется в реальном времени

**Техническая реализация:**
```dart
class BaggageItem {
  final String id;
  final BaggageSize size;
  final int quantity;
  final String? description; // Для CUSTOM
  final Dimensions? customDimensions; // Для CUSTOM
  final double cost;
}

enum BaggageSize { s, m, l, custom }

class Dimensions {
  final double length;
  final double width;
  final double height;
  
  double get volume => length * width * height;
}
```

---

## 5. СИСТЕМА ТРАНСПОРТИРОВКИ ЖИВОТНЫХ

### 5.1 Категории животных по размеру

#### 5.1.1 Классификация размеров
**Размер XS (Очень маленький)**
- **Примеры**: Хомяк, попугай, кролик
- **Транспортировка**: В переноске на коленях
- **Стоимость**: +100₽
- **Ограничения**: До 3 кг

**Размер S (Маленький)**
- **Примеры**: Кошка, маленькая собака (чихуахуа, той-терьер)
- **Транспортировка**: В переноске в салоне
- **Стоимость**: +500₽
- **Ограничения**: До 8 кг

**Размер M (Средний)**
- **Примеры**: Средняя собака (спаниель, бигль)
- **Транспортировка**: **Только индивидуальная поездка** (требует отдельного места)
- **Стоимость**: +2000₽ + принудительный переход на индивидуальную поездку
- **Ограничения**: До 25 кг

**Размер L (Большой)**
- **Примеры**: Крупная собака (лабрадор, немецкая овчарка)
- **Транспортировка**: **Только индивидуальная поездка** (требует отдельного места)
- **Стоимость**: +2000₽ + принудительный переход на индивидуальную поездку
- **Ограничения**: Свыше 25 кг

#### 5.1.2 Автоматические рекомендации системы
**Логика принудительного перехода:**
```dart
if (selectedPetSize == PetSize.L) {
  // Автоматически переключить на индивидуальную поездку
  showDialog(
    context: context,
    builder: (context) => AlertDialog(
      title: Text('Требуется индивидуальная поездка'),
      content: Text('Для крупных животных доступна только индивидуальная поездка. Это обеспечит комфорт и безопасность вашего питомца.'),
      actions: [
        TextButton(
          onPressed: () => _switchToIndividualTrip(),
          child: Text('Перейти к индивидуальной поездке'),
        ),
      ],
    ),
  );
}
```

#### 5.1.3 Интерфейс выбора животных
**UX Flow:**
1. Экран "Животные" с четырьмя карточками размеров (XS/S/M/L)
2. Для каждого размера:
   - Иконка животного
   - Примеры животных
   - Способ транспортировки
   - Стоимость
3. При выборе размера L: уведомление о переходе на индивидуальную поездку
4. Поле "Описание животного" (необязательное): порода, особенности

---

## 6. ИНТЕГРАЦИЯ С VKONTAKTE

### 6.1 Система верификации через VK

#### 6.1.1 Процесс верификации
**Шаги верификации:**
1. Пользователь нажимает "Подтвердить через VK" в профиле
2. OAuth авторизация через VK SDK
3. Получение основной информации профиля:
   - ID пользователя VK
   - Имя и фамилия
   - Фото профиля
   - Статус верификации профиля
4. Сохранение VK ID в профиле пользователя
5. Активация скидки 300₽ на все поездки

#### 6.1.2 Система скидок
**Логика применения скидки:**
- **Размер скидки**: 300₽ фиксированно
- **Применение**: Автоматически ко всем заказам верифицированных пользователей
- **Отображение**: В корзине отдельной строкой "Скидка VK: -300₽"
- **Ограничения**: Одна скидка на заказ (не суммируется)

**Техническая реализация:**
```dart
class VKService {
  static const String clientId = 'VK_APP_ID';
  static const String redirectUri = 'https://timetotravel.app/vk-callback';
  
  Future<VKAuthResult> authenticateUser() async {
    // OAuth flow
  }
  
  Future<VKUserInfo> getUserInfo(String accessToken) async {
    // API call to VK
  }
}

class User {
  // ...другие поля...
  final String? vkId;
  final bool isVKVerified;
  final String? vkName;
  final String? vkPhotoUrl;
  
  bool get hasVKDiscount => isVKVerified;
  double get vkDiscountAmount => hasVKDiscount ? 30.0 : 0.0;
}
```

### 6.2 Интерфейс верификации
**UX Flow:**
1. В профиле пользователя карточка "Верификация VK"
2. Если не верифицирован: кнопка "Подтвердить через VK" + описание скидки
3. Если верифицирован: галочка + информация профиля VK + "Скидка 30₽ активна"
4. Процесс верификации: WebView с VK OAuth → возврат в приложение → обновление профиля

---

## 7. ИНТЕГРАЦИЯ С TELEGRAM

### 7.1 Система уведомлений диспетчеру

#### 7.1.1 Типы уведомлений
**Новый заказ:**
```
🚗 НОВЫЙ ЗАКАЗ #12345

👤 Клиент: Иван Петров (+7 900 123-45-67)
📅 Дата: 15 декабря 2024, 14:00
🛣 Маршрут: Донецк → Ростов-на-Дону
   └ Отправление: Донецк (Центральный автовокзал)
   └ Прибытие: Ростов-на-Дону (Главный автовокзал)

👥 Тип: Групповая поездка (2 пассажира)
💰 Стоимость: 2,340₽

🧳 Багаж:
   └ Размер M: 1 шт. (+100₽)
   └ Размер S: 2 шт. (бесплатно)

🐕 Животные:
   └ Средняя собака (размер M): +400₽

💳 Итого к оплате: 2,840₽
✅ Статус: Ожидает подтверждения

[Подтвердить] [Отклонить] [Перенести]
```

**Отмена заказа:**
```
❌ ОТМЕНА ЗАКАЗА #12345

👤 Клиент: Иван Петров
📅 Отменена поездка: 15 декабря 2024, 14:00
🛣 Маршрут: Донецк → Ростов-на-Дону
💰 Возврат: 2,840₽

⏰ Время до поездки: 18 часов
📋 Причина: Изменились планы
```

#### 7.1.2 Техническая реализация
**Telegram Bot API Integration:**
```dart
class TelegramService {
  static const String botToken = 'BOT_TOKEN';
  static const String dispatcherChatId = 'DISPATCHER_CHAT_ID';
  
  Future<void> sendOrderNotification(Order order) async {
    final message = _formatOrderMessage(order);
    await _sendMessage(dispatcherChatId, message);
  }
  
  String _formatOrderMessage(Order order) {
    return '''
🚗 НОВЫЙ ЗАКАЗ #${order.id}

👤 Клиент: ${order.customerName} (${order.phoneNumber})
📅 Дата: ${order.dateTime.format()}
🛣 Маршрут: ${order.route.from} → ${order.route.to}

${_formatOrderDetails(order)}

💳 Итого к оплате: ${order.totalAmount}₽
✅ Статус: ${order.status}
    ''';
  }
}
```

---

## 8. СИСТЕМА PUSH-УВЕДОМЛЕНИЙ

### 8.1 Типы уведомлений пользователям

#### 8.1.1 Уведомления-напоминания
**За 24 часа до поездки:**
```
⏰ Напоминание о поездке

Завтра в 14:00 ваша поездка Донецк → Ростов-на-Дону
Заказ #12345

📍 Место отправления: Центральный автовокзал
⏰ Время: 15 декабря, 14:00

Рекомендуем подготовить:
• Документы для пересечения границы
• Документы на животных (если есть)
• Быть на месте за 15 минут до отправления
```

**За 1 час до поездки:**
```
🚗 Скоро отправление!

Через час ваша поездка Донецк → Ростов-на-Дону
Заказ #12345

📍 Место: Центральный автовокзал
⏰ Время: 15 декабря, 14:00
🚗 Водитель уже в пути к месту посадки

📱 Контакт водителя: +7 900 555-44-33
```

#### 8.1.2 Уведомления о статусе заказа
**Подтверждение заказа:**
```
✅ Заказ подтвержден!

Ваш заказ #12345 подтвержден диспетчером
Поездка: Донецк → Ростов-на-Дону
Дата: 15 декабря 2024, 14:00

Детали заказа доступны в приложении
```

**Отклонение заказа:**
```
❌ Заказ отклонен

К сожалению, ваш заказ #12345 отклонен
Причина: Нет свободных мест на выбранную дату

💰 Средства возвращены на ваш счет
🔄 Попробуйте выбрать другую дату
```

#### 8.1.3 Техническая реализация
```dart
class NotificationService {
  static final FirebaseMessaging _fcm = FirebaseMessaging.instance;
  
  // Планирование напоминания за 24 часа
  Future<void> schedule24HourReminder(Order order) async {
    final scheduledTime = order.departureTime.subtract(Duration(hours: 24));
    await _scheduleNotification(
      scheduledTime: scheduledTime,
      title: '⏰ Напоминание о поездке',
      body: _format24HourReminderBody(order),
    );
  }
  
  // Планирование напоминания за 1 час
  Future<void> schedule1HourReminder(Order order) async {
    final scheduledTime = order.departureTime.subtract(Duration(hours: 1));
    await _scheduleNotification(
      scheduledTime: scheduledTime,
      title: '🚗 Скоро отправление!',
      body: _format1HourReminderBody(order),
    );
  }
}
```

---

## 9. АДМИНИСТРАТИВНАЯ ПАНЕЛЬ ДИСПЕТЧЕРА

### 9.1 Управление контентом

#### 9.1.1 Редактирование описаний поездок
**Функциональность:**
- Редактирование описаний для популярных маршрутов
- Добавление специальных предложений и акций
- Обновление расписания и стоимости
- Управление доступностью маршрутов

**Интерфейс диспетчера:**
```dart
class AdminTripEditScreen extends StatefulWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text('Редактирование маршрута')),
      body: Form(
        child: Column(
          children: [
            TextFormField(
              decoration: InputDecoration(labelText: 'Описание маршрута'),
              maxLines: 5,
              initialValue: trip.description,
            ),
            TextFormField(
              decoration: InputDecoration(labelText: 'Базовая стоимость (₽)'),
              keyboardType: TextInputType.number,
              initialValue: trip.basePrice.toString(),
            ),
            SwitchListTile(
              title: Text('Маршрут активен'),
              value: trip.isActive,
              onChanged: (value) => setState(() => trip.isActive = value),
            ),
          ],
        ),
      ),
    );
  }
}
```

### 9.2 Управление заказами

#### 9.2.1 Интерфейс управления заказами
**Функции диспетчера:**
- Просмотр всех заказов (новые, подтвержденные, выполненные)
- Подтверждение/отклонение заказов
- Назначение водителей
- Группировка пассажиров для групповых поездок
- Отправка уведомлений клиентам

**Экран заказов:**
```dart
class DispatcherOrdersScreen extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text('Управление заказами'),
        actions: [
          IconButton(
            icon: Icon(Icons.filter_list),
            onPressed: () => _showFilterDialog(),
          ),
        ],
      ),
      body: StreamBuilder<List<Order>>(
        stream: OrderService.getOrdersStream(),
        builder: (context, snapshot) {
          if (!snapshot.hasData) return CircularProgressIndicator();
          
          return ListView.builder(
            itemCount: snapshot.data!.length,
            itemBuilder: (context, index) {
              final order = snapshot.data![index];
              return OrderCard(
                order: order,
                onConfirm: () => _confirmOrder(order),
                onReject: () => _rejectOrder(order),
                onEdit: () => _editOrder(order),
              );
            },
          );
        },
      ),
    );
  }
}
```

---

## 10. РАСШИРЕННЫЙ ПРОФИЛЬ ПОЛЬЗОВАТЕЛЯ

### 10.1 Дополнительные поля профиля

#### 10.1.1 Личная информация
**Обязательные поля:**
- **Фамилия**: Для документов при пересечении границы
- **Имя**: Полное имя пользователя
- **Отчество**: При наличии
- **Дата рождения**: Для возрастных ограничений и скидок

**Необязательные поля:**
- **Пол**: Мужской/Женский/Не указан
- **Серия и номер паспорта**: Для быстрого оформления при пересечении границы
- **Контактное лицо**: Имя и телефон для экстренных случаев

#### 10.1.2 Верификация и бонусы
**VK Верификация:**
- Статус верификации
- Имя из VK профиля
- Фото профиля VK
- Дата верификации
- Активная скидка 300₽

**История поездок:**
- Количество поездок
- Статус клиента (новый, постоянный, VIP)
- Накопленные бонусы
- История отзывов

#### 10.1.3 Интерфейс профиля
```dart
class ExpandedProfileScreen extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: CustomScrollView(
        slivers: [
          SliverAppBar(
            expandedHeight: 200,
            flexibleSpace: FlexibleSpaceBar(
              background: UserAvatarSection(),
            ),
          ),
          SliverList(
            delegate: SliverChildListDelegate([
              PersonalInfoSection(),
              VKVerificationSection(),
              TravelHistorySection(),
              ContactInfoSection(),
              EmergencyContactSection(),
              DocumentsSection(),
              SettingsSection(),
            ]),
          ),
        ],
      ),
    );
  }
}
```

---

## 11. КАЛЬКУЛЯТОР СВОБОДНЫХ МАРШРУТОВ

### 11.1 Интеграция с Yandex Maps

#### 11.1.1 Расчет расстояния и стоимости
**Функциональность:**
- Автокомплит адресов через Yandex Geocoding API
- Расчет оптимального маршрута через Yandex Directions API
- Динамическое ценообразование на основе расстояния
- Учет загруженности дорог и пробок

**Формула ценообразования:**
```
Стоимость = Базовая_ставка + (Расстояние_км × Коэффициент_за_км) + Городские_доплаты
```

Где:
- **Базовая ставка**: 500₽ (стартовая цена)
- **Коэффициент за км**: 15₽/км
- **Городские доплаты**: +200₽ при поездке в крупные города

#### 11.1.2 Техническая реализация
```dart
class YandexMapsService {
  static const String apiKey = 'YANDEX_MAPS_API_KEY';
  
  Future<RouteCalculationResult> calculateRoute({
    required String fromAddress,
    required String toAddress,
  }) async {
    // 1. Geocoding - получаем координаты
    final fromCoords = await _geocodeAddress(fromAddress);
    final toCoords = await _geocodeAddress(toAddress);
    
    // 2. Directions - рассчитываем маршрут
    final route = await _calculateDirections(fromCoords, toCoords);
    
    // 3. Ценообразование
    final price = _calculatePrice(route.distanceKm);
    
    return RouteCalculationResult(
      distance: route.distanceKm,
      duration: route.durationMinutes,
      price: price,
      waypoints: route.waypoints,
    );
  }
  
  double _calculatePrice(double distanceKm) {
    const basePrice = 500.0;
    const pricePerKm = 15.0;
    return basePrice + (distanceKm * pricePerKm);
  }
}
```

### 11.2 Интерфейс калькулятора
**UX Flow:**
1. Пользователь выбирает "Свободный маршрут"
2. Два поля ввода с автокомплитом:
   - "Откуда" (текущее местоположение по умолчанию)
   - "Куда"
3. При вводе показываются подсказки адресов
4. После выбора адресов автоматический расчет:
   - Расстояние в км
   - Время в пути
   - Стоимость поездки
5. Кнопка "Забронировать" → переход к выбору типа поездки

---

## 12. СТАТУСЫ И ЖИЗНЕННЫЙ ЦИКЛ ЗАКАЗОВ

### 12.1 Состояния заказа

#### 12.1.1 Основные статусы
**CREATED** (Создан)
- Заказ создан пользователем
- Ожидает оплаты (если настроена предоплата)
- Доступен для редактирования

**PENDING** (Ожидает подтверждения)
- Заказ оплачен и отправлен диспетчеру
- Диспетчер получил уведомление в Telegram
- Пользователь видит "Ожидает подтверждения"

**CONFIRMED** (Подтвержден)
- Диспетчер подтвердил заказ
- Назначен водитель и автомобиль
- Пользователь получает push-уведомление

**IN_PROGRESS** (В пути)
- Поездка началась
- Активно отслеживание местоположения
- Доступна связь с водителем

**COMPLETED** (Завершен)
- Поездка успешно завершена
- Доступна оценка и отзыв
- Заказ переходит в историю

**CANCELLED** (Отменен)
- Отменен пользователем или диспетчером
- Возврат средств (если применимо)
- Указание причины отмены

#### 12.1.2 Переходы между статусами
```dart
enum OrderStatus {
  created,
  pending,
  confirmed,
  inProgress,
  completed,
  cancelled,
}

class OrderStateMachine {
  static bool canTransition(OrderStatus from, OrderStatus to) {
    switch (from) {
      case OrderStatus.created:
        return [OrderStatus.pending, OrderStatus.cancelled].contains(to);
      case OrderStatus.pending:
        return [OrderStatus.confirmed, OrderStatus.cancelled].contains(to);
      case OrderStatus.confirmed:
        return [OrderStatus.inProgress, OrderStatus.cancelled].contains(to);
      case OrderStatus.inProgress:
        return [OrderStatus.completed, OrderStatus.cancelled].contains(to);
      case OrderStatus.completed:
      case OrderStatus.cancelled:
        return false; // Финальные состояния
    }
  }
}
```

### 12.2 Уведомления по статусам
**При каждом изменении статуса:**
- Push-уведомление пользователю
- Уведомление в Telegram диспетчеру 
- Обновление в реальном времени в приложении


---

## 13. СИСТЕМА ОПЛАТЫ И ЦЕНООБРАЗОВАНИЯ

### 13.1 Структура ценообразования

#### 13.1.1 Базовая стоимость
**Популярные маршруты:**
- **Донецк ↔ Ростов-на-Дону**: 2,000₽ за посадку
- **Промежуточные остановки**: 2,000₽ за посадку
- **Групповая поездка**: 2,000₽ за посадку
- **Индивидуальная поездка**: 8 000 руб. - днем. 10 000 руб.- ночные после 22.00

#### 13.1.2 Дополнительные услуги
**Багаж:**
- Размер S - Рюкзак: бесплатно
- Размер M - Спортивная сумка: +100₽
- Размер L - чемодан: +200₽
- CUSTOM: `(объем_в_литрах) × 5₽`

**Животные:**
- XS (до 3 кг) - той: +500₽
- S (до 8 кг) - карликовые: +500₽
- M (до 25 кг) - стандарт: +2000₽ + 8000₽ принудительная индивидуальная поездка 
- L (свыше 25 кг) - большие : +2000₽ + 8000₽ принудительная индивидуальная поездка

**Скидки:**
- VK верификация: -300₽
- Постоянный клиент (10+ поездок): -5%


#### 13.1.3 Расчет итоговой стоимости
```dart
class PriceCalculator {
  static double calculateTotalPrice({
    required Route route,
    required TripType tripType,
    required List<BaggageItem> baggage,
    required List<PetInfo> pets,
    required bool hasVKDiscount,
    required CustomerTier customerTier,
  }) {
    double basePrice = route.basePrice;
    
    // Тип поездки
    if (tripType == TripType.individual) {
      basePrice *= 1.5; // +50%
    }
    
    // Багаж
    double baggagePrice = baggage.fold(0.0, (sum, item) => sum + item.cost);
    
    // Животные
    double petPrice = pets.fold(0.0, (sum, pet) => sum + pet.cost);
    
    double totalPrice = basePrice + baggagePrice + petPrice;
    
    // Скидки
    if (hasVKDiscount) totalPrice -= 300.0;
    if (customerTier == CustomerTier.vip) totalPrice *= 0.95; // -5%
    
    return totalPrice;
  }
}
```

### 13.2 Интеграция платежных систем
**Планируемые способы оплаты:**
- **Наличные**: оплата водителю при посадке
- **SBP (Система быстрых платежей)**: QR-код оплата


---

## 14. МОНИТОРИНГ И АНАЛИТИКА

### 14.1 Сбор данных о поездках

#### 14.1.1 Метрики пользователей
**Основные показатели:**
- Количество успешных бронирований
- Средняя стоимость заказа
- Популярные маршруты
- Время отклика на подтверждение заказов
- Процент отмен заказов

**Техническая реализация:**
```dart
class AnalyticsService {
  static void trackBookingStarted({
    required String routeType,
    required String tripType,
  }) {
    FirebaseAnalytics.instance.logEvent(
      name: 'booking_started',
      parameters: {
        'route_type': routeType, // popular_route / free_route
        'trip_type': tripType,   // group / individual
        'timestamp': DateTime.now().millisecondsSinceEpoch,
      },
    );
  }
  
  static void trackBookingCompleted({
    required Order order,
  }) {
    FirebaseAnalytics.instance.logEvent(
      name: 'booking_completed',
      parameters: {
        'order_id': order.id,
        'total_price': order.totalAmount,
        'has_baggage': order.baggage.isNotEmpty,
        'has_pets': order.pets.isNotEmpty,
        'has_vk_discount': order.hasVKDiscount,
      },
    );
  }
}
```

### 14.2 Панель аналитики для диспетчера
**Основные отчеты:**
- Ежедневная статистика заказов
- Популярность маршрутов
- Выручка по периодам
- Эффективность водителей
- Отзывы и рейтинги

---

## 15. БЕЗОПАСНОСТЬ И ПРОИЗВОДИТЕЛЬНОСТЬ

### 15.1 Безопасность данных

#### 15.1.1 Защита персональных данных
**Меры безопасности:**
- Шифрование данных при передаче (HTTPS/TLS)
- Хеширование паролей (если используются)
- Ограничение доступа к Firebase через Security Rules
- Аудит доступа к данным

**Firebase Security Rules:**
```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Пользователи могут читать и изменять только свои данные
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Заказы доступны только создателю и диспетчерам
    match /orders/{orderId} {
      allow read, write: if request.auth != null && 
        (request.auth.uid == resource.data.userId || 
         request.auth.token.isDispatcher == true);
    }
  }
}
```

#### 15.1.2 Валидация данных
**Входящие данные:**
- Проверка номеров телефонов
- Санитизация текстовых полей
- Ограничение размеров файлов

### 15.2 Оптимизация производительности

#### 15.2.1 Кеширование и оффлайн-режим
**Стратегии кеширования:**
- Кеширование маршрутов и остановок
- Локальное хранение истории поездок
- Офлайн-режим для просмотра активных заказов

**Техническая реализация:**
```dart
class CacheManager {
  static final _cache = <String, dynamic>{};
  static const _cacheExpiry = Duration(hours: 1);
  
  static Future<T?> getCachedData<T>(String key) async {
    final cached = _cache[key];
    if (cached != null && 
        DateTime.now().difference(cached['timestamp']) < _cacheExpiry) {
      return cached['data'] as T;
    }
    return null;
  }
  
  static void setCachedData(String key, dynamic data) {
    _cache[key] = {
      'data': data,
      'timestamp': DateTime.now(),
    };
  }
}
```

#### 15.2.2 Оптимизация изображений и ресурсов
- Сжатие изображений логотипов
- Ленивая загрузка списков
- Использование векторных иконок
- Минимизация размера APK/IPA

---

## 16. ТЕСТИРОВАНИЕ И РАЗВЕРТЫВАНИЕ

### 16.1 Стратегия тестирования

#### 16.1.1 Виды тестирования
**Unit тесты:**
- Тестирование бизнес-логики (калькулятор цен, валидация данных)
- Тестирование моделей данных
- Тестирование сервисов

**Integration тесты:**
- Тестирование интеграции с Firebase
- Тестирование API calls (VK, Telegram, Yandex)
- Тестирование push-уведомлений

**UI тесты:**
- Тестирование основных пользовательских сценариев
- Тестирование responsive дизайна
- Тестирование доступности

#### 16.1.2 Автоматизация тестирования
```dart
// Пример unit теста
void main() {
  group('PriceCalculator', () {
    test('should calculate base price correctly', () {
      final route = Route(basePrice: 1500);
      final result = PriceCalculator.calculateTotalPrice(
        route: route,
        tripType: TripType.group,
        baggage: [],
        pets: [],
        hasVKDiscount: false,
        customerTier: CustomerTier.regular,
      );
      
      expect(result, equals(1500.0));
    });
    
    test('should apply VK discount', () {
      final route = Route(basePrice: 1500);
      final result = PriceCalculator.calculateTotalPrice(
        route: route,
        tripType: TripType.group,
        baggage: [],
        pets: [],
        hasVKDiscount: true,
        customerTier: CustomerTier.regular,
      );
      
      expect(result, equals(1470.0)); // 1500 - 30
    });
  });
}
```

### 16.2 Развертывание

#### 16.2.1 Среды развертывания
**Development (разработка):**
- Firebase проект для разработки
- Тестовые данные
- Debug-режим приложения

**Staging (тестирование):**
- Копия production окружения
- Тестирование перед релизом
- UAT (User Acceptance Testing)

**Production (продакшн):**
- Реальная Firebase среда
- Мониторинг производительности
- Автоматические бэкапы

#### 16.2.2 CI/CD Pipeline
**Автоматизация развертывания:**
- GitHub Actions для автоматической сборки
- Автоматическое тестирование при commit
- Автоматическая публикация в App Store / Google Play

```yaml
# .github/workflows/build_and_deploy.yml
name: Build and Deploy
on:
  push:
    branches: [main]
    
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: subosito/flutter-action@v2
      - run: flutter test
      
  build:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: subosito/flutter-action@v2
      - run: flutter build apk --release
      - run: flutter build ios --release
```



## 18. ЗАКЛЮЧЕНИЕ

### 18.1 Ключевые преимущества решения
1. **Полная автоматизация**: От бронирования до уведомлений
2. **Гибкость маршрутов**: Популярные + свободные маршруты
3. **Детальный учет**: Багаж, животные, индивидуальные потребности
4. **Современный UX**: iOS-стиль, интуитивный интерфейс
5. **Интеграции**: VK, Telegram, Yandex Maps
6. **Масштабируемость**: Готовность к росту количества пользователей

### 18.2 Критерии успеха
**Технические метрики:**
- Время загрузки экранов < 2 сек
- Доступность сервиса > 99.5%
- Время отклика API < 500ms

**Бизнес-метрики:**
- Конверсия в заказ > 15%
- Повторные заказы > 30%
- Средняя оценка в App Store/Google Play > 4.5

### 18.3 Риски и митигация
**Технические риски:**
- Сбои Firebase → Backup-стратегии
- Проблемы с внешними API → Fallback-решения
- Нагрузка на сервера → Масштабирование

**Бизнес-риски:**
- Низкая adoption → Маркетинговая поддержка
- Конкуренция → Уникальные функции
- Изменения законодательства → Гибкая архитектура

---

**КОНЕЦ ТЕХНИЧЕСКОГО ЗАДАНИЯ v2.0**
  final BaggageSize size;
  final int quantity;
  final String? customDimensions;
  final String? description;
}

enum BaggageSize { small, medium, large, custom }
```

### 1.6.2 Функция "Животные"
**Категории животных:**

1. **Маленькие породы (Размер XS)**
   - Типы: Той-терьер, Йоркширский терьер, Чихуахуа
   - Размещение: На коленях, в сумке-переноске
   - Доплата: +500 руб.
   - Особенности: Не занимает отдельное место

2. **Карликовые породы (Размер S)**
   - Типы: Мопс, Французский бульдог, Корги
   - Размещение: На коленях, в переноске
   - Доплата: +500 руб.
   - Особенности: Может потребовать место рядом

3. **Стандартные породы (Размер M)**
   - Типы: Спаниель, Бигль, Шелти
   - Размещение: Отдельное место в салоне
   - **Требование: Индивидуальный трансфер**
   - Цена: 10,000 руб. (вместо 8,000 руб.)

4. **Большие породы (Размер L)**
   - Типы: Овчарка, Лабрадор, Ротвейлер, и другие крупные
   - Размещение: **Только индивидуальный трансфер**
   - Цена: 10,000 руб. + обязательная химчистка
   - Обоснование: Предотвращение дискомфорта других пассажиров

**Дополнительные услуги:**
- Обязательная химчистка после больших собак
- Предложение индивидуального трансфера для комфорта
- Информирование о правилах перевозки животных

```dart
class PetInfo {
  final PetSize size;
  final String breed;
  final bool needsSeparateTransfer;
  final int additionalCost;
}

enum PetSize { extraSmall, small, medium, large }
```

---

## 1.7 ОБНОВЛЕННАЯ СИСТЕМА БРОНИРОВАНИЯ

### 1.7.1 Двухуровневая навигация бронирования

**Уровень 1: Выбор типа маршрута**
1. **Популярные рейсы**
   - Донецк ↔ Ростов-на-Дону
   - Фиксированные маршруты с остановками
   - Переход на Уровень 2

2. **Свободный маршрут**
   - Произвольные точки отправления/назначения
   - Интеграция с Yandex Maps API для расчета стоимости
   - Формула расчета как у Яндекс.Такси

**Уровень 2: Выбор типа поездки (только для популярных рейсов)**
1. **Групповая поездка**
   - Фиксированная стоимость: 2,000₽
   - Любая точка маршрута за ту же цену
   - Расписание отправления

2. **Индивидуальная поездка**
   - Базовая стоимость: 8,000₽ (днем)
   - Ночная надбавка: +2,000₽ (итого 10,000₽)
   - Гибкое время отправления

### 1.7.2 Управляемые через CMS описания
**Требования:**
- Блок с описанием под выбором типа поездки
- Контент управляется через кабинет диспетчера
- API для обновления описаний в реальном времени
- Возможность форматирования текста

```dart
// Загрузка динамического контента
Future<String> loadTripDescription(TripType type) async {
  final doc = await FirebaseFirestore.instance
    .collection('content')
    .doc('trip_descriptions')
    .get();
  return doc.data()?[type.toString()] ?? 'Описание недоступно';
}
```

---

## 1.8 СИСТЕМА УВЕДОМЛЕНИЙ И ИНТЕГРАЦИЙ

### 1.8.1 Уведомления клиентам
**После создания заказа:**
```
Спасибо за заказ! За день до поездки водитель свяжется с вами 
или наберет диспетчер для уточнения деталей поездки.
```

**Push-уведомления через Firebase:**
1. **За 24 часа до поездки**
   - Напоминание о предстоящей поездке
   - Контакты диспетчера
   - Возможность изменения/отмены

2. **За 1 час до поездки**
   - Финальное напоминание
   - Контакты водителя
   - Точка встречи

### 1.8.2 Telegram интеграция для диспетчеров
**Формат уведомления о новом заказе:**
```
29.09 1 чел 6:00
Ростов - Макеевка 
+79490490677 Георгий
Без багажа 
2000₽
```

**Дополнительная информация:**
- Информация о багаже (если есть)
- Информация о животных (если есть)
- Особые пометки и комментарии
- Кнопки быстрых действий (Принять/Отклонить)

```dart
class TelegramNotification {
  static String formatBooking(Booking booking) {
    return '''
${booking.date} ${booking.passengerCount} чел ${booking.time}
${booking.route}
${booking.phone} ${booking.clientName}
${booking.baggageInfo}
${booking.totalPrice}₽
''';
  }
}
```

---

## 1.9 ПРОФИЛЬ ПОЛЬЗОВАТЕЛЯ И ВЕРИФИКАЦИЯ

### 1.9.1 Расширенный профиль
**Обязательные поля:**
- Номер телефона (заполняется при регистрации)
- ФИО (Фамилия, Имя, Отчество)
- Дата рождения

**Дополнительные поля:**
- Фото профиля
- Предпочтения поездок
- История заказов

### 1.9.2 VK верификация
**Процесс верификации:**
1. Кнопка "Подключить VKontakte" в профиле
2. OAuth авторизация через VK API
3. Получение основной информации профиля
4. Сохранение статуса верификации

**Преимущества:**
- **Скидка 300₽** на каждый заказ
- Доверие со стороны диспетчеров и водителей
- Возможность просмотра профиля для безопасности

**Управление скидкой:**
- Размер скидки настраивается через кабинет диспетчера
- Возможность временного отключения акции
- Статистика по верифицированным пользователям

```dart
class VKVerification {
  final bool isVerified;
  final String? vkId;
  final String? profileUrl;
  final DateTime? verificationDate;
  final double discountAmount; // Управляется через админ-панель
}
```

---

## 1.10 СВОБОДНЫЕ МАРШРУТЫ И ИНТЕГРАЦИИ

### 1.10.1 Система произвольных маршрутов
**Функциональность:**
- Выбор произвольных точек "Откуда" и "Куда"
- Интеграция с картами для построения маршрута
- Автоматический расчет стоимости по формуле

**Расчет стоимости:**
- Базовая формула: расстояние × тариф за км
- Надбавки за сложность маршрута
- Минимальная стоимость поездки
- Интеграция с Yandex API для точного расчета

```dart
class FreRouteCalculator {
  static Future<double> calculatePrice({
    required LatLng from,
    required LatLng to,
    required DateTime dateTime,
  }) async {
    // Интеграция с Yandex API
    final route = await YandexMapsAPI.buildRoute(from, to);
    final distance = route.distance;
    final basePrice = distance * pricePerKm;
    final timeMultiplier = _getTimeMultiplier(dateTime);
    return basePrice * timeMultiplier;
  }
}
```

### 1.10.2 Код из существующего такси-приложения
**Требуется перенос:**
- Экран выбора точек на карте
- Логика геокодирования адресов
- UI компоненты для работы с картами
- Валидация введенных адресов

---

## 2. АРХИТЕКТУРА ПРИЛОЖЕНИЯ

### 2.1 Структура проекта
```
lib/
├── main.dart                    # Точка входа приложения
├── models/                      # Модели данных
│   ├── user.dart               # Модель пользователя
│   ├── booking.dart            # Модель бронирования
│   └── trip_type.dart          # Типы поездок и направления
├── services/                    # Сервисы бизнес-логики
│   ├── auth_service.dart       # Аутентификация
│   ├── user_service.dart       # Управление пользователями
│   └── booking_service.dart    # Управление бронированиями
├── features/                    # Функциональные модули
│   ├── auth/                   # Авторизация
│   ├── home/                   # Главный экран
│   ├── booking/                # Бронирование
│   ├── orders/                 # Заказы
│   ├── tracking/               # Отслеживание
│   └── profile/                # Профиль


### 2.2 Система управления состоянием
- **Provider**: Для глобального состояния (темы, аутентификация)
- **StatefulWidget**: Для локального состояния экранов
- **SharedPreferences**: Для локального хранения данных

---

## 3. ТИПЫ ПОЛЬЗОВАТЕЛЕЙ И ИХ РАЗЛИЧИЯ

### 3.1 Клиент (UserType.client)

#### Права доступа:
- Создание бронирований (групповые и индивидуальные поездки)
- Просмотр своих заказов
- Отслеживание активных поездок
- Управление профилем

#### Интерфейс:
- **Главная**: Дашборд с кнопками быстрого доступа
- **Бронирование**: Выбор типа поездки (групповая/индивидуальная)
- **Мои заказы**: Список собственных бронирований
- **Отслеживание**: Карта с активными поездками
- **Профиль**: Настройки аккаунта

#### Функциональные возможности:
```dart
// Создание группового бронирования
final booking = Booking(
  clientId: currentUser.id,
  tripType: TripType.group,
  direction: Direction.donetskToRostov,
  pickupPoint: selectedPickupPoint,
  // ... другие параметры
);
```

### 3.2 Диспетчер (UserType.dispatcher)

#### Права доступа:
- Просмотр всех активных заказов
- Управление статусами бронирований
- Назначение транспорта
- Отслеживание всех поездок
- Доступ к статистике

#### Интерфейс:
- **Главная**: Статистика и быстрые действия
- **Все заказы**: Полный список заказов с фильтрами
- **Отслеживание**: Карта всех активных поездок
- **Профиль**: Настройки диспетчера

#### Функциональные возможности:
```dart
// Обновление статуса заказа
await BookingService().updateBookingStatus(
  bookingId, 
  BookingStatus.confirmed
);

// Назначение транспорта
await BookingService().assignVehicle(bookingId, vehicleId);
```

---

## 4. ЛОГИКА РАБОТЫ ПРИЛОЖЕНИЯ

### 4.1 Процесс аутентификации

#### Алгоритм входа:
1. Пользователь вводит номер телефона
2. Выбирает тип аккаунта (Клиент/Диспетчер)
3. Система отправляет SMS-код
4. Верификация кода через Firebase Auth
5. Создание/обновление профиля в Firestore
6. Сохранение сессии локально

```dart
// Процесс верификации
Future<bool> verifyCode({
  required String verificationId,
  required String smsCode,
  required String name,
  required UserType userType,
}) async {
  final credential = PhoneAuthProvider.credential(
    verificationId: verificationId,
    smsCode: smsCode,
  );
  
  final authResult = await _firebaseAuth.signInWithCredential(credential);
  // Создание пользователя в Firestore...
}
```

### 4.2 Система бронирования

#### Групповые поездки:
- **Направления**: Донецк ↔ Ростов-на-Дону
- **Расписание**: Фиксированные времена отправления
- **Места посадки**: Предустановленные точки
- **Ценообразование**: Фиксированные тарифы

#### Индивидуальные поездки:
- **Гибкое время**: Выбор любого времени
- **Адреса**: Произвольные точки посадки/высадки
- **Ценообразование**: Динамические тарифы

```dart
// Модель бронирования
class Booking {
  final String id;
  final String clientId;
  final TripType tripType;          // group | individual
  final Direction direction;        // donetskToRostov | rostovToDonetsk
  final DateTime departureDate;
  final String departureTime;
  final int passengerCount;
  final BookingStatus status;       // pending | confirmed | inProgress | completed
  final List<TrackingPoint> trackingPoints;
}
```

### 4.3 Управление состояниями заказов

#### Жизненный цикл заказа:
1. **Pending** - Создан, ожидает подтверждения
2. **Confirmed** - Подтверждён диспетчером
3. **Assigned** - Назначен транспорт
4. **InProgress** - Поездка началась
5. **Completed** - Поездка завершена
6. **Cancelled** - Отменён

```dart
enum BookingStatus {
  pending,
  confirmed,
  assigned,
  inProgress,
  completed,
  cancelled,
}
```

---

## 5. ВЗАИМОДЕЙСТВИЕ С СЕРВЕРОМ

### 5.1 Firebase Authentication
- **Метод**: Phone Authentication
- **SMS-верификация**: Автоматическая через Firebase
- **Токены**: JWT для авторизации запросов

### 5.2 Firestore Database

#### Коллекции:
```
/users/{userId}
- id: string
- phone: string
- name: string
- userType: "UserType.client" | "UserType.dispatcher"
- createdAt: timestamp
- fcmToken: string?

/bookings/{bookingId}
- id: string
- clientId: string
- tripType: "TripType.group" | "TripType.individual"
- direction: Direction
- departureDate: timestamp
- status: BookingStatus
- trackingPoints: TrackingPoint[]
```

#### Индексы:
- `clientId` для быстрого поиска заказов клиента
- `status` для фильтрации активных заказов
- `departureDate` для сортировки по дате

### 5.3 API сервисов

#### AuthService методы:
```dart
Future<bool> isLoggedIn()
Future<User?> getCurrentUser()
Future<UserType?> getUserType()
Future<bool> verifyCode({...})
Future<void> logout()
```

#### BookingService методы:
```dart
Future<String> createBooking(Booking booking)
Future<List<Booking>> getClientBookings(String clientId)
Future<List<Booking>> getActiveBookings()
Future<void> updateBookingStatus(String id, BookingStatus status)
Future<void> assignVehicle(String bookingId, String vehicleId)
```

---

## 6. ПОЛЬЗОВАТЕЛЬСКИЙ ИНТЕРФЕЙС

### 6.1 Навигационная система
- **Bottom Tab Bar**: 5 основных разделов
- **Адаптивная навигация**: Второй таб меняется в зависимости от типа пользователя
  - Клиент: "Бронирование"
  - Диспетчер: "Заказы"

```dart
// Динамическая навигация
Widget _buildSecondTab() {
  if (_userType == UserType.client) {
    return const BookingScreen();
  } else {
    return const OrdersScreen();
  }
}
```

### 6.2 Дизайн-система
- **Стиль**: iOS Cupertino Design
- **Цветовая схема**: Системные цвета iOS
- **Темы**: Светлая и тёмная (настраиваемые)
- **Компоненты**: Нативные iOS виджеты

### 6.3 Экраны приложения

#### Экран авторизации:
- Поле ввода телефона с маской
- Выбор типа пользователя (радио-кнопки)
- Кнопка "Войти" с индикатором загрузки

#### Главный экран:
**Для клиента:**
- Статистика поездок
- Быстрые действия (Забронировать поездку)
- Активные заказы

**Для диспетчера:**
- Общая статистика заказов
- Активные поездки
- Быстрые действия управления

#### Экран бронирования (только клиент):
- Выбор типа поездки
- Групповая: фиксированные параметры
- Индивидуальная: гибкие настройки

---

## 7. БИЗНЕС-ЛОГИКА

### 7.1 Ценообразование

#### Групповые поездки:
```dart
class TripPricing {
  static const Map<Direction, int> groupPrices = {
    Direction.donetskToRostov: 2000,
    Direction.rostovToDonetsk: 2000,
  };
}
```

#### Индивидуальные поездки:
- Базовая стоимость 8000 руб. 
- Надбавки за время суток + 2000 руб. итого 10 000 руб. 
- Скидки для постоянных клиентов

### 7.2 Валидация данных

#### Клиентские проверки:
```dart
bool _validateBooking() {
  if (_selectedDate.isBefore(DateTime.now())) {
    _showError('Дата не может быть в прошлом');
    return false;
  }
  
  if (_passengerCount < 1 || _passengerCount > 8) {
    _showError('Количество пассажиров: 1-8');
    return false;
  }
  
  return true;
}
```

#### Серверные проверки:
- Проверка доступности мест
- Валидация временных слотов
- Проверка прав доступа

### 7.3 Система уведомлений

#### Push-уведомления:
- Подтверждение бронирования
- Изменение статуса заказа
- Напоминания о поездке
- Уведомления для диспетчеров о новых заказах

```dart
// FCM токен для уведомлений
Future<void> updateFCMToken(String userId, String fcmToken) async {
  await _firestore.collection('users').doc(userId).update({
    'fcmToken': fcmToken,
  });
}
```

---

## 8. БЕЗОПАСНОСТЬ И ДАННЫЕ

### 8.1 Аутентификация
- **Firebase Auth**: Безопасная SMS-верификация
- **Токены**: Автоматическое обновление JWT
- **Сессии**: Сохранение состояния входа

### 8.2 Авторизация
- **Проверка ролей**: На уровне UI и API
- **Разделение данных**: Клиенты видят только свои заказы
- **Правила Firestore**: Серверная валидация доступа

### 8.3 Защита данных
- **Шифрование**: HTTPS для всех запросов
- **Локальное хранение**: SharedPreferences для несекретных данных
- **Персональные данные**: Минимальный набор (телефон, имя)

---

## 9. ПРОИЗВОДИТЕЛЬНОСТЬ И ОПТИМИЗАЦИЯ

### 9.1 Кэширование
- **Локальное хранение**: Последний экран, предпочтения пользователя
- **Firestore**: Офлайн-кэширование для критичных данных

### 9.2 Загрузка данных
- **Пагинация**: Для больших списков заказов
- **Ленивая загрузка**: Данные загружаются по требованию
- **Индикаторы**: CupertinoActivityIndicator для всех операций

### 9.3 Оптимизация UI
- **Обработка состояний**: Проверка `mounted` перед `setState`
- **Ресурсы**: Правильное освобождение контроллеров
- **Hot Reload**: Поддержка быстрой разработки

---

## 10. ТЕСТИРОВАНИЕ И КАЧЕСТВО

### 10.1 Обработка ошибок
```dart
try {
  final user = await AuthService.instance.getCurrentUser();
  if (mounted) {
    setState(() => _currentUser = user);
  }
} catch (e) {
  if (mounted) {
    _showError('Ошибка загрузки: $e');
  }
}
```

### 10.2 Валидация форм
- Проверка заполнения обязательных полей
- Валидация номеров телефонов
- Проверка дат и времени

### 10.3 Пользовательский опыт
- Информативные сообщения об ошибках
- Индикаторы загрузки
- Подтверждения важных действий

---

## 11. ПЛАНЫ РАЗВИТИЯ

### 11.1 Интеграция карт
- **Yandex Maps**: Отслеживание в реальном времени
- **Геолокация**: Определение местоположения пользователя
- **Маршруты**: Построение оптимальных путей

### 11.2 Дополнительные функции
- **Рейтинги**: Система оценок водителей
- **Чат**: Связь с диспетчером
- **Аналитика**: Детальная статистика для диспетчеров

### 11.3 Серверная часть
- **Faerbase





