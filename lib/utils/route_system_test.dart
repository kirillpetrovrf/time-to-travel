
import '../services/route_management_service.dart';
import '../services/price_calculator_service.dart';
import '../data/route_initializer.dart';

/// –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º—ã –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤
class RouteSystemTest {
  static final RouteManagementService _routeService = RouteManagementService.instance;
  static final PriceCalculatorService _priceService = PriceCalculatorService.instance;

  /// –ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã
  static Future<void> runFullTest() async {
    print('üß™ ========== –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –°–ò–°–¢–ï–ú–´ –ú–ê–†–®–†–£–¢–û–í ==========');
    
    try {
      // 1. –¢–µ—Å—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤
      await _testRouteInitialization();
      
      // 2. –¢–µ—Å—Ç –¥–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω–µ–≥–æ –ø–æ–∏—Å–∫–∞
      await _testBidirectionalSearch();
      
      // 3. –¢–µ—Å—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å —Ä–∞—Å—á–µ—Ç–æ–º —Å—Ç–æ–∏–º–æ—Å—Ç–∏
      await _testPriceCalculationIntegration();
      
      // 4. –¢–µ—Å—Ç –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è –¥–ª—è –∂–∏–≤—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤
      await _testLiveRouteRounding();
      
      // 5. –¢–µ—Å—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
      await _testRouteStatistics();
      
      print('‚úÖ ========== –í–°–ï –¢–ï–°–¢–´ –ü–†–û–ô–î–ï–ù–´ –£–°–ü–ï–®–ù–û! ==========');
      
    } catch (e, stackTrace) {
      print('‚ùå ========== –û–®–ò–ë–ö–ê –í –¢–ï–°–¢–ê–•: $e ==========');
      print('Stack trace: $stackTrace');
    }
  }

  /// –¢–µ—Å—Ç 1: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤
  static Future<void> _testRouteInitialization() async {
    print('\nüß™ –¢–ï–°–¢ 1: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤');
    
    // –û—á–∏—â–∞–µ–º –∫—ç—à –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞
    _routeService.clearCache();
    
    // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏–∑ —Å—Ç–∞—Ç–∏—á–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞
    final staticStats = RouteInitializer.routeStats;
    print('üìä –°—Ç–∞—Ç–∏—á–Ω—ã–π —Å–ø–∏—Å–æ–∫: ${staticStats['total_routes']} –º–∞—Ä—à—Ä—É—Ç–æ–≤');
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–∞—Ä—à—Ä—É—Ç—ã
    await RouteInitializer.initializeRoutes();
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≥—Ä—É–∑–∫—É –∏–∑ Firebase
    final routes = await _routeService.getAllRoutes();
    print('üìä –ó–∞–≥—Ä—É–∂–µ–Ω–æ –∏–∑ Firebase: ${routes.length} –º–∞—Ä—à—Ä—É—Ç–æ–≤');
    
    if (routes.isNotEmpty) {
      print('‚úÖ –¢–µ—Å—Ç 1 –ø—Ä–æ–π–¥–µ–Ω: –ú–∞—Ä—à—Ä—É—Ç—ã —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã');
    } else {
      throw Exception('–ú–∞—Ä—à—Ä—É—Ç—ã –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å –∏–∑ Firebase');
    }
  }

  /// –¢–µ—Å—Ç 2: –î–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω–∏–π –ø–æ–∏—Å–∫ –º–∞—Ä—à—Ä—É—Ç–æ–≤
  static Future<void> _testBidirectionalSearch() async {
    print('\nüß™ –¢–ï–°–¢ 2: –î–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω–∏–π –ø–æ–∏—Å–∫ –º–∞—Ä—à—Ä—É—Ç–æ–≤');
    
    // –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø—Ä—è–º–æ–π –º–∞—Ä—à—Ä—É—Ç
    final directRoute = await _routeService.findRoute('–î–æ–Ω–µ—Ü–∫', '–ë–µ–ª–≥–æ—Ä–æ–¥');
    print('üîç –ü—Ä—è–º–æ–π –ø–æ–∏—Å–∫ "–î–æ–Ω–µ—Ü–∫ ‚Üí –ë–µ–ª–≥–æ—Ä–æ–¥": ${directRoute?.price ?? '–Ω–µ –Ω–∞–π–¥–µ–Ω'}‚ÇΩ');
    
    // –¢–µ—Å—Ç–∏—Ä—É–µ–º –æ–±—Ä–∞—Ç–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç
    final reverseRoute = await _routeService.findRoute('–ë–µ–ª–≥–æ—Ä–æ–¥', '–î–æ–Ω–µ—Ü–∫');
    print('üîç –û–±—Ä–∞—Ç–Ω—ã–π –ø–æ–∏—Å–∫ "–ë–µ–ª–≥–æ—Ä–æ–¥ ‚Üí –î–æ–Ω–µ—Ü–∫": ${reverseRoute?.price ?? '–Ω–µ –Ω–∞–π–¥–µ–Ω'}‚ÇΩ');
    
    if (directRoute != null && reverseRoute != null && directRoute.price == reverseRoute.price) {
      print('‚úÖ –¢–µ—Å—Ç 2 –ø—Ä–æ–π–¥–µ–Ω: –î–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω–∏–π –ø–æ–∏—Å–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ');
    } else {
      throw Exception('–û—à–∏–±–∫–∞ –¥–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω–µ–≥–æ –ø–æ–∏—Å–∫–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤');
    }
  }

  /// –¢–µ—Å—Ç 3: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ä–∞—Å—á–µ—Ç–æ–º —Å—Ç–æ–∏–º–æ—Å—Ç–∏
  static Future<void> _testPriceCalculationIntegration() async {
    print('\nüß™ –¢–ï–°–¢ 3: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ä–∞—Å—á–µ—Ç–æ–º —Å—Ç–æ–∏–º–æ—Å—Ç–∏');
    
    // –¢–µ—Å—Ç –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞
    final predefinedCalc = await _priceService.calculatePrice(
      200, // —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –Ω–µ –≤–∞–∂–Ω–æ –¥–ª—è –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞
      fromCity: '–î–æ–Ω–µ—Ü–∫',
      toCity: '–ï–π—Å–∫',
    );
    print('üí∞ –ü—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π "–î–æ–Ω–µ—Ü–∫ ‚Üí –ï–π—Å–∫": ${predefinedCalc.finalPrice}‚ÇΩ');
    
    // –¢–µ—Å—Ç –∂–∏–≤–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ (–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç)
    final liveCalc = await _priceService.calculatePrice(
      150,
      fromCity: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ì–æ—Ä–æ–¥ –ê',
      toCity: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ì–æ—Ä–æ–¥ –ë',
    );
    print('üí∞ –ñ–∏–≤–æ–π —Ä–∞—Å—á–µ—Ç 150–∫–º: ${liveCalc.finalPrice}‚ÇΩ (–æ–∫—Ä—É–≥–ª–µ–Ω: ${liveCalc.roundedUp})');
    
    if (predefinedCalc.isSpecialRoute && predefinedCalc.finalPrice == 22000) {
      print('‚úÖ –¢–µ—Å—Ç 3 –ø—Ä–æ–π–¥–µ–Ω: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ');
    } else {
      throw Exception('–û—à–∏–±–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å —Ä–∞—Å—á–µ—Ç–æ–º —Å—Ç–æ–∏–º–æ—Å—Ç–∏');
    }
  }

  /// –¢–µ—Å—Ç 4: –û–∫—Ä—É–≥–ª–µ–Ω–∏–µ –¥–ª—è –∂–∏–≤—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤
  static Future<void> _testLiveRouteRounding() async {
    print('\nüß™ –¢–ï–°–¢ 4: –û–∫—Ä—É–≥–ª–µ–Ω–∏–µ –¥–ª—è –∂–∏–≤—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤');
    
    // –¢–µ—Å—Ç–∏—Ä—É–µ–º –º–∞—Ä—à—Ä—É—Ç, –∫–æ—Ç–æ—Ä—ã–π –¥–æ–ª–∂–µ–Ω –æ–∫—Ä—É–≥–ª–∏—Ç—å—Å—è
    final calc1 = await _priceService.calculatePrice(
      85, // 85 * 60 = 5100 ‚Üí –¥–æ–ª–∂–Ω–æ –æ–∫—Ä—É–≥–ª–∏—Ç—å—Å—è –¥–æ 6000
      fromCity: '–¢–µ—Å—Ç–æ–≤—ã–π –ê',
      toCity: '–¢–µ—Å—Ç–æ–≤—ã–π –ë',
    );
    
    print('üí∞ 85–∫–º: —Å—ã—Ä–∞—è —Ü–µ–Ω–∞ ‚âà ${calc1.rawPrice.toStringAsFixed(0)}‚ÇΩ, –∏—Ç–æ–≥–æ–≤–∞—è: ${calc1.finalPrice}‚ÇΩ');
    print('üîÑ –û–∫—Ä—É–≥–ª–µ–Ω–æ: ${calc1.roundedUp ? "–¥–∞" : "–Ω–µ—Ç"}');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã –ù–ï –æ–∫—Ä—É–≥–ª—è—é—Ç—Å—è
    final calc2 = await _priceService.calculatePrice(
      200,
      fromCity: '–î–æ–Ω–µ—Ü–∫',
      toCity: '–ë–µ–ª–≥–æ—Ä–æ–¥', // 5000‚ÇΩ - –Ω–µ –¥–æ–ª–∂–Ω–æ –æ–∫—Ä—É–≥–ª—è—Ç—å—Å—è
    );
    
    print('üí∞ –ü—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π: ${calc2.finalPrice}‚ÇΩ, –æ–∫—Ä—É–≥–ª–µ–Ω: ${calc2.roundedUp}');
    
    if (calc1.roundedUp && !calc2.roundedUp) {
      print('‚úÖ –¢–µ—Å—Ç 4 –ø—Ä–æ–π–¥–µ–Ω: –û–∫—Ä—É–≥–ª–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ');
    } else {
      print('‚ö†Ô∏è –¢–µ—Å—Ç 4: –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ–º');
    }
  }

  /// –¢–µ—Å—Ç 5: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤
  static Future<void> _testRouteStatistics() async {
    print('\nüß™ –¢–ï–°–¢ 5: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤');
    
    final stats = await _routeService.getRoutesStats();
    print('üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:');
    print('   ‚Ä¢ –í—Å–µ–≥–æ –º–∞—Ä—à—Ä—É—Ç–æ–≤: ${stats['total_routes']}');
    print('   ‚Ä¢ –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –≥–æ—Ä–æ–¥–æ–≤: ${stats['unique_cities']}');
    print('   ‚Ä¢ –°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞: ${stats['avg_price']}‚ÇΩ');
    
    if ((stats['total_routes'] ?? 0) > 0) {
      print('‚úÖ –¢–µ—Å—Ç 5 –ø—Ä–æ–π–¥–µ–Ω: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç');
    } else {
      throw Exception('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏');
    }
  }

  /// –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç –¥–ª—è –ø–æ–∫–∞–∑–∞ –≤—Å–µ—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π
  static Future<void> runDemo() async {
    print('üé¨ ========== –î–ï–ú–û–ù–°–¢–†–ê–¶–ò–Ø –í–û–ó–ú–û–ñ–ù–û–°–¢–ï–ô ==========');
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–∏–º–µ—Ä–æ–≤ —Ä–∞—Å—á–µ—Ç–∞
    final testCases = [
      {'from': '–î–æ–Ω–µ—Ü–∫', 'to': '–ï–π—Å–∫', 'km': 200, 'expected': '–ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ü–µ–Ω–∞ 22000‚ÇΩ'},
      {'from': '–ï–π—Å–∫', 'to': '–î–æ–Ω–µ—Ü–∫', 'km': 200, 'expected': '–æ–±—Ä–∞—Ç–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç 22000‚ÇΩ'},
      {'from': '–ú–∞–∫–µ–µ–≤–∫–∞', 'to': '–ú–æ—Å–∫–≤–∞', 'km': 800, 'expected': '–ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ü–µ–Ω–∞ 12100‚ÇΩ'},
      {'from': '–°–ª—É—á–∞–π–Ω—ã–π –ì–æ—Ä–æ–¥', 'to': '–î—Ä—É–≥–æ–π –ì–æ—Ä–æ–¥', 'km': 100, 'expected': '–∂–∏–≤–æ–π —Ä–∞—Å—á–µ—Ç —Å –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ–º'},
      {'from': '–î–æ–Ω–µ—Ü–∫', 'to': '–î–∞–ª—å–Ω–∏–π –ì–æ—Ä–æ–¥', 'km': 500, 'expected': '—Å–∏—Å—Ç–µ–º–∞ –î–æ–Ω–µ—Ü–∫ + –¥–æ–ø–ª–∞—Ç–∞ –∑–∞ –∫–º'},
    ];

    for (final testCase in testCases) {
      print('\nüìç ${testCase['from']} ‚Üí ${testCase['to']} (${testCase['km']}–∫–º)');
      print('   –û–∂–∏–¥–∞–µ—Ç—Å—è: ${testCase['expected']}');
      
      final calc = await _priceService.calculatePrice(
        (testCase['km'] as int).toDouble(),
        fromCity: testCase['from'] as String,
        toCity: testCase['to'] as String,
      );
      
      print('   –†–µ–∑—É–ª—å—Ç–∞—Ç: ${calc.finalPrice}‚ÇΩ (—Å–ø–µ—Ü. –º–∞—Ä—à—Ä—É—Ç: ${calc.isSpecialRoute})');
    }
    
    print('\nüéâ ========== –î–ï–ú–û–ù–°–¢–†–ê–¶–ò–Ø –ó–ê–í–ï–†–®–ï–ù–ê ==========');
  }
}