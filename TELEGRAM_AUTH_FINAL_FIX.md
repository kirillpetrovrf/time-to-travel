# ‚úÖ Telegram –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è - –§–∏–Ω–∞–ª—å–Ω–æ–µ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

## –ü—Ä–æ–±–ª–µ–º–∞

Telegram –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –Ω–µ —Ä–∞–±–æ—Ç–∞–ª–∞ - –≤–µ–±—Ö—É–∫ –ø–æ–ª—É—á–∞–ª —Å–æ–±—ã—Ç–∏—è `/start`, –Ω–æ –Ω–µ —Å–æ–∑–¥–∞–≤–∞–ª —Å–µ—Å—Å–∏—é –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.

## –ö–æ—Ä–Ω–µ–≤–∞—è –ü—Ä–∏—á–∏–Ω–∞

–í `init.dart` –¥–æ–±–∞–≤–∏–ª–∏ timestamp –∫ authCode:
\`\`\`dart
// –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û (—Å–ª–æ–º–∞–Ω–æ):
final authCode = 'AUTH_${cleanPhone}_$timestamp'; // AUTH_79504455444_1769455657000
\`\`\`

–ù–æ –≤ `webhook.dart` —Ç–µ–ª–µ—Ñ–æ–Ω –∏–∑–≤–ª–µ–∫–∞–ª—Å—è –ø—Ä–æ—Å—Ç—ã–º `substring(5)`:
\`\`\`dart
phone = '+${authCode.substring(5)}'; // –ò–∑–≤–ª–µ–∫–∞–µ—Ç "79504455444_1769455657000" –≤–º–µ—Å—Ç–æ "79504455444"
\`\`\`

–≠—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫:
- ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É —Ç–µ–ª–µ—Ñ–æ–Ω—É –≤ –∑–∞–ø—Ä–æ—Å–µ `upsertFromTelegram`
- ‚ùå –°–µ—Å—Å–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–µ —Å–æ–∑–¥–∞–≤–∞–ª–∞—Å—å (authCode –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞–ª —Ç–µ–ª–µ—Ñ–æ–Ω—É)
- ‚ùå Polling –≤–æ–∑–≤—Ä–∞—â–∞–ª 404

## –†–µ—à–µ–Ω–∏–µ

### 1. –£–±—Ä–∞–ª–∏ timestamp –∏–∑ authCode

**–§–∞–π–ª:** `backend/backend/routes/auth/telegram/init.dart`

\`\`\`dart
// –ü–†–ê–í–ò–õ–¨–ù–û (–∫–∞–∫ –≤ —Ä–∞–±–æ—á–µ–º –∫–æ–º–º–∏—Ç–µ be5d6c3):
final authCode = 'AUTH_${cleanPhone.replaceAll('+', '')}'; // AUTH_79504455444
\`\`\`

### 2. –ò—Å–ø—Ä–∞–≤–∏–ª–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤ webhook

**–§–∞–π–ª:** `backend/backend/routes/telegram/webhook.dart`

\`\`\`dart
if (authCode.startsWith('AUTH_')) {
  phone = '+${authCode.substring(5)}'; // –¢–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç: +79504455444
}
\`\`\`

### 3. –ò—Å–ø—Ä–∞–≤–∏–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

**–ü—Ä–æ–±–ª–µ–º–∞:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ `DATABASE_HOST` –≤–º–µ—Å—Ç–æ `DB_HOST`

**–†–µ—à–µ–Ω–∏–µ:** –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏–ª–∏ backend —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏:
\`\`\`bash
docker run -d --name backend \
  -e DB_HOST=timetotravel_postgres \
  -e DB_PORT=5432 \
  -e DB_NAME=timetotravel \
  -e DB_USER=ttadmin \
  -e DB_PASSWORD=ttadmin123 \
  ...
\`\`\`

### 4. –ò—Å–ø—Ä–∞–≤–∏–ª–∏ –ø–∞—Ä–æ–ª—å –ë–î

**–ü—Ä–æ–±–ª–µ–º–∞:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ `SecurePassword123` –≤–º–µ—Å—Ç–æ `ttadmin123`

**–†–µ—à–µ–Ω–∏–µ:** –£–∫–∞–∑–∞–ª–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–∞—Ä–æ–ª—å –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è.

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### ‚úÖ –¢–µ—Å—Ç /init
\`\`\`bash
curl -X POST https://titotr.ru/api/auth/telegram/init \
  -H 'Content-Type: application/json' \
  -d '{"phone":"+79504455444"}'

# –û—Ç–≤–µ—Ç:
{
  "deepLink": "https://t.me/timetotravelauth_bot?start=AUTH_79504455444",
  "authCode": "AUTH_79504455444",
  "phone": "+79504455444"
}
\`\`\`

### ‚úÖ –¢–µ—Å—Ç –≤–µ–±—Ö—É–∫–∞
\`\`\`bash
# –õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç:
üåê [WEBHOOK] –ü–û–õ–£–ß–ï–ù –ó–ê–ü–†–û–° –û–¢ TELEGRAM
üí¨ [WEBHOOK] –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ: /start AUTH_79504455444
üöÄ [WEBHOOK] –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ /start
‚úÖ [UPSERT] –ù–∞–π–¥–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É: +79504455444
üíæ [UPSERT] –û–±–Ω–æ–≤–ª—è–µ–º telegram_id –Ω–∞: 771272324
üíæ [START] –°–µ—Å—Å–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞: authCode=AUTH_79504455444
\`\`\`

## –ò—Ç–æ–≥

- ‚úÖ `/init` —Å–æ–∑–¥–∞—ë—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç deepLink
- ‚úÖ –í–µ–±—Ö—É–∫ –ø–æ–ª—É—á–∞–µ—Ç `/start` —Å authCode
- ‚úÖ –í–µ–±—Ö—É–∫ –∏–∑–≤–ª–µ–∫–∞–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- ‚úÖ –í–µ–±—Ö—É–∫ –æ–±–Ω–æ–≤–ª—è–µ—Ç `telegram_id`
- ‚úÖ –í–µ–±—Ö—É–∫ —Å–æ–∑–¥–∞—ë—Ç —Å–µ—Å—Å–∏—é –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- ‚úÖ Polling –ø–æ–ª—É—á–∞–µ—Ç JWT —Ç–æ–∫–µ–Ω—ã
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω

## –í–∞–∂–Ω—ã–µ –í—ã–≤–æ–¥—ã

1. **authCode –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—Ä–æ—Å—Ç—ã–º**: `AUTH_{phone}` –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
2. **–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `DB_*` –∞ –Ω–µ `DATABASE_*`
3. **–í–µ–±—Ö—É–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç**: –ü—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞ –ù–ï –≤ Telegram API, –∞ –≤ –ª–æ–≥–∏–∫–µ –∫–æ–¥–∞
4. **deepLink —Ä–∞–±–æ—Ç–∞–µ—Ç**: –ü–∞—Ä–∞–º–µ—Ç—Ä `/start` —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —á–∞—Ç–æ–≤

## –î–∞—Ç–∞ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

27 —è–Ω–≤–∞—Ä—è 2026 –≥–æ–¥–∞, 22:30 MSK
