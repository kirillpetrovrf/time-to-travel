# ‚úÖ Telegram Auth - Flutter –ì–û–¢–û–í!

## üéâ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:

### 1. **–°–µ—Ä–≤–∏—Å—ã** ‚úÖ
- `AuthStorageService` - –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ —á–µ—Ä–µ–∑ FlutterSecureStorage
- `TelegramAuthApiService` - API –∫–ª–∏–µ–Ω—Ç –¥–ª—è Telegram –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

### 2. **–ü—Ä–æ–≤–∞–π–¥–µ—Ä** ‚úÖ
- `AuthProvider` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- –ú–µ—Ç–æ–¥—ã: `checkAuthStatus()`, `initTelegramAuth()`, `completeTelegramAuth()`, `logout()`

### 3. **–≠–∫—Ä–∞–Ω—ã** ‚úÖ
- `TelegramLoginScreen` - —ç–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ —Å –ø–æ–ª–µ–º —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏ –∫–Ω–æ–ø–∫–æ–π Telegram
- `AuthSplashScreen` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Å—Å–∏–∏ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ

### 4. **Auto-Login** ‚úÖ
- –ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –Ω–∞–ª–∏—á–∏–µ refresh token
- –ï—Å–ª–∏ –µ—Å—Ç—å - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è access token –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—Ö–æ–¥–∏—Ç
- –ï—Å–ª–∏ –Ω–µ—Ç - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —ç–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞

## üîÑ –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ñ–ª–æ—É:

### –ü–µ—Ä–≤—ã–π –≤—Ö–æ–¥:
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç `AuthSplashScreen` ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤ ‚Üí –Ω–µ—Ç ‚Üí `TelegramLoginScreen`
2. –í–≤–æ–¥–∏—Ç —Ç–µ–ª–µ—Ñ–æ–Ω: `+7 928 123-45-67`
3. –ù–∞–∂–∏–º–∞–µ—Ç "–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Telegram"
4. –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è Telegram –±–æ—Ç
5. –ù–∞–∂–∏–º–∞–µ—Ç START
6. (TODO) –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–ª—É—á–∞–µ—Ç callback –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç–æ–∫–µ–Ω—ã
7. –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ `HomeScreen`

### –ü–æ—Å–ª–µ–¥—É—é—â–∏–µ –∑–∞–ø—É—Å–∫–∏:
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç `AuthSplashScreen`
2. –ü—Ä–æ–≤–µ—Ä–∫–∞ refresh token ‚Üí –µ—Å—Ç—å
3. –ó–∞–ø—Ä–æ—Å `/auth/refresh` ‚Üí –ø–æ–ª—É—á–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ access token
4. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥ ‚Üí `HomeScreen`

## ‚ö†Ô∏è –ß–¢–û –ù–£–ñ–ù–û –î–û–î–ï–õ–ê–¢–¨:

### 1. Backend endpoints (–ö–†–ò–¢–ò–ß–ù–û)
–ù—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –Ω–∞ –±—ç–∫–µ–Ω–¥–µ:
- `POST /auth/refresh` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ access token
- `GET /auth/me` - –ø–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
- `POST /auth/logout` - —É–¥–∞–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏

### 2. Deep Link Listener (–í–ê–ñ–ù–û)
–ü–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª START –≤ Telegram, –Ω—É–∂–Ω–æ:
- –õ–∏–±–æ **polling** - –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã –≤—ã–∑—ã–≤–∞—Ç—å `/auth/telegram/callback` —Å telegramId
- –õ–∏–±–æ **deep link** - –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏ —á—Ç–æ–±—ã –±–æ—Ç –≤–æ–∑–≤—Ä–∞—â–∞–ª –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

### 3. –ü–æ–ª—É—á–µ–Ω–∏–µ Telegram ID
–°–µ–π—á–∞—Å –≤ `completeTelegramAuth(int telegramId)` –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å telegram_id.
–í–∞—Ä–∏–∞–Ω—Ç—ã –∫–∞–∫ –µ–≥–æ –ø–æ–ª—É—á–∏—Ç—å:
- **Deep link**: `timetotravelapp://auth?telegram_id=123456789`
- **Polling**: –°–æ—Ö—Ä–∞–Ω–∏—Ç—å authCode –ª–æ–∫–∞–ª—å–Ω–æ, –æ–ø—Ä–∞—à–∏–≤–∞—Ç—å endpoint –ø–æ–∫–∞ –Ω–µ –ø—Ä–∏–¥—ë—Ç —É—Å–ø–µ—Ö
- **WebSocket**: –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

## üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:

### –í–∞—Ä–∏–∞–Ω—Ç –ê: Polling (–±—ã—Å—Ç—Ä–æ, —Ä–∞–±–æ—Ç–∞–µ—Ç –≤–µ–∑–¥–µ)
1. –ü–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è Telegram —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å `authCode` –≤ –ø–∞–º—è—Ç–∏
2. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–∞–π–º–µ—Ä: –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã –≤—ã–∑—ã–≤–∞—Ç—å `/auth/telegram/callback`
3. –ï—Å–ª–∏ —É—Å–ø–µ—Ö ‚Üí —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–∫–µ–Ω—ã, –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ Home
4. –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ ‚Üí –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å –æ–ø—Ä–æ—Å (–º–∞–∫—Å 60 —Å–µ–∫—É–Ω–¥)

### –í–∞—Ä–∏–∞–Ω—Ç –ë: Deep Links (–ø—Ä–∞–≤–∏–ª—å–Ω–æ, —Å–ª–æ–∂–Ω–µ–µ)
1. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Associated Domains (iOS) –∏ App Links (Android)
2. –ë—ç–∫–µ–Ω–¥ –ø–æ—Å–ª–µ `/start` —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç –Ω–∞ `timetotravelapp://auth?telegram_id=XXX`
3. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–ª—É—á–∞–µ—Ç deep link ‚Üí –≤—ã–∑—ã–≤–∞–µ—Ç `completeTelegramAuth()`

## üß™ –ö–∞–∫ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–µ–π—á–∞—Å:

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
flutter run

# –í—ã —É–≤–∏–¥–∏—Ç–µ:
# 1. Splash screen (1 —Å–µ–∫—É–Ω–¥–∞)
# 2. –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ (–Ω–µ—Ç —Ç–æ–∫–µ–Ω–æ–≤)
# 3. –í–≤–µ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω
# 4. –ù–∞–∂–º–∏—Ç–µ "–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Telegram"
# 5. –û—Ç–∫—Ä–æ–µ—Ç—Å—è Telegram
# 6. –ù–∞–∂–º–∏—Ç–µ START

# TODO: –ü–æ—Å–ª–µ START –Ω—É–∂–Ω–æ –≤—Ä—É—á–Ω—É—é –≤—ã–∑–≤–∞—Ç—å:
# authProvider.completeTelegramAuth(–≤–∞—à_telegram_id)
```

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:

- ‚úÖ –¢–æ–∫–µ–Ω—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ Keychain (iOS) / Keystore (Android)
- ‚úÖ Access token –∂–∏–≤—ë—Ç 1 —á–∞—Å
- ‚úÖ Refresh token –∂–∏–≤—ë—Ç 7 –¥–Ω–µ–π (–∏–ª–∏ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ –µ—Å–ª–∏ expires_at = NULL)
- ‚úÖ –ü—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—É—Å–∫–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
- ‚úÖ –ü—Ä–∏ logout –≤—Å–µ —Ç–æ–∫–µ–Ω—ã —É–¥–∞–ª—è—é—Ç—Å—è

## üì± –ì–æ—Ç–æ–≤–æ –∫ –¥–µ–ø–ª–æ—é?

**–ù–ï–¢** - –Ω—É–∂–Ω–æ –¥–æ–¥–µ–ª–∞—Ç—å:
1. Backend endpoints (refresh, me, logout)
2. –ú–µ—Ö–∞–Ω–∏–∑–º –ø–æ–ª—É—á–µ–Ω–∏—è callback –ø–æ—Å–ª–µ START (polling –∏–ª–∏ deep link)
3. –û–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ —Å–µ—Ç–∏
4. –¢–µ—Å—Ç—ã

**–ù–æ –±–∞–∑–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ì–û–¢–û–í–ê!** ‚úÖ
