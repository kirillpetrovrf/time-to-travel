# üöÄ TELEGRAM –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø - –ò–ù–°–¢–†–£–ö–¶–ò–Ø –ü–û –ú–û–ù–ò–¢–û–†–ò–ù–ì–£

## ‚úÖ –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:

1. **–î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** –≤–æ –≤—Å–µ—Ö –∫–ª—é—á–µ–≤—ã—Ö —Ç–æ—á–∫–∞—Ö:
   - `[INIT]` - –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (–≤–≤–æ–¥ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞)
   - `[WEBHOOK]` - –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –æ—Ç Telegram
   - `[START]` - –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /start
   - `[UPSERT]` - –°–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - `[POLLING]` - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

2. **–°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞**: `monitor_telegram_auth.sh`

3. **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω –ø–∞—Ä—Å–∏–Ω–≥ DATABASE_URL**: –¢–µ–ø–µ—Ä—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —á–∏—Ç–∞–µ—Ç—Å—è –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è

4. **–ë—ç–∫–µ–Ω–¥ —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç** –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ —Å –ø–æ–ª–Ω—ã–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º

## üì° –ö–∞–∫ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ø—Ä–æ—Ü–µ—Å—Å:

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)

```bash
# –í –æ—Ç–¥–µ–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–µ:
./monitor_telegram_auth.sh
```

–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –±—É–¥–µ—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –¢–û–õ–¨–ö–û –≤–∞–∂–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏.

### –í–∞—Ä–∏–∞–Ω—Ç 2: –†—É—á–Ω–æ–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

```bash
# –°–ª–µ–¥–∏—Ç—å –∑–∞ –ª–æ–≥–∞–º–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏:
ssh titotr.ru "docker logs -f timetotravel_backend 2>&1"

# –ò–ª–∏ —Ç–æ–ª—å–∫–æ –≤–∞–∂–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è:
ssh titotr.ru "docker logs -f timetotravel_backend 2>&1" | grep --line-buffered -E '\[INIT\]|\[WEBHOOK\]|\[START\]|\[UPSERT\]|\[POLLING\]'
```

## üîç –ß—Ç–æ –≤—ã —É–≤–∏–¥–∏—Ç–µ –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ:

### 1Ô∏è‚É£ –ö–æ–≥–¥–∞ –≤—ã –≤–≤–µ–¥—ë—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏:

```
üöÄ [INIT] –ü–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å –Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é Telegram –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
üì¶ [INIT] Body –ø–æ–ª—É—á–µ–Ω: {"phone":"+79504455444"}...
üì± [INIT] Phone –∏–∑ –∑–∞–ø—Ä–æ—Å–∞: +79504455444
üßπ [INIT] –û—á–∏—â–µ–Ω–Ω—ã–π phone: +79504455444
üîë [INIT] –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω authCode: AUTH_79504455444
üîç [INIT] –ò—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É: +79504455444
‚úÖ [INIT] –ù–∞–π–¥–µ–Ω —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: id=... telegram_id=null
üîó [INIT] –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω deep link: https://t.me/timetotravelauth_bot?start=AUTH_79504455444
‚úÖ [INIT] –£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç—É
```

### 2Ô∏è‚É£ –ö–æ–≥–¥–∞ –æ—Ç–∫—Ä–æ–µ—Ç—Å—è Telegram:

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–µ—Ä–µ–±—Ä–æ—Å–∏—Ç –≤–∞—Å –≤ –±–æ—Ç. **–í–ê–ñ–ù–û**: –£–¥–∞–ª–∏—Ç–µ —á–∞—Ç —Å –±–æ—Ç–æ–º –ü–ï–†–ï–î —ç—Ç–∏–º!

### 3Ô∏è‚É£ –ö–æ–≥–¥–∞ –≤—ã –Ω–∞–∂–º—ë—Ç–µ START –≤ –±–æ—Ç–µ:

```
üåê [WEBHOOK] ========== –ü–û–õ–£–ß–ï–ù –ó–ê–ü–†–û–° –û–¢ TELEGRAM ==========
üì¶ [WEBHOOK] Body: {"update_id":123,"message":{...}}
üì± [WEBHOOK] Update parsed: update_id, message
üí¨ [WEBHOOK] –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ: /start AUTH_79504455444
üë§ [WEBHOOK] –û—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: chatId=123456789, username=@yourname, firstName=–ö–∏—Ä–∏–ª–ª
üöÄ [WEBHOOK] –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ /start: /start AUTH_79504455444
üéØ [START] ========== –û–ë–†–ê–ë–û–¢–ö–ê –ö–û–ú–ê–ù–î–´ /start ==========
üìù [START] –ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç: /start AUTH_79504455444
üë§ [START] –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: telegramId=123456789, firstName=–ö–∏—Ä–∏–ª–ª, ...
üîç [START] –†–∞–∑–±–æ—Ä –∫–æ–º–∞–Ω–¥—ã: –Ω–∞–π–¥–µ–Ω–æ —á–∞—Å—Ç–µ–π: 2
üîë [START] –û–±–Ω–∞—Ä—É–∂–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä: AUTH_79504455444
üì± [START] –ò–∑–≤–ª–µ—á—ë–Ω —Ç–µ–ª–µ—Ñ–æ–Ω –∏–∑ authCode: +79504455444
üíæ [START] –í—ã–∑—ã–≤–∞–µ–º upsertFromTelegram —Å phone=+79504455444, telegramId=123456789
üîß [UPSERT] ========== –í–´–ó–û–í upsertFromTelegram ==========
üì• [UPSERT] –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
   ‚Ä¢ telegramId: 123456789
   ‚Ä¢ phone: +79504455444
   ‚Ä¢ firstName: –ö–∏—Ä–∏–ª–ª
üîç [UPSERT] –ü–†–ò–û–†–ò–¢–ï–¢ 1: –ò—â–µ–º –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É: +79504455444
‚úÖ [UPSERT] –ù–∞–π–¥–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É!
   ‚Ä¢ id: 3b313f3f-25af-4bf2-a98a-2a24a7ba7ae6
   ‚Ä¢ phone: +79504455444
   ‚Ä¢ telegram_id (—Å—Ç–∞—Ä—ã–π): null
üíæ [UPSERT] –û–±–Ω–æ–≤–ª—è–µ–º telegram_id –Ω–∞: 123456789
‚úÖ [UPSERT] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–±–Ω–æ–≤–ª—ë–Ω:
   ‚Ä¢ id: 3b313f3f-25af-4bf2-a98a-2a24a7ba7ae6
   ‚Ä¢ phone: +79504455444
   ‚Ä¢ telegram_id (–Ω–æ–≤—ã–π): 123456789
‚úÖ [START] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–±—Ä–∞–±–æ—Ç–∞–Ω: id=3b313f3f..., phone=+79504455444, telegram_id=123456789
‚úÖ [WEBHOOK] –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ
```

### 4Ô∏è‚É£ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–∞—à–∏–≤–∞–µ—Ç –±—ç–∫–µ–Ω–¥ –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã:

```
üîÑ [POLLING] ========== –ó–ê–ü–†–û–° –ù–ê –ü–†–û–í–ï–†–ö–£ –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò ==========
üì¶ [POLLING] Body: {"authCode":"AUTH_79504455444"}
üîë [POLLING] –ü–æ–ª—É—á–µ–Ω authCode: AUTH_79504455444
üì± [POLLING] –ò–∑–≤–ª–µ—á—ë–Ω —Ç–µ–ª–µ—Ñ–æ–Ω: +79504455444
üîç [POLLING] –ò—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É: +79504455444
üë§ [POLLING] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω: id=3b313f3f..., telegram_id=123456789
‚úÖ [POLLING] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω! –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–æ–∫–µ–Ω—ã...
```

### 5Ô∏è‚É£ –£—Å–ø–µ—Ö! üéâ

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–ª—É—á–∏—Ç JWT —Ç–æ–∫–µ–Ω—ã –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ–π–¥—ë—Ç.

## ‚ö†Ô∏è –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫:

### –û—à–∏–±–∫–∞ 500 –≤ –ª–æ–≥–∞—Ö:

–ò—â–∏—Ç–µ —Å—Ç—Ä–æ–∫–∏ —Å `‚ùå` - —Ç–∞–º –±—É–¥–µ—Ç –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:

```
‚ùå [INIT] –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: Database connection failed
‚ùå [WEBHOOK] –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: Invalid JSON
‚ùå [UPSERT] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï –Ω–∞–π–¥–µ–Ω –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É
```

### Webhook –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è:

1. **–£–¥–∞–ª–∏—Ç–µ —á–∞—Ç —Å –±–æ—Ç–æ–º** –≤ Telegram (—Ç—Ä–∏ —Ç–æ—á–∫–∏ ‚Üí Delete Chat)
2. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞

### Polling –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç "telegram_id not set":

–û–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ webhook –µ—â—ë –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–ª –∫–æ–º–∞–Ω–¥—É /start. –ü–æ–¥–æ–∂–¥–∏—Ç–µ 2-3 —Å–µ–∫—É–Ω–¥—ã –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ webhook.

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:

1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: `flutter run`
2. –í –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ: `./monitor_telegram_auth.sh`
3. –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä: `+7 950 445 54 44`
4. –ù–∞–±–ª—é–¥–∞–π—Ç–µ –∑–∞ –ª–æ–≥–∞–º–∏
5. –ù–∞–∂–º–∏—Ç–µ START –≤ Telegram
6. –°–º–æ—Ç—Ä–∏—Ç–µ –∫–∞–∫ –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç! ‚ú®
