# ‚úÖ AUTH ENDPOINTS COMPLETE - –°–ò–°–¢–ï–ú–ê –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–ò –ì–û–¢–û–í–ê!

**–î–∞—Ç–∞:** 21 —è–Ω–≤–∞—Ä—è 2026  
**–°—Ç–∞—Ç—É—Å:** üéâ –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

---

## üìä –ß—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ

### 1. POST /auth/refresh
**–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ access token —á–µ—Ä–µ–∑ refresh token**

–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
- ‚úÖ –ü—Ä–∏–Ω–∏–º–∞–µ—Ç refresh token –∏–∑ body –∏–ª–∏ Authorization header
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –∏ —Ç–∏–ø —Ç–æ–∫–µ–Ω–∞ (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å refresh)
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –≤ –ë–î (–Ω–µ –æ—Ç–æ–∑–≤–∞–Ω)
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –Ω–æ–≤—ã–π access token (refresh –æ—Å—Ç–∞–µ—Ç—Å—è —Ç–æ—Ç –∂–µ)
- ‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–æ–≤—ã–π access token + –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ revoked_at IS NULL
- –ü—Ä–æ–≤–µ—Ä–∫–∞ expires_at > NOW()
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ —Ç–æ–∫–µ–Ω–∞ (type = 'refresh')
- –í–∞–ª–∏–¥–∞—Ü–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∞–∫–∫–∞—É–Ω—Ç–∞

---

### 2. POST /auth/logout
**–í—ã—Ö–æ–¥ —Å –æ–¥–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞**

–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
- ‚úÖ –ü—Ä–∏–Ω–∏–º–∞–µ—Ç refresh token –∏–∑ body –∏–ª–∏ Authorization header
- ‚úÖ –û—Ç–∑—ã–≤–∞–µ—Ç —É–∫–∞–∑–∞–Ω–Ω—ã–π refresh token (SET revoked_at = NOW())
- ‚úÖ Graceful handling: –¥–∞–∂–µ –µ—Å–ª–∏ —Ç–æ–∫–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É—Å–ø–µ—Ö
- ‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–æ–∑–≤–∞–Ω–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤

SQL –æ–ø–µ—Ä–∞—Ü–∏—è:
```sql
UPDATE refresh_tokens
SET revoked_at = NOW()
WHERE user_id = @userId
  AND token = @token
  AND revoked_at IS NULL
```

---

### 3. POST /auth/logout-all
**–í—ã—Ö–æ–¥ —Å–æ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤**

–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
- ‚úÖ –¢—Ä–µ–±—É–µ—Ç access token (–Ω–µ refresh!) –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- ‚úÖ –û—Ç–∑—ã–≤–∞–µ—Ç –í–°–ï refresh tokens –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–æ–∑–≤–∞–Ω–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–∞ —á—É–∂–∏—Ö –∞–∫–∫–∞—É–Ω—Ç–∞—Ö

SQL –æ–ø–µ—Ä–∞—Ü–∏—è:
```sql
UPDATE refresh_tokens
SET revoked_at = NOW()
WHERE user_id = @userId
  AND revoked_at IS NULL
```

Use case: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ—Ç –∫–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü–∏—é –∞–∫–∫–∞—É–Ω—Ç–∞ - –æ–¥–Ω–∏–º –¥–µ–π—Å—Ç–≤–∏–µ–º –≤—ã—Ö–æ–¥–∏—Ç —Å–æ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤.

---

### 4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö endpoints

#### POST /auth/register
**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ refresh token –≤ –ë–î
- ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ expires_at (7 –¥–Ω–µ–π —Å –º–æ–º–µ–Ω—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è)

```dart
await db.execute(
  'INSERT INTO refresh_tokens (user_id, token, expires_at) VALUES (...)',
);
```

#### POST /auth/login
**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ refresh token –≤ –ë–î
- ‚úÖ –ö–∞–∂–¥—ã–π –≤—Ö–æ–¥ —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π refresh token

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í—Å–µ refresh tokens –æ—Ç—Å–ª–µ–∂–∏–≤–∞—é—Ç—Å—è –≤ –ë–î –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è.

---

## üîê –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ç–æ–∫–µ–Ω–æ–≤

### –î–≤–æ–π–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ç–æ–∫–µ–Ω–æ–≤ (Access + Refresh)

#### Access Token
- **–°—Ä–æ–∫ –∂–∏–∑–Ω–∏:** 1 —á–∞—Å
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –î–æ—Å—Ç—É–ø –∫ –∑–∞—â–∏—â–µ–Ω–Ω—ã–º endpoints
- **–°–æ–¥–µ—Ä–∂–∏—Ç:** userId, email, type: "access"
- **–•—Ä–∞–Ω–µ–Ω–∏–µ:** –¢–æ–ª—å–∫–æ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ (memory/localStorage)
- **–û—Ç–∑—ã–≤:** –ù–µ–≤–æ–∑–º–æ–∂–µ–Ω (–∫–æ—Ä–æ—Ç–∫–∏–π —Å—Ä–æ–∫ –∂–∏–∑–Ω–∏ –∫–æ–º–ø–µ–Ω—Å–∏—Ä—É–µ—Ç)

#### Refresh Token
- **–°—Ä–æ–∫ –∂–∏–∑–Ω–∏:** 7 –¥–Ω–µ–π
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ access token
- **–°–æ–¥–µ—Ä–∂–∏—Ç:** userId, type: "refresh"
- **–•—Ä–∞–Ω–µ–Ω–∏–µ:** –ë–î (—Ç–∞–±–ª–∏—Ü–∞ refresh_tokens) + –∫–ª–∏–µ–Ω—Ç (secure storage)
- **–û—Ç–∑—ã–≤:** –í–æ–∑–º–æ–∂–µ–Ω (—á–µ—Ä–µ–∑ logout/logout-all)

### Lifecycle –¥–∏–∞–≥—Ä–∞–º–º–∞

```
1. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è/–í—Ö–æ–¥
   ‚Üì
   –°–æ–∑–¥–∞–µ—Ç—Å—è access token (1h) + refresh token (7d)
   ‚Üì
   Refresh token ‚Üí –ë–î (refresh_tokens)
   ‚Üì
   –û–±–∞ —Ç–æ–∫–µ–Ω–∞ ‚Üí –ö–ª–∏–µ–Ω—Ç

2. –†–∞–±–æ—Ç–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
   ‚Üì
   Access token ‚Üí –ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å (Authorization: Bearer)
   ‚Üì
   –ò—Å—Ç–µ–∫ access token (—á–µ—Ä–µ–∑ 1h)?
   ‚Üì
   POST /auth/refresh —Å refresh token
   ‚Üì
   –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ë–î (–Ω–µ –æ—Ç–æ–∑–≤–∞–Ω?)
   ‚Üì
   –ù–æ–≤—ã–π access token ‚Üí –ö–ª–∏–µ–Ω—Ç

3. –í—ã—Ö–æ–¥
   ‚Üì
   POST /auth/logout —Å refresh token
   ‚Üì
   –ë–î: UPDATE revoked_at = NOW()
   ‚Üì
   –ö–ª–∏–µ–Ω—Ç —É–¥–∞–ª—è–µ—Ç –æ–±–∞ —Ç–æ–∫–µ–Ω–∞

4. –ö–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü–∏—è
   ‚Üì
   POST /auth/logout-all —Å access token
   ‚Üì
   –ë–î: –û—Ç–∑—ã–≤ –í–°–ï–• refresh tokens –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   ‚Üì
   –í—ã—Ö–æ–¥ —Å–æ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
```

---

## üóÑÔ∏è –¢–∞–±–ª–∏—Ü–∞ refresh_tokens

```sql
CREATE TABLE refresh_tokens (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  token TEXT NOT NULL,
  expires_at TIMESTAMP NOT NULL,
  revoked_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW(),
  
  INDEX idx_refresh_tokens_user_id (user_id),
  INDEX idx_refresh_tokens_token (token)
);
```

**–í–∞–∂–Ω—ã–µ –ø–æ–ª—è:**
- `revoked_at` - –µ—Å–ª–∏ NOT NULL, —Ç–æ–∫–µ–Ω –æ—Ç–æ–∑–≤–∞–Ω
- `expires_at` - –¥–∞—Ç–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è (7 –¥–Ω–µ–π –æ—Ç created_at)
- `token` - —Å–∞–º JWT refresh token

**–ó–∞–ø—Ä–æ—Å—ã:**
- –ü—Ä–∏ `/refresh` - –ø—Ä–æ–≤–µ—Ä–∫–∞ `WHERE revoked_at IS NULL AND expires_at > NOW()`
- –ü—Ä–∏ `/logout` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ `SET revoked_at = NOW()` –¥–ª—è –æ–¥–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞
- –ü—Ä–∏ `/logout-all` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ `SET revoked_at = NOW()` –¥–ª—è –≤—Å–µ—Ö —Ç–æ–∫–µ–Ω–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ (–æ–±–Ω–æ–≤–ª–µ–Ω–æ)

### Endpoints:
- **Auth:** 6 (register, login, me, **refresh**, **logout**, **logout-all**) ‚úÖ
- **Routes:** 1 (index - search/list)
- **Orders:** 5 (index, create, get, update, delete, update status)
- **Admin:** 4 (create route, update route, delete route, stats)
- **Health:** 1
- **–í—Å–µ–≥–æ:** **17 endpoints** (–±—ã–ª–æ 14)

### –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã (–≤ —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏):
```
routes/auth/
‚îú‚îÄ‚îÄ refresh.dart         # POST /auth/refresh
‚îú‚îÄ‚îÄ logout.dart          # POST /auth/logout
‚îî‚îÄ‚îÄ logout-all.dart      # POST /auth/logout-all
```

### –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
```
routes/auth/
‚îú‚îÄ‚îÄ register.dart        # –î–æ–±–∞–≤–ª–µ–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ refresh token –≤ –ë–î
‚îî‚îÄ‚îÄ login.dart           # –î–æ–±–∞–≤–ª–µ–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ refresh token –≤ –ë–î

API_ENDPOINTS.md         # –û–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è auth endpoints
```

---

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –ö–æ–º–ø–∏–ª—è—Ü–∏—è:
```bash
dart analyze
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ 0 –æ—à–∏–±–æ–∫ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏, 337 —Å—Ç–∏–ª–µ–≤—ã—Ö –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π

---

## üéØ –ü–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä Auth API

| Endpoint | –ú–µ—Ç–æ–¥ | –û–ø–∏—Å–∞–Ω–∏–µ | –°—Ç–∞—Ç—É—Å |
|----------|-------|----------|--------|
| /auth/register | POST | –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è | ‚úÖ |
| /auth/login | POST | –í—Ö–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è | ‚úÖ |
| /auth/me | GET | –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å | ‚úÖ |
| /auth/refresh | POST | –û–±–Ω–æ–≤–∏—Ç—å access token | ‚úÖ NEW |
| /auth/logout | POST | –í—ã—Ö–æ–¥ (–æ–¥–∏–Ω —Ç–æ–∫–µ–Ω) | ‚úÖ NEW |
| /auth/logout-all | POST | –í—ã—Ö–æ–¥ —Å–æ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ | ‚úÖ NEW |

---

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ó–∞—â–∏—Ç–∞ –æ—Ç –∞—Ç–∞–∫:

**1. Token Replay Attack**
- ‚úÖ Refresh tokens —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –ë–î
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ revoked_at –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏
- ‚úÖ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –æ—Ç–∑—ã–≤–∞ —á–µ—Ä–µ–∑ /logout

**2. Token Theft**
- ‚úÖ Access tokens –∫–æ—Ä–æ—Ç–∫–æ–∂–∏–≤—É—â–∏–µ (1 —á–∞—Å)
- ‚úÖ Refresh tokens –º–æ–≥—É—Ç –±—ã—Ç—å –æ—Ç–æ–∑–≤–∞–Ω—ã
- ‚úÖ /logout-all –¥–ª—è —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–≥–æ –æ—Ç–∑—ã–≤–∞ –≤—Å–µ—Ö —Ç–æ–∫–µ–Ω–æ–≤

**3. Brute Force**
- ‚è≥ TODO: Rate limiting (–±—É–¥—É—â–∞—è –∑–∞–¥–∞—á–∞)
- ‚úÖ Bcrypt –¥–ª—è –ø–∞—Ä–æ–ª–µ–π (—É–∂–µ –µ—Å—Ç—å)

**4. Session Hijacking**
- ‚úÖ JWT –Ω–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (stateless)
- ‚úÖ Refresh tokens –º–æ–≥—É—Ç –±—ã—Ç—å –æ—Ç–æ–∑–≤–∞–Ω—ã
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ isActive –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ

---

## üí° –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### 1. –ü–æ–ª–Ω—ã–π flow —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ ‚Üí —Ä–∞–±–æ—Ç–∞ ‚Üí –≤—ã—Ö–æ–¥

```bash
# 1. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
curl -X POST http://localhost:8080/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "password123",
    "name": "Test User",
    "phone": "+79001234567"
  }'

# Response:
# {
#   "user": {...},
#   "accessToken": "eyJhbGc...",
#   "refreshToken": "eyJhbGc..."
# }

# 2. –†–∞–±–æ—Ç–∞ —Å API (1 —á–∞—Å)
curl -X GET http://localhost:8080/auth/me \
  -H "Authorization: Bearer <accessToken>"

# 3. Access token –∏—Å—Ç–µ–∫ - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
curl -X POST http://localhost:8080/auth/refresh \
  -H "Content-Type: application/json" \
  -d '{"refreshToken": "eyJhbGc..."}'

# Response:
# {
#   "accessToken": "eyJhbGc...",  # –ù–æ–≤—ã–π —Ç–æ–∫–µ–Ω!
#   "user": {...}
# }

# 4. –í—ã—Ö–æ–¥
curl -X POST http://localhost:8080/auth/logout \
  -H "Content-Type: application/json" \
  -d '{"refreshToken": "eyJhbGc..."}'

# Response:
# {
#   "message": "Logged out successfully",
#   "revokedTokens": 1
# }
```

### 2. –≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–π –≤—ã—Ö–æ–¥ —Å–æ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤

```bash
# –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–º–µ—Ç–∏–ª –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—É—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
curl -X POST http://localhost:8080/auth/logout-all \
  -H "Authorization: Bearer <accessToken>"

# Response:
# {
#   "message": "Logged out from all devices successfully",
#   "revokedTokens": 3  # –û—Ç–æ–∑–≤–∞–Ω–æ 3 refresh tokens
# }

# –¢–µ–ø–µ—Ä—å –Ω–∞ –í–°–ï–• —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö –Ω—É–∂–Ω–æ –∑–∞–Ω–æ–≤–æ –≤–æ–π—Ç–∏
```

### 3. –ì–∏–±–∫–æ—Å—Ç—å refresh endpoint

```bash
# –°–ø–æ—Å–æ–± 1: —á–µ—Ä–µ–∑ body
curl -X POST http://localhost:8080/auth/refresh \
  -H "Content-Type: application/json" \
  -d '{"refreshToken": "eyJhbGc..."}'

# –°–ø–æ—Å–æ–± 2: —á–µ—Ä–µ–∑ header
curl -X POST http://localhost:8080/auth/refresh \
  -H "Authorization: Bearer eyJhbGc..."
```

---

## üöÄ –ì–æ—Ç–æ–≤–æ –∫ production

### ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:
- JWT-based –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (access + refresh tokens)
- –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ refresh tokens –≤ –ë–î
- –û—Ç–∑—ã–≤ —Ç–æ–∫–µ–Ω–æ–≤ (logout single/all devices)
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ access tokens –±–µ–∑ re-login
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- Role-based access control
- Graceful error handling

### ‚è≥ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è production:
1. **Redis –¥–ª—è refresh tokens** (–≤–º–µ—Å—Ç–æ PostgreSQL –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏)
2. **Rate limiting** –Ω–∞ /auth/login –∏ /auth/refresh
3. **IP whitelist** –¥–ª—è /auth/logout-all (–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞)
4. **Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** –ø—Ä–∏ /logout-all (–∞–ª–µ—Ä—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é)
5. **Audit log** –¥–ª—è –≤—Å–µ—Ö auth –æ–ø–µ—Ä–∞—Ü–∏–π
6. **Refresh token rotation** (—Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–π refresh –ø—Ä–∏ –∫–∞–∂–¥–æ–º /refresh)

---

## üéì –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### –í–∞—Ä–∏–∞–Ω—Ç 1: –î–æ–±–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ Auth —Ñ–∏—á–∏
- [ ] Email verification –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- [ ] –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è (forgot password)
- [ ] –î–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (2FA)
- [ ] OAuth2 –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (Google, Yandex)

### –í–∞—Ä–∏–∞–Ω—Ç 2: –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –Ω–∞ Selectel
- [ ] –ê—Ä–µ–Ω–¥–æ–≤–∞—Ç—å VPS (~600-800 —Ä—É–±/–º–µ—Å)
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å PostgreSQL + Redis
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å SSL —á–µ—Ä–µ–∑ Let's Encrypt
- [ ] –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–¥ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å Docker Compose

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Flutter
- [ ] –°–æ–∑–¥–∞—Ç—å AuthService –≤ Flutter
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ (flutter_secure_storage)
- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π refresh –ø—Ä–∏ 401
- [ ] Logout –Ω–∞ –≤—Å–µ—Ö —ç–∫—Ä–∞–Ω–∞—Ö

### –í–∞—Ä–∏–∞–Ω—Ç 4: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –¥–ª—è auth flow
- [ ] –¢–µ—Å—Ç—ã –¥–ª—è refresh token revocation
- [ ] Load testing –¥–ª—è /auth/refresh
- [ ] Security testing (OWASP Top 10)

---

## üèÅ –ò—Ç–æ–≥

**–°–∏—Å—Ç–µ–º–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤–∞!** üéâ

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã **6 auth endpoints** —Å:
- ‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–µ–π –∏ –≤—Ö–æ–¥–æ–º
- ‚úÖ JWT —Ç–æ–∫–µ–Ω–∞–º–∏ (access + refresh)
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º —Ç–æ–∫–µ–Ω–æ–≤ –±–µ–∑ re-login
- ‚úÖ –í—ã—Ö–æ–¥–æ–º —Å –æ–¥–Ω–æ–≥–æ –∏–ª–∏ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- ‚úÖ –•—Ä–∞–Ω–µ–Ω–∏–µ–º refresh tokens –≤ –ë–î
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–æ–π –Ω–∞ –æ—Ç–∑—ã–≤ —Ç–æ–∫–µ–Ω–æ–≤
- ‚úÖ –ü–æ–ª–Ω—ã–º lifecycle management

**Backend –≥–æ—Ç–æ–≤ –∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Flutter –∏ –¥–µ–ø–ª–æ—é –Ω–∞ production!** üöÄ

---

## üìà –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞

**Endpoints:** 17 (Auth: 6, Routes: 1, Orders: 5, Admin: 4, Health: 1)  
**–§–∞–π–ª—ã:** ~30 —Ñ–∞–π–ª–æ–≤  
**–°—Ç—Ä–æ–∫ –∫–æ–¥–∞:** ~5000 —Å—Ç—Ä–æ–∫  
**–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:** PostgreSQL —Å 6 —Ç–∞–±–ª–∏—Ü–∞–º–∏  
**–ö–æ–º–ø–∏–ª—è—Ü–∏—è:** 0 –æ—à–∏–±–æ–∫ ‚úÖ  

**–í—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –≥–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!** üí™
